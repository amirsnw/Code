/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, EventEmitter, forwardRef, Input, Output, ViewChild } from '@angular/core';
import { TaminDataGridComponent } from '../../tamin-data-grid/tamin-data-grid.component';
import { TaminDataGridConfiguration } from '../../../helpers/tamin.data.grid.configuration/tamin.data.grid.configuration';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { FieldBaseComponent } from '../../../base/field-base.component';
import { fromEvent, Subject } from 'rxjs';
import { debounceTime, distinctUntilChanged, switchMap } from 'rxjs/operators';
import { PickerContainerComponent } from '../../containers/picker-container/picker-container.component';
import { SearchOperator } from '../../../models/search-param.model';
var TaminFieldAutoCompleteDataGridComponent = /** @class */ (function (_super) {
    tslib_1.__extends(TaminFieldAutoCompleteDataGridComponent, _super);
    function TaminFieldAutoCompleteDataGridComponent() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.maxSearchTermLength = 1;
        _this.searchOperator = 'LIKE';
        _this.searchPattern = '*{term}*';
        _this.searchOperatorType = SearchOperator.EQUAL;
        _this.beforeLoad = new EventEmitter();
        _this.searchTerm = new Subject();
        _this.filter = [];
        _this.currentValue = '';
        return _this;
    }
    /**
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.initializeComponent = /**
     * @return {?}
     */
    function () {
        var _this = this;
        setTimeout((/**
         * @return {?}
         */
        function () {
            _this.picker.parent = _this.inputElement;
            _this.search(_this.searchTerm).subscribe();
            _this.theGrid.configuration = _this.dataGridConfiguration;
            _this.control = _this.controlContainer.control.get(_this.formControlName);
            if (_this.casecadeControlName) {
                _this.parent = _this.controlContainer.control.get(_this.casecadeControlName);
                _this.subscription.add(_this.parent.valueChanges.subscribe((/**
                 * @param {?} value
                 * @return {?}
                 */
                function (value) {
                    if (value && value !== '') {
                        _this.parentValue = value;
                    }
                })));
            }
        }), 0);
    };
    /**
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.initValueAccessor = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var keyups = fromEvent(this.inputElement.nativeElement, 'keyup');
        this.subscription.add(keyups.subscribe((/**
         * @param {?} evt
         * @return {?}
         */
        function (evt) {
            if (evt.target.value.length >= _this.maxSearchTermLength) {
                _this.searchTerm.next(evt.target.value);
            }
        })));
        /** @type {?} */
        var focuses = fromEvent(this.inputElement.nativeElement, 'focus');
        this.subscription.add(focuses.subscribe((/**
         * @param {?} evt
         * @return {?}
         */
        function (evt) {
            _this.onTouched();
        })));
    };
    /**
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.hidePopup = /**
     * @return {?}
     */
    function () {
        this.picker.hide();
    };
    /**
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.showPopup = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.picker.show();
        if (this.parentValue && this.parentValue !== '') {
            /** @type {?} */
            var tmp_1 = this.theGrid.searchParams.find((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.property === _this.parentValue; }));
            if (tmp_1) {
                this.theGrid.searchParams = this.theGrid.searchParams.filter((/**
                 * @param {?} obj
                 * @return {?}
                 */
                function (obj) { return obj !== tmp_1; }));
            }
            this.theGrid.searchParams.push({
                property: this.casecadeControlFieldName,
                value: this.parentValue,
                operator: this.searchOperatorType
            });
        }
        this.theGrid.refreshData();
    };
    /**
     * @param {?} terms
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.search = /**
     * @param {?} terms
     * @return {?}
     */
    function (terms) {
        var _this = this;
        return terms.pipe(debounceTime(400), distinctUntilChanged(), switchMap((/**
         * @param {?} term
         * @return {?}
         */
        function (term) { return _this.searchEntries(term); })));
    };
    /**
     * @param {?} term
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.searchEntries = /**
     * @param {?} term
     * @return {?}
     */
    function (term) {
        this.currentValue = '';
        if (term === '') {
            this.hidePopup();
        }
        else {
            this.theGrid.searchParams = [];
            /** @type {?} */
            var searchTerm = this.searchPattern.replace('{term}', term);
            this.theGrid.searchParams = [{ property: this.displayField, value: searchTerm, operator: this.searchOperator }];
            this.theGrid.searchParams = this.theGrid.searchParams.concat(this.filter);
            if (this.parentValue && this.parentValue !== '') {
                this.theGrid.searchParams.push({
                    property: this.casecadeControlFieldName,
                    value: this.parentValue,
                    operator: this.searchOperatorType
                });
            }
            this.beforeLoad.emit();
            // this.theGrid.refreshData();
            this.showPopup();
        }
        this.onChange('');
        return term === '' ? [] : term;
    };
    /**
     * @param {?} val
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.onItemSelected = /**
     * @param {?} val
     * @return {?}
     */
    function (val) {
        if (!val) {
            this.onChange('');
            this.hidePopup();
            return;
        }
        /** @type {?} */
        var displayField = this.deepFind(val, this.displayField);
        /** @type {?} */
        var valueField = this.deepFind(val, this.valueField);
        if (!displayField || !valueField) {
            this.inputElement.nativeElement.value = '';
            this.currentValue = '';
            this.onChange('');
            return;
        }
        this.inputElement.nativeElement.value = displayField;
        this.currentValue = valueField;
        this.onChange(valueField);
        this.hidePopup();
    };
    /**
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.afterRefreshData = /**
     * @return {?}
     */
    function () {
        this.picker.update();
    };
    /**
     * @param {?} value
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.writeValue = /**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        var _this = this;
        /** @type {?} */
        var theValue = value == null ? '' : value;
        if (theValue !== '') {
            this.loadData(theValue);
        }
        else {
            this.currentValue = '';
            setTimeout((/**
             * @return {?}
             */
            function () {
                _this.inputElement.nativeElement.value = '';
            }), 0);
        }
    };
    /**
     * @private
     * @param {?} theValue
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.loadData = /**
     * @private
     * @param {?} theValue
     * @return {?}
     */
    function (theValue) {
        var _this = this;
        /** @type {?} */
        var theUrl = this.dataGridConfiguration.serviceUrl;
        /** @type {?} */
        var id = this.dataGridConfiguration.id;
        /** @type {?} */
        var searchParam = [
            {
                property: id,
                value: theValue,
                operator: this.searchOperatorType
            }
        ];
        if (this.parentValue && this.parentValue !== '') {
            searchParam.push({
                property: this.casecadeControlFieldName,
                value: this.parentValue,
                operator: this.searchOperatorType
            });
        }
        this.startWaiting();
        this.restService.getPage(theUrl, 0, 10000, searchParam)
            .then((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            _this.stopWaiting();
            if (value.data.list.length === 0) {
                _this.onChange('');
            }
            _this.onItemSelected(value.data.list[0]);
            _this.theGrid.dataItems = [];
            _this.theGrid.dataItems.push(value.data.list[0]);
        }))
            .catch((/**
         * @param {?} reason
         * @return {?}
         */
        function (reason) {
            _this.stopWaiting();
            _this.onChange('');
        }));
    };
    /**
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.pickerBeforeHide = /**
     * @return {?}
     */
    function () {
        if (this.currentValue === '') {
            this.inputElement.nativeElement.value = '';
        }
    };
    /**
     * @return {?}
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.pickerBeforeShow = /**
     * @return {?}
     */
    function () {
    };
    TaminFieldAutoCompleteDataGridComponent.decorators = [
        { type: Component, args: [{
                    selector: 'tamin-field-auto-complete-data-grid',
                    template: "<input\n  type=\"text\"\n  class=\"tamin-form-control-input\"\n  [disabled]=\"control.disabled\"\n  [attr.placeholder]=\"placeHolder\"\n  [class.tamin-form-control-valid]=\"control.touched && control.valid\"\n  [class.tamin-form-control-invalid]=\"control.touched && !control.valid\"\n  #inputElement>\n<tamin-picker-container #picker (berforeHide)=\"pickerBeforeHide()\" (berforeShow)=\"pickerBeforeShow()\">\n  <tamin-data-grid #theGrid (itemSelect)=\"onItemSelected($event)\" (afterRefreshData)=\"afterRefreshData()\"\n                   [allowBreakPoints]=\"false\" [showHover]=\"true\">\n  </tamin-data-grid>\n</tamin-picker-container>\n",
                    providers: [
                        {
                            provide: NG_VALUE_ACCESSOR,
                            useExisting: forwardRef((/**
                             * @return {?}
                             */
                            function () { return TaminFieldAutoCompleteDataGridComponent; })),
                            multi: true
                        }
                    ],
                    styles: [""]
                }] }
    ];
    TaminFieldAutoCompleteDataGridComponent.propDecorators = {
        dataGridConfiguration: [{ type: Input }],
        casecadeControlName: [{ type: Input }],
        casecadeControlFieldName: [{ type: Input }],
        displayField: [{ type: Input }],
        valueField: [{ type: Input }],
        maxSearchTermLength: [{ type: Input }],
        searchOperator: [{ type: Input }],
        searchPattern: [{ type: Input }],
        searchOperatorType: [{ type: Input }],
        beforeLoad: [{ type: Output }],
        theGrid: [{ type: ViewChild, args: ['theGrid',] }],
        picker: [{ type: ViewChild, args: ['picker',] }]
    };
    return TaminFieldAutoCompleteDataGridComponent;
}(FieldBaseComponent));
export { TaminFieldAutoCompleteDataGridComponent };
if (false) {
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.dataGridConfiguration;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.casecadeControlName;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.casecadeControlFieldName;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.displayField;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.valueField;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.maxSearchTermLength;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.searchOperator;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.searchPattern;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.searchOperatorType;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.beforeLoad;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.theGrid;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.picker;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.searchTerm;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.filter;
    /**
     * @type {?}
     * @private
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.selectedValue;
    /**
     * @type {?}
     * @private
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.currentValue;
    /**
     * @type {?}
     * @private
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.parent;
    /**
     * @type {?}
     * @private
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.parentValue;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFtaW4tZmllbGQtYXV0by1jb21wbGV0ZS1kYXRhLWdyaWQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vdGFtaW4tZnJhbWV3b3JrLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvZmllbGRzL3RhbWluLWZpZWxkLWF1dG8tY29tcGxldGUtZGF0YS1ncmlkL3RhbWluLWZpZWxkLWF1dG8tY29tcGxldGUtZGF0YS1ncmlkLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUM1RixPQUFPLEVBQUMsc0JBQXNCLEVBQUMsTUFBTSxpREFBaUQsQ0FBQztBQUN2RixPQUFPLEVBQUMsMEJBQTBCLEVBQUMsTUFBTSw4RUFBOEUsQ0FBQztBQUN4SCxPQUFPLEVBQWtCLGlCQUFpQixFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEUsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sb0NBQW9DLENBQUM7QUFDdEUsT0FBTyxFQUFDLFNBQVMsRUFBYyxPQUFPLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDcEQsT0FBTyxFQUFDLFlBQVksRUFBRSxvQkFBb0IsRUFBRSxTQUFTLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3RSxPQUFPLEVBQUMsd0JBQXdCLEVBQUMsTUFBTSw4REFBOEQsQ0FBQztBQUN0RyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sb0NBQW9DLENBQUM7QUFFbEU7SUFhNkQsbUVBQWtCO0lBYi9FO1FBQUEscUVBb01DO1FBakxVLHlCQUFtQixHQUFHLENBQUMsQ0FBQztRQUN4QixvQkFBYyxHQUFHLE1BQU0sQ0FBQztRQUN4QixtQkFBYSxHQUFHLFVBQVUsQ0FBQztRQUMzQix3QkFBa0IsR0FBbUIsY0FBYyxDQUFDLEtBQUssQ0FBQztRQUN6RCxnQkFB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dmVudEVtaXR0ZXIsIGZvcndhcmRSZWYsIElucHV0LCBPdXRwdXQsIFZpZXdDaGlsZH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1RhbWluRGF0YUdyaWRDb21wb25lbnR9IGZyb20gJy4uLy4uL3RhbWluLWRhdGEtZ3JpZC90YW1pbi1kYXRhLWdyaWQuY29tcG9uZW50JztcbmltcG9ydCB7VGFtaW5EYXRhR3JpZENvbmZpZ3VyYXRpb259IGZyb20gJy4uLy4uLy4uL2hlbHBlcnMvdGFtaW4uZGF0YS5ncmlkLmNvbmZpZ3VyYXRpb24vdGFtaW4uZGF0YS5ncmlkLmNvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IHtBYnN0cmFjdENvbnRyb2wsIE5HX1ZBTFVFX0FDQ0VTU09SfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQge0ZpZWxkQmFzZUNvbXBvbmVudH0gZnJvbSAnLi4vLi4vLi4vYmFzZS9maWVsZC1iYXNlLmNvbXBvbmVudCc7XG5pbXBvcnQge2Zyb21FdmVudCwgT2JzZXJ2YWJsZSwgU3ViamVjdH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2RlYm91bmNlVGltZSwgZGlzdGluY3RVbnRpbENoYW5nZWQsIHN3aXRjaE1hcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtQaWNrZXJDb250YWluZXJDb21wb25lbnR9IGZyb20gJy4uLy4uL2NvbnRhaW5lcnMvcGlja2VyLWNvbnRhaW5lci9waWNrZXItY29udGFpbmVyLmNvbXBvbmVudCc7XG5pbXBvcnQge1NlYXJjaE9wZXJhdG9yfSBmcm9tICcuLi8uLi8uLi9tb2RlbHMvc2VhcmNoLXBhcmFtLm1vZGVsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAndGFtaW4tZmllbGQtYXV0by1jb21wbGV0ZS1kYXRhLWdyaWQnLFxuICB0ZW1wbGF0ZVVybDogJy4vdGFtaW4tZmllbGQtYXV0by1jb21wbGV0ZS1kYXRhLWdyaWQuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi90YW1pbi1maWVsZC1hdXRvLWNvbXBsZXRlLWRhdGEtZ3JpZC5jb21wb25lbnQuc2NzcyddLFxuICBwcm92aWRlcnM6IFtcbiAgICB7XG4gICAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IFRhbWluRmllbGRBdXRvQ29tcGxldGVEYXRhR3JpZENvbXBvbmVudCksXG4gICAgICBtdWx0aTogdHJ1ZVxuICAgIH1cbiAgXVxufSlcblxuZXhwb3J0IGNsYXNzIFRhbWluRmllbGRBdXRvQ29tcGxldGVEYXRhR3JpZENvbXBvbmVudCBleHRlbmRzIEZpZWxkQmFzZUNvbXBvbmVudCB7XG4gIEBJbnB1dCgpIGRhdGFHcmlkQ29uZmlndXJhdGlvbjogVGFtaW5EYXRhR3JpZENvbmZpZ3VyYXRpb247XG4gIEBJbnB1dCgpIGNhc2VjYWRlQ29udHJvbE5hbWU6IHN0cmluZztcbiAgQElucHV0KCkgY2FzZWNhZGVDb250cm9sRmllbGROYW1lOiBzdHJpbmc7XG4gIEBJbnB1dCgpIGRpc3BsYXlGaWVsZDogc3RyaW5nO1xuICBASW5wdXQoKSB2YWx1ZUZpZWxkOiBzdHJpbmc7XG4gIEBJbnB1dCgpIG1heFNlYXJjaFRlcm1MZW5ndGggPSAxO1xuICBASW5wdXQoKSBzZWFyY2hPcGVyYXRvciA9ICdMSUtFJztcbiAgQElucHV0KCkgc2VhcmNoUGF0dGVybiA9ICcqe3Rlcm19Kic7XG4gIEBJbnB1dCgpIHNlYXJjaE9wZXJhdG9yVHlwZTogU2VhcmNoT3BlcmF0b3IgPSBTZWFyY2hPcGVyYXRvci5FUVVBTDtcbiAgQE91dHB1dCgpIGJlZm9yZUxvYWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBWaWV3Q2hpbGQoJ3RoZUdyaWQnKSB0aGVHcmlkOiBUYW1pbkRhdGFHcmlkQ29tcG9uZW50O1xuICBAVmlld0NoaWxkKCdwaWNrZXInKSBwaWNrZXI6IFBpY2tlckNvbnRhaW5lckNvbXBvbmVudDtcbiAgc2VhcmNoVGVybSA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKTtcbiAgZmlsdGVyID0gW107XG4gIHByaXZhdGUgc2VsZWN0ZWRWYWx1ZTogc3RyaW5nO1xuICBwcml2YXRlIGN1cnJlbnRWYWx1ZSA9ICcnO1xuICBwcml2YXRlIHBhcmVudDogQWJzdHJhY3RDb250cm9sO1xuICBwcml2YXRlIHBhcmVudFZhbHVlOiBzdHJpbmc7XG5cbiAgaW5pdGlhbGl6ZUNvbXBvbmVudCgpIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMucGlja2VyLnBhcmVudCA9IHRoaXMuaW5wdXRFbGVtZW50O1xuICAgICAgdGhpcy5zZWFyY2godGhpcy5zZWFyY2hUZXJtKS5zdWJzY3JpYmUoKTtcbiAgICAgIHRoaXMudGhlR3JpZC5jb25maWd1cmF0aW9uID0gdGhpcy5kYXRhR3JpZENvbmZpZ3VyYXRpb247XG4gICAgICB0aGlzLmNvbnRyb2wgPSB0aGlzLmNvbnRyb2xDb250YWluZXIuY29udHJvbC5nZXQodGhpcy5mb3JtQ29udHJvbE5hbWUpO1xuICAgICAgaWYgKHRoaXMuY2FzZWNhZGVDb250cm9sTmFtZSkge1xuICAgICAgICB0aGlzLnBhcmVudCA9IHRoaXMuY29udHJvbENvbnRhaW5lci5jb250cm9sLmdldCh0aGlzLmNhc2VjYWRlQ29udHJvbE5hbWUpO1xuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQodGhpcy5wYXJlbnQudmFsdWVDaGFuZ2VzLnN1YnNjcmliZSh2YWx1ZSA9PiB7XG4gICAgICAgICAgaWYgKHZhbHVlICYmIHZhbHVlICE9PSAnJykge1xuICAgICAgICAgICAgdGhpcy5wYXJlbnRWYWx1ZSA9IHZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSkpO1xuICAgICAgfVxuICAgIH0sIDApO1xuICB9XG5cbiAgaW5pdFZhbHVlQWNjZXNzb3IoKSB7XG4gICAgY29uc3Qga2V5dXBzID0gZnJvbUV2ZW50KHRoaXMuaW5wdXRFbGVtZW50Lm5hdGl2ZUVsZW1lbnQsICdrZXl1cCcpO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChrZXl1cHMuc3Vic2NyaWJlKChldnQ6IGFueSkgPT4ge1xuICAgICAgaWYgKGV2dC50YXJnZXQudmFsdWUubGVuZ3RoID49IHRoaXMubWF4U2VhcmNoVGVybUxlbmd0aCkge1xuICAgICAgICB0aGlzLnNlYXJjaFRlcm0ubmV4dChldnQudGFyZ2V0LnZhbHVlKTtcbiAgICAgIH1cbiAgICB9KSk7XG5cbiAgICBjb25zdCBmb2N1c2VzID0gZnJvbUV2ZW50KHRoaXMuaW5wdXRFbGVtZW50Lm5hdGl2ZUVsZW1lbnQsICdmb2N1cycpO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChmb2N1c2VzLnN1YnNjcmliZSgoZXZ0OiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5vblRvdWNoZWQoKTtcbiAgICAgIH1cbiAgICApKTtcbiAgfVxuXG4gIGhpZGVQb3B1cCgpIHtcbiAgICB0aGlzLnBpY2tlci5oaWRlKCk7XG4gIH1cblxuICBzaG93UG9wdXAoKSB7XG4gICAgdGhpcy5waWNrZXIuc2hvdygpO1xuICAgIGlmICh0aGlzLnBhcmVudFZhbHVlICYmIHRoaXMucGFyZW50VmFsdWUgIT09ICcnKSB7XG4gICAgICBjb25zdCB0bXAgPSB0aGlzLnRoZUdyaWQuc2VhcmNoUGFyYW1zLmZpbmQoYyA9PiBjLnByb3BlcnR5ID09PSB0aGlzLnBhcmVudFZhbHVlKTtcbiAgICAgIGlmICh0bXApIHtcbiAgICAgICAgdGhpcy50aGVHcmlkLnNlYXJjaFBhcmFtcyA9IHRoaXMudGhlR3JpZC5zZWFyY2hQYXJhbXMuZmlsdGVyKG9iaiA9PiBvYmogIT09IHRtcCk7XG4gICAgICB9XG4gICAgICB0aGlzLnRoZUdyaWQuc2VhcmNoUGFyYW1zLnB1c2goe1xuICAgICAgICBwcm9wZXJ0eTogdGhpcy5jYXNlY2FkZUNvbnRyb2xGaWVsZE5hbWUsXG4gICAgICAgIHZhbHVlOiB0aGlzLnBhcmVudFZhbHVlLFxuICAgICAgICBvcGVyYXRvcjogdGhpcy5zZWFyY2hPcGVyYXRvclR5cGVcbiAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLnRoZUdyaWQucmVmcmVzaERhdGEoKTtcbiAgfVxuXG4gIHNlYXJjaCh0ZXJtczogT2JzZXJ2YWJsZTxzdHJpbmc+KSB7XG4gICAgcmV0dXJuIHRlcm1zLnBpcGUoXG4gICAgICBkZWJvdW5jZVRpbWUoNDAwKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICBzd2l0Y2hNYXAodGVybSA9PiB0aGlzLnNlYXJjaEVudHJpZXModGVybSkpKTtcbiAgfVxuXG4gIHNlYXJjaEVudHJpZXModGVybTogc3RyaW5nKSB7XG4gICAgdGhpcy5jdXJyZW50VmFsdWUgPSAnJztcbiAgICBpZiAodGVybSA9PT0gJycpIHtcbiAgICAgIHRoaXMuaGlkZVBvcHVwKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudGhlR3JpZC5zZWFyY2hQYXJhbXMgPSBbXTtcbiAgICAgIGNvbnN0IHNlYXJjaFRlcm0gPSB0aGlzLnNlYXJjaFBhdHRlcm4ucmVwbGFjZSgne3Rlcm19JywgdGVybSk7XG4gICAgICB0aGlzLnRoZUdyaWQuc2VhcmNoUGFyYW1zID0gW3twcm9wZXJ0eTogdGhpcy5kaXNwbGF5RmllbGQsIHZhbHVlOiBzZWFyY2hUZXJtLCBvcGVyYXRvcjogdGhpcy5zZWFyY2hPcGVyYXRvcn1dO1xuICAgICAgdGhpcy50aGVHcmlkLnNlYXJjaFBhcmFtcyA9IHRoaXMudGhlR3JpZC5zZWFyY2hQYXJhbXMuY29uY2F0KHRoaXMuZmlsdGVyKTtcbiAgICAgIGlmICh0aGlzLnBhcmVudFZhbHVlICYmIHRoaXMucGFyZW50VmFsdWUgIT09ICcnKSB7XG4gICAgICAgIHRoaXMudGhlR3JpZC5zZWFyY2hQYXJhbXMucHVzaCh7XG4gICAgICAgICAgcHJvcGVydHk6IHRoaXMuY2FzZWNhZGVDb250cm9sRmllbGROYW1lLFxuICAgICAgICAgIHZhbHVlOiB0aGlzLnBhcmVudFZhbHVlLFxuICAgICAgICAgIG9wZXJhdG9yOiB0aGlzLnNlYXJjaE9wZXJhdG9yVHlwZVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYmVmb3JlTG9hZC5lbWl0KCk7XG4gICAgICAvLyB0aGlzLnRoZUdyaWQucmVmcmVzaERhdGEoKTtcbiAgICAgIHRoaXMuc2hvd1BvcHVwKCk7XG4gICAgfVxuICAgIHRoaXMub25DaGFuZ2UoJycpO1xuICAgIHJldHVybiB0ZXJtID09PSAnJyA/IFtdIDogdGVybTtcbiAgfVxuXG4gIG9uSXRlbVNlbGVjdGVkKHZhbDogYW55KSB7XG4gICAgaWYgKCF2YWwpIHtcbiAgICAgIHRoaXMub25DaGFuZ2UoJycpO1xuICAgICAgdGhpcy5oaWRlUG9wdXAoKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZGlzcGxheUZpZWxkID0gdGhpcy5kZWVwRmluZCh2YWwsIHRoaXMuZGlzcGxheUZpZWxkKTtcbiAgICBjb25zdCB2YWx1ZUZpZWxkID0gdGhpcy5kZWVwRmluZCh2YWwsIHRoaXMudmFsdWVGaWVsZCk7XG4gICAgaWYgKCFkaXNwbGF5RmllbGQgfHwgIXZhbHVlRmllbGQpIHtcbiAgICAgIHRoaXMuaW5wdXRFbGVtZW50Lm5hdGl2ZUVsZW1lbnQudmFsdWUgPSAnJztcbiAgICAgIHRoaXMuY3VycmVudFZhbHVlID0gJyc7XG4gICAgICB0aGlzLm9uQ2hhbmdlKCcnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5pbnB1dEVsZW1lbnQubmF0aXZlRWxlbWVudC52YWx1ZSA9IGRpc3BsYXlGaWVsZDtcbiAgICB0aGlzLmN1cnJlbnRWYWx1ZSA9IHZhbHVlRmllbGQ7XG4gICAgdGhpcy5vbkNoYW5nZSh2YWx1ZUZpZWxkKTtcbiAgICB0aGlzLmhpZGVQb3B1cCgpO1xuICB9XG5cbiAgYWZ0ZXJSZWZyZXNoRGF0YSgpIHtcbiAgICB0aGlzLnBpY2tlci51cGRhdGUoKTtcbiAgfVxuXG4gIHdyaXRlVmFsdWUodmFsdWU6IGFueSk6IHZvaWQge1xuICAgIGNvbnN0IHRoZVZhbHVlID0gdmFsdWUgPT0gbnVsbCA/ICcnIDogdmFsdWU7XG4gICAgaWYgKHRoZVZhbHVlICE9PSAnJykge1xuICAgICAgdGhpcy5sb2FkRGF0YSh0aGVWYWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3VycmVudFZhbHVlID0gJyc7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5pbnB1dEVsZW1lbnQubmF0aXZlRWxlbWVudC52YWx1ZSA9ICcnO1xuICAgICAgfSwgMCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBsb2FkRGF0YSh0aGVWYWx1ZSkge1xuICAgIGNvbnN0IHRoZVVybCA9IHRoaXMuZGF0YUdyaWRDb25maWd1cmF0aW9uLnNlcnZpY2VVcmw7XG4gICAgY29uc3QgaWQgPSB0aGlzLmRhdGFHcmlkQ29uZmlndXJhdGlvbi5pZDtcbiAgICBjb25zdCBzZWFyY2hQYXJhbSA9IFtcbiAgICAgIHtcbiAgICAgICAgcHJvcGVydHk6IGlkLFxuICAgICAgICB2YWx1ZTogdGhlVmFsdWUsXG4gICAgICAgIG9wZXJhdG9yOiB0aGlzLnNlYXJjaE9wZXJhdG9yVHlwZVxuICAgICAgfVxuICAgIF07XG5cbiAgICBpZiAodGhpcy5wYXJlbnRWYWx1ZSAmJiB0aGlzLnBhcmVudFZhbHVlICE9PSAnJykge1xuICAgICAgc2VhcmNoUGFyYW0ucHVzaCh7XG4gICAgICAgIHByb3BlcnR5OiB0aGlzLmNhc2VjYWRlQ29udHJvbEZpZWxkTmFtZSxcbiAgICAgICAgdmFsdWU6IHRoaXMucGFyZW50VmFsdWUsXG4gICAgICAgIG9wZXJhdG9yOiB0aGlzLnNlYXJjaE9wZXJhdG9yVHlwZVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdGhpcy5zdGFydFdhaXRpbmcoKTtcbiAgICB0aGlzLnJlc3RTZXJ2aWNlLmdldFBhZ2UodGhlVXJsLCAwLCAxMDAwMCwgc2VhcmNoUGFyYW0pXG4gICAgICAudGhlbih2YWx1ZSA9PiB7XG4gICAgICAgIHRoaXMuc3RvcFdhaXRpbmcoKTtcbiAgICAgICAgaWYgKHZhbHVlLmRhdGEubGlzdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCcnKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm9uSXRlbVNlbGVjdGVkKHZhbHVlLmRhdGEubGlzdFswXSk7XG4gICAgICAgIHRoaXMudGhlR3JpZC5kYXRhSXRlbXMgPSBbXTtcbiAgICAgICAgdGhpcy50aGVHcmlkLmRhdGFJdGVtcy5wdXNoKHZhbHVlLmRhdGEubGlzdFswXSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKHJlYXNvbiA9PiB7XG4gICAgICAgIHRoaXMuc3RvcFdhaXRpbmcoKTtcbiAgICAgICAgdGhpcy5vbkNoYW5nZSgnJyk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHBpY2tlckJlZm9yZUhpZGUoKSB7XG4gICAgaWYgKHRoaXMuY3VycmVudFZhbHVlID09PSAnJykge1xuICAgICAgdGhpcy5pbnB1dEVsZW1lbnQubmF0aXZlRWxlbWVudC52YWx1ZSA9ICcnO1xuICAgIH1cbiAgfVxuXG4gIHBpY2tlckJlZm9yZVNob3coKSB7XG4gIH1cbn1cbiJdfQ==