/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { CookieService } from 'ngx-cookie-service';
import { DeviceDetectorService } from 'ngx-device-detector';
import * as i0 from "@angular/core";
import * as i1 from "ngx-cookie-service";
import * as i2 from "ngx-device-detector";
export class TaminStorageService {
    /**
     * @param {?} cookieService
     * @param {?} deviceService
     */
    constructor(cookieService, deviceService) {
        this.cookieService = cookieService;
        this.deviceService = deviceService;
        this.memoryStorage = [];
        if (deviceService.os === 'iPhone' || deviceService.os === 'iPad' || deviceService.browser === 'safari' || deviceService.browser === 'Safari') {
            this.policy = 'cookie';
            return;
        }
        if (this.doLocalStorageWork()) {
            this.policy = 'local-storage';
        }
        else if (this.doCookieWork()) {
            this.policy = 'cookie';
        }
        else {
            this.policy = 'memory';
        }
    }
    /**
     * @private
     * @return {?}
     */
    doLocalStorageWork() {
        try {
            localStorage.setItem('dummy', 'dummy');
            if (localStorage.getItem('dummy') === 'dummy') {
                localStorage.removeItem('dummy');
                return true;
            }
            else {
                localStorage.removeItem('dummy');
                return false;
            }
        }
        catch (_a) {
            return false;
        }
    }
    /**
     * @private
     * @return {?}
     */
    doCookieWork() {
        try {
            this.cookieService.set('dummy', 'dummy', null, null, null, true, 'Strict');
            if (this.cookieService.get('dummy') === 'dummy') {
                this.cookieService.delete('dummy');
                return true;
            }
            else {
                this.cookieService.delete('dummy');
                return false;
            }
        }
        catch (_a) {
            return false;
        }
    }
    /**
     * @param {?} key
     * @param {?} value
     * @return {?}
     */
    set(key, value) {
        switch (this.policy) {
            case 'local-storage':
                localStorage.setItem(key, value);
                break;
            case 'cookie':
                this.cookieService.set(key, value, null, null, null, null, 'Strict');
                break;
            case 'memory':
                /** @type {?} */
                const item = this.memoryStorage.find((/**
                 * @param {?} c
                 * @return {?}
                 */
                c => c.name === key));
                if (item) {
                    item.value = value;
                }
                else {
                    this.memoryStorage.push({ name: key, value: value });
                }
                break;
        }
    }
    /**
     * @param {?} key
     * @return {?}
     */
    get(key) {
        switch (this.policy) {
            case 'local-storage':
                return localStorage.getItem(key);
            case 'cookie':
                return this.cookieService.get(key);
            case 'memory':
                /** @type {?} */
                const item = this.memoryStorage.find((/**
                 * @param {?} c
                 * @return {?}
                 */
                c => c.name === key));
                if (item) {
                    return item.value;
                }
                else {
                    return '';
                }
        }
    }
    /**
     * @param {?} key
     * @return {?}
     */
    exists(key) {
        switch (this.policy) {
            case 'local-storage':
                return localStorage.getItem(key) !== null;
            case 'cookie':
                return this.cookieService.get(key) !== '';
            case 'memory':
                /** @type {?} */
                const item = this.memoryStorage.find((/**
                 * @param {?} c
                 * @return {?}
                 */
                c => c.name === key));
                return item !== null;
        }
    }
    /**
     * @param {?} key
     * @return {?}
     */
    remove(key) {
        switch (this.policy) {
            case 'local-storage':
                localStorage.removeItem(key);
                break;
            case 'cookie':
                this.cookieService.delete(key);
                break;
            case 'memory':
                /** @type {?} */
                const index = this.memoryStorage.findIndex((/**
                 * @param {?} c
                 * @return {?}
                 */
                c => c.name === key));
                if (index >= 0) {
                    delete this.memoryStorage[index];
                }
        }
    }
}
TaminStorageService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
TaminStorageService.ctorParameters = () => [
    { type: CookieService },
    { type: DeviceDetectorService }
];
/** @nocollapse */ TaminStorageService.ngInjectableDef = i0.defineInjectable({ factory: function TaminStorageService_Factory() { return new TaminStorageService(i0.inject(i1.CookieService), i0.inject(i2.DeviceDetectorService)); }, token: TaminStorageService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    TaminStorageService.prototype.policy;
    /**
     * @type {?}
     * @private
     */
    TaminStorageService.prototype.memoryStorage;
    /**
     * @type {?}
     * @private
     */
    TaminStorageService.prototype.cookieService;
    /**
     * @type {?}
     * @private
     */
    TaminStorageService.prototype.deviceService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFtaW4tc3RvcmFnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vdGFtaW4tZnJhbWV3b3JrLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3RhbWluLXN0b3JhZ2UvdGFtaW4tc3RvcmFnZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ3pDLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUNqRCxPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSxxQkFBcUIsQ0FBQzs7OztBQUsxRCxNQUFNLE9BQU8sbUJBQW1COzs7OztJQUs5QixZQUFvQixhQUE0QixFQUFVLGFBQW9DO1FBQTFFLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQXVCO1FBRnRGLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBR3pCLElBQUksYUFBYSxDQUFDLEVBQUUsS0FBSyxRQUFRLElBQUksYUFBYSxDQUFDLEVBQUUsS0FBSyxNQUFNLElBQUksYUFBYSxDQUFDLE9BQU8sS0FBSyxRQUFRLElBQUksYUFBYSxDQUFDLE9BQU8sS0FBSyxRQUFRLEVBQUU7WUFDNUksSUFBSSxDQUFDLE1BQU0sR0FBRyxRQUFRLENBQUM7WUFDdkIsT0FBTztTQUNSO1FBQ0QsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUUsRUFBRTtZQUM3QixJQUFJLENBQUMsTUFBTSxHQUFHLGVBQWUsQ0FBQztTQUMvQjthQUFNLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRSxFQUFFO1lBQzlCLElBQUksQ0FBQyxNQUFNLEdBQUcsUUFBUSxDQUFDO1NBQ3hCO2FBQU07WUFDTCxJQUFJLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQztTQUN4QjtJQUNILENBQUM7Ozs7O0lBRU8sa0JBQWtCO1FBQ3hCLElBQUk7WUFDRixZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFB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QyxLQUFLLElBQUksQ0FBQztZQUM1QyxLQUFLLFFBQVE7Z0JBQ1gsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDNUMsS0FBSyxRQUFROztzQkFDTCxJQUFJLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJOzs7O2dCQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxHQUFHLEVBQUM7Z0JBQ3pELE9BQU8sSUFBSSxLQUFLLElBQUksQ0FBQztTQUN4QjtJQUNILENBQUM7Ozs7O0lBRUQsTUFBTSxDQUFDLEdBQVc7UUFDaEIsUUFBUSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ25CLEtBQUssZUFBZTtnQkFDbEIsWUFBWSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDN0IsTUFBTTtZQUNSLEtBQUssUUFBUTtnQkFDWCxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDL0IsTUFBTTtZQUNSLEtBQUssUUFBUTs7c0JBQ0wsS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUzs7OztnQkFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssR0FBRyxFQUFDO2dCQUMvRCxJQUFJLEtBQUssSUFBSSxDQUFDLEVBQUU7b0JBQ2QsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUNsQztTQUNKO0lBQ0gsQ0FBQzs7O1lBakhGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OztZQUxPLGFBQWE7WUFDYixxQkFBcUI7Ozs7Ozs7O0lBTzNCLHFDQUFzRDs7Ozs7SUFDdEQsNENBQTJCOzs7OztJQUVmLDRDQUFvQzs7Ozs7SUFBRSw0Q0FBNEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtDb29raWVTZXJ2aWNlfSBmcm9tICduZ3gtY29va2llLXNlcnZpY2UnO1xuaW1wb3J0IHtEZXZpY2VEZXRlY3RvclNlcnZpY2V9IGZyb20gJ25neC1kZXZpY2UtZGV0ZWN0b3InO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUYW1pblN0b3JhZ2VTZXJ2aWNlIHtcblxuICBwcml2YXRlIHBvbGljeTogJ2xvY2FsLXN0b3JhZ2UnIHwgJ2Nvb2tpZScgfCAnbWVtb3J5JztcbiAgcHJpdmF0ZSBtZW1vcnlTdG9yYWdlID0gW107XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb29raWVTZXJ2aWNlOiBDb29raWVTZXJ2aWNlLCBwcml2YXRlIGRldmljZVNlcnZpY2U6IERldmljZURldGVjdG9yU2VydmljZSkge1xuICAgIGlmIChkZXZpY2VTZXJ2aWNlLm9zID09PSAnaVBob25lJyB8fCBkZXZpY2VTZXJ2aWNlLm9zID09PSAnaVBhZCcgfHwgZGV2aWNlU2VydmljZS5icm93c2VyID09PSAnc2FmYXJpJyB8fCBkZXZpY2VTZXJ2aWNlLmJyb3dzZXIgPT09ICdTYWZhcmknKSB7XG4gICAgICB0aGlzLnBvbGljeSA9ICdjb29raWUnO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5kb0xvY2FsU3RvcmFnZVdvcmsoKSkge1xuICAgICAgdGhpcy5wb2xpY3kgPSAnbG9jYWwtc3RvcmFnZSc7XG4gICAgfSBlbHNlIGlmICh0aGlzLmRvQ29va2llV29yaygpKSB7XG4gICAgICB0aGlzLnBvbGljeSA9ICdjb29raWUnO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnBvbGljeSA9ICdtZW1vcnknO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZG9Mb2NhbFN0b3JhZ2VXb3JrKCk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZHVtbXknLCAnZHVtbXknKTtcbiAgICAgIGlmIChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZHVtbXknKSA9PT0gJ2R1bW15Jykge1xuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgnZHVtbXknKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgnZHVtbXknKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZG9Db29raWVXb3JrKCk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmNvb2tpZVNlcnZpY2Uuc2V0KCdkdW1teScsICdkdW1teScsIG51bGwsIG51bGwsIG51bGwsIHRydWUsICdTdHJpY3QnKTtcbiAgICAgIGlmICh0aGlzLmNvb2tpZVNlcnZpY2UuZ2V0KCdkdW1teScpID09PSAnZHVtbXknKSB7XG4gICAgICAgIHRoaXMuY29va2llU2VydmljZS5kZWxldGUoJ2R1bW15Jyk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5jb29raWVTZXJ2aWNlLmRlbGV0ZSgnZHVtbXknKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHNldChrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZykge1xuICAgIHN3aXRjaCAodGhpcy5wb2xpY3kpIHtcbiAgICAgIGNhc2UgJ2xvY2FsLXN0b3JhZ2UnOlxuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksIHZhbHVlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdjb29raWUnOlxuICAgICAgICB0aGlzLmNvb2tpZVNlcnZpY2Uuc2V0KGtleSwgdmFsdWUsIG51bGwsIG51bGwsIG51bGwsIG51bGwsICdTdHJpY3QnKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdtZW1vcnknOlxuICAgICAgICBjb25zdCBpdGVtID0gdGhpcy5tZW1vcnlTdG9yYWdlLmZpbmQoYyA9PiBjLm5hbWUgPT09IGtleSk7XG4gICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgaXRlbS52YWx1ZSA9IHZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMubWVtb3J5U3RvcmFnZS5wdXNoKHtuYW1lOiBrZXksIHZhbHVlOiB2YWx1ZX0pO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIGdldChrZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgc3dpdGNoICh0aGlzLnBvbGljeSkge1xuICAgICAgY2FzZSAnbG9jYWwtc3RvcmFnZSc6XG4gICAgICAgIHJldHVybiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpO1xuICAgICAgY2FzZSAnY29va2llJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuY29va2llU2VydmljZS5nZXQoa2V5KTtcbiAgICAgIGNhc2UgJ21lbW9yeSc6XG4gICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLm1lbW9yeVN0b3JhZ2UuZmluZChjID0+IGMubmFtZSA9PT0ga2V5KTtcbiAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICByZXR1cm4gaXRlbS52YWx1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cbiAgICB9XG4gIH1cblxuICBleGlzdHMoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBzd2l0Y2ggKHRoaXMucG9saWN5KSB7XG4gICAgICBjYXNlICdsb2NhbC1zdG9yYWdlJzpcbiAgICAgICAgcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSkgIT09IG51bGw7XG4gICAgICBjYXNlICdjb29raWUnOlxuICAgICAgICByZXR1cm4gdGhpcy5jb29raWVTZXJ2aWNlLmdldChrZXkpICE9PSAnJztcbiAgICAgIGNhc2UgJ21lbW9yeSc6XG4gICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLm1lbW9yeVN0b3JhZ2UuZmluZChjID0+IGMubmFtZSA9PT0ga2V5KTtcbiAgICAgICAgcmV0dXJuIGl0ZW0gIT09IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlKGtleTogc3RyaW5nKSB7XG4gICAgc3dpdGNoICh0aGlzLnBvbGljeSkge1xuICAgICAgY2FzZSAnbG9jYWwtc3RvcmFnZSc6XG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnY29va2llJzpcbiAgICAgICAgdGhpcy5jb29raWVTZXJ2aWNlLmRlbGV0ZShrZXkpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ21lbW9yeSc6XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5tZW1vcnlTdG9yYWdlLmZpbmRJbmRleChjID0+IGMubmFtZSA9PT0ga2V5KTtcbiAgICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgICBkZWxldGUgdGhpcy5tZW1vcnlTdG9yYWdlW2luZGV4XTtcbiAgICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5cblxuLypcbmltcG9ydCB7SW5qZWN0LCBJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7Q29va2llU2VydmljZX0gZnJvbSAnbmd4LWNvb2tpZS1zZXJ2aWNlJztcbmltcG9ydCB7RGV2aWNlRGV0ZWN0b3JTZXJ2aWNlfSBmcm9tICduZ3gtZGV2aWNlLWRldGVjdG9yJztcbmltcG9ydCB7SVRhbWluQXBwbGljYXRpb25Db25maWd9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvdGFtaW4tYXBwbGljYXRpb24tY29uZmlnJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgVGFtaW5TdG9yYWdlU2VydmljZSB7XG5cbiAgcHJpdmF0ZSBwb2xpY3k6ICdsb2NhbC1zdG9yYWdlJyB8ICdjb29raWUnIHwgJ21lbW9yeSc7XG4gIHByaXZhdGUgbWVtb3J5U3RvcmFnZSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY29va2llU2VydmljZTogQ29va2llU2VydmljZSxcbiAgICBwcml2YXRlIGRldmljZVNlcnZpY2U6IERldmljZURldGVjdG9yU2VydmljZSxcbiAgICBASW5qZWN0KCd0YW1pbkFwcGxpY2F0aW9uQ29uZmlnJykgcHJpdmF0ZSB0YW1pbkFwcGxpY2F0aW9uQ29uZmlnOiBJVGFtaW5BcHBsaWNhdGlvbkNvbmZpZykge1xuICAgIHN3aXRjaCAodGFtaW5BcHBsaWNhdGlvbkNvbmZpZy50b2tlblN0b3JhZ2VQb2xpY3kpIHtcbiAgICAgIGNhc2UgJ2F1dG8nOlxuICAgICAgICBpZiAoZGV2aWNlU2VydmljZS5vcyA9PT0gJ2lQaG9uZScgfHwgZGV2aWNlU2VydmljZS5vcyA9PT0gJ2lQYWQnIHx8IGRldmljZVNlcnZpY2UuYnJvd3NlciA9PT0gJ3NhZmFyaScgfHwgZGV2aWNlU2VydmljZS5icm93c2VyID09PSAnU2FmYXJpJykge1xuICAgICAgICAgIHRoaXMucG9saWN5ID0gJ2Nvb2tpZSc7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmRvTG9jYWxTdG9yYWdlV29yaygpKSB7XG4gICAgICAgICAgdGhpcy5wb2xpY3kgPSAnbG9jYWwtc3RvcmFnZSc7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5kb0Nvb2tpZVdvcmsoKSkge1xuICAgICAgICAgIHRoaXMucG9saWN5ID0gJ2Nvb2tpZSc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5wb2xpY3kgPSAnbWVtb3J5JztcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2Nvb2tpZSc6XG4gICAgICAgIHRoaXMucG9saWN5ID0gJ2Nvb2tpZSc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnbG9jYWwtc3RvcmFnZSc6XG4gICAgICAgIHRoaXMucG9saWN5ID0gJ2xvY2FsLXN0b3JhZ2UnO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ21lbW9yeSc6XG4gICAgICAgIHRoaXMucG9saWN5ID0gJ21lbW9yeSc7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZG9Mb2NhbFN0b3JhZ2VXb3JrKCk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnZHVtbXknLCAnZHVtbXknKTtcbiAgICAgIGlmIChsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnZHVtbXknKSA9PT0gJ2R1bW15Jykge1xuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgnZHVtbXknKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgnZHVtbXknKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZG9Db29raWVXb3JrKCk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmNvb2tpZVNlcnZpY2Uuc2V0KCdkdW1teScsICdkdW1teScsIG51bGwsIG51bGwsIG51bGwsIHRydWUsICdTdHJpY3QnKTtcbiAgICAgIGlmICh0aGlzLmNvb2tpZVNlcnZpY2UuZ2V0KCdkdW1teScpID09PSAnZHVtbXknKSB7XG4gICAgICAgIHRoaXMuY29va2llU2VydmljZS5kZWxldGUoJ2R1bW15Jyk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5jb29raWVTZXJ2aWNlLmRlbGV0ZSgnZHVtbXknKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHNldChrZXk6IHN0cmluZywgdmFsdWU6IHN0cmluZykge1xuICAgIHN3aXRjaCAodGhpcy5wb2xpY3kpIHtcbiAgICAgIGNhc2UgJ2xvY2FsLXN0b3JhZ2UnOlxuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksIHZhbHVlKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdjb29raWUnOlxuICAgICAgICB0aGlzLmNvb2tpZVNlcnZpY2Uuc2V0KGtleSwgdmFsdWUsIG51bGwsIG51bGwsIG51bGwsIG51bGwsICdTdHJpY3QnKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdtZW1vcnknOlxuICAgICAgICBjb25zdCBpdGVtID0gdGhpcy5tZW1vcnlTdG9yYWdlLmZpbmQoYyA9PiBjLm5hbWUgPT09IGtleSk7XG4gICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgaXRlbS52YWx1ZSA9IHZhbHVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMubWVtb3J5U3RvcmFnZS5wdXNoKHtuYW1lOiBrZXksIHZhbHVlOiB2YWx1ZX0pO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIGdldChrZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgc3dpdGNoICh0aGlzLnBvbGljeSkge1xuICAgICAgY2FzZSAnbG9jYWwtc3RvcmFnZSc6XG4gICAgICAgIHJldHVybiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpO1xuICAgICAgY2FzZSAnY29va2llJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuY29va2llU2VydmljZS5nZXQoa2V5KTtcbiAgICAgIGNhc2UgJ21lbW9yeSc6XG4gICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLm1lbW9yeVN0b3JhZ2UuZmluZChjID0+IGMubmFtZSA9PT0ga2V5KTtcbiAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICByZXR1cm4gaXRlbS52YWx1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgIH1cbiAgICB9XG4gIH1cblxuICBleGlzdHMoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBzd2l0Y2ggKHRoaXMucG9saWN5KSB7XG4gICAgICBjYXNlICdsb2NhbC1zdG9yYWdlJzpcbiAgICAgICAgcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSkgIT09IG51bGw7XG4gICAgICBjYXNlICdjb29raWUnOlxuICAgICAgICByZXR1cm4gdGhpcy5jb29raWVTZXJ2aWNlLmdldChrZXkpICE9PSAnJztcbiAgICAgIGNhc2UgJ21lbW9yeSc6XG4gICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLm1lbW9yeVN0b3JhZ2UuZmluZChjID0+IGMubmFtZSA9PT0ga2V5KTtcbiAgICAgICAgcmV0dXJuIGl0ZW0gIT09IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcmVtb3ZlKGtleTogc3RyaW5nKSB7XG4gICAgc3dpdGNoICh0aGlzLnBvbGljeSkge1xuICAgICAgY2FzZSAnbG9jYWwtc3RvcmFnZSc6XG4gICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnY29va2llJzpcbiAgICAgICAgdGhpcy5jb29raWVTZXJ2aWNlLmRlbGV0ZShrZXkpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ21lbW9yeSc6XG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5tZW1vcnlTdG9yYWdlLmZpbmRJbmRleChjID0+IGMubmFtZSA9PT0ga2V5KTtcbiAgICAgICAgaWYgKGluZGV4ID49IDApIHtcbiAgICAgICAgICBkZWxldGUgdGhpcy5tZW1vcnlTdG9yYWdlW2luZGV4XTtcbiAgICAgICAgfVxuICAgIH1cbiAgfVxufVxuKi9cbiJdfQ==