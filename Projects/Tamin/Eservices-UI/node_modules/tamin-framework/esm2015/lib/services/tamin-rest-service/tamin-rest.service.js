/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Inject, Injectable } from '@angular/core';
import { HttpClient, HttpParams } from '@angular/common/http';
import { timeout } from 'rxjs/operators';
import { RequestCacheService } from '../request-cache.service';
import * as i0 from "@angular/core";
import * as i1 from "../request-cache.service";
import * as i2 from "@angular/common/http";
export class TaminRestService {
    /**
     * @param {?} taminApplicationConfig
     * @param {?} requestCacheService
     * @param {?} http
     */
    constructor(taminApplicationConfig, requestCacheService, http) {
        this.taminApplicationConfig = taminApplicationConfig;
        this.requestCacheService = requestCacheService;
        this.http = http;
        this.URL_ERROR = 'url not specified';
        this.ID_ERROR = 'id not specified';
    }
    /**
     * @protected
     * @param {?} url
     * @param {?=} pageNo
     * @param {?=} pageSize
     * @param {?=} searchParams
     * @param {?=} sortParams
     * @param {?=} query
     * @return {?}
     */
    getData(url, pageNo, pageSize, searchParams, sortParams, query) {
        // let headers = new HttpHeaders();
        /** @type {?} */
        let params = new HttpParams();
        if (pageNo && pageSize) {
            params = params.append('page', pageNo.toString());
            params = params.append('start', ((pageNo - 1) * pageSize).toString());
            params = params.append('limit', pageSize.toString());
        }
        if (query) {
            Object.keys(query).forEach((/**
             * @param {?} key
             * @return {?}
             */
            (key) => {
                params = params.append(key, query[key]);
            }));
        }
        if (searchParams) {
            params = params.append('filter', JSON.stringify(searchParams));
        }
        if (sortParams) {
            params = params.append('sort', JSON.stringify(sortParams));
        }
        // params = params.append('_dc', (new Date()).getTime().toString());
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            if (this.requestCacheService.hasCached(url)) {
                resolve(this.requestCacheService.getCached(url));
            }
            else {
                this.http.get(url, { params })
                    .pipe(timeout(this.taminApplicationConfig.restTimeout))
                    .toPromise()
                    .then((/**
                 * @param {?} value
                 * @return {?}
                 */
                value => {
                    if (this.requestCacheService.isCacheable(url)) {
                        this.requestCacheService.setCache(url, value);
                    }
                    resolve(value);
                }))
                    .catch((/**
                 * @param {?} reason
                 * @return {?}
                 */
                reason => {
                    reject(reason);
                }));
            }
        }));
    }
    /**
     * @param {?} url
     * @param {?=} searchParams
     * @return {?}
     */
    getBlob(url, searchParams) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            /** @type {?} */
            let params = new HttpParams();
            if (searchParams) {
                params = params.append('filter', JSON.stringify(searchParams));
            }
            this.http.get(url, { params, responseType: 'blob' })
                .pipe(timeout(this.taminApplicationConfig.restTimeout))
                .toPromise()
                .then((/**
             * @param {?} response
             * @return {?}
             */
            (response) => resolve(response)))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            (error) => reject(error)));
        }));
    }
    /**
     * @param {?} url
     * @param {?=} querySearchParams
     * @param {?=} querySortParams
     * @param {?=} query
     * @return {?}
     */
    getAll(url, querySearchParams, querySortParams, query) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            if (url.trim() === '') {
                reject(new Error(this.URL_ERROR));
            }
            this.getData(url, null, null, querySearchParams, querySortParams, query)
                .then((/**
             * @param {?} response
             * @return {?}
             */
            (response) => resolve(response)))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            (error) => reject(error)));
        }));
    }
    /**
     * @param {?} url
     * @param {?} pageNo
     * @param {?} pageSize
     * @param {?=} querySearchParams
     * @param {?=} querySortParams
     * @param {?=} query
     * @return {?}
     */
    getPage(url, pageNo, pageSize, querySearchParams, querySortParams, query) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.getData(url, pageNo, pageSize, querySearchParams, querySortParams, query)
                .then((/**
             * @param {?} response
             * @return {?}
             */
            (response) => resolve(response)))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            (error) => reject(error)));
        }));
    }
    /**
     * @template TModel
     * @param {?} url
     * @param {?=} querySearchParams
     * @param {?=} querySortParams
     * @param {?=} query
     * @return {?}
     */
    getAllManaged(url, querySearchParams, querySortParams, query) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.getData(url, null, null, querySearchParams, querySortParams, query)
                .then((/**
             * @param {?} response
             * @return {?}
             */
            (response) => {
                if (response.data) {
                    resolve((/** @type {?} */ (response.data)));
                }
                else if (response.list) {
                    resolve((/** @type {?} */ (response.list)));
                }
            }))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            (error) => reject(error)));
        }));
    }
    /**
     * @template TModel
     * @param {?} url
     * @param {?} pageNo
     * @param {?} pageSize
     * @param {?=} querySearchParams
     * @param {?=} querySortParams
     * @param {?=} query
     * @return {?}
     */
    getPageManaged(url, pageNo, pageSize, querySearchParams, querySortParams, query) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.getData(url, pageNo, pageSize, querySearchParams, querySortParams, query)
                .then((/**
             * @param {?} response
             * @return {?}
             */
            (response) => {
                if (response.data) {
                    resolve((/** @type {?} */ (response.data)));
                }
                else if (response.list) {
                    resolve((/** @type {?} */ (response.list)));
                }
            }))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            (error) => reject(error)));
        }));
    }
    /**
     * @param {?} url
     * @param {?} id
     * @return {?}
     */
    getById(url, id) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            if (url.trim() === '') {
                reject(new Error(this.URL_ERROR));
            }
            if (id.trim() === '') {
                reject(new Error(this.ID_ERROR));
            }
            /** @type {?} */
            const theUrl = `${url}/${id}`;
            this.getData(theUrl)
                .then((/**
             * @param {?} response
             * @return {?}
             */
            (response) => resolve(response)))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            (error) => reject(error)));
        }));
    }
    /**
     * @template TModel
     * @param {?} url
     * @param {?} id
     * @return {?}
     */
    getByIdManaged(url, id) {
        /** @type {?} */
        const theUrl = `${url}/${id}`;
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.getData(url)
                .then((/**
             * @param {?} response
             * @return {?}
             */
            (response) => resolve((/** @type {?} */ (response.data)))))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            (error) => reject(error)));
        }));
    }
    /**
     * @param {?} url
     * @param {?} data
     * @return {?}
     */
    create(url, data) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            if (url.trim() === '') {
                reject(new Error(this.URL_ERROR));
            }
            this.http
                .post(url, data)
                .pipe(timeout(this.taminApplicationConfig.restTimeout))
                .toPromise()
                .then((/**
             * @param {?} response
             * @return {?}
             */
            (response) => {
                resolve(response);
            }))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            (error) => {
                reject(error);
            }));
        }));
    }
    /**
     * @template TModel
     * @param {?} url
     * @param {?} id
     * @param {?} data
     * @return {?}
     */
    update(url, id, data) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            if (url.toString().trim() === '') {
                reject(new Error(this.URL_ERROR));
            }
            if (id.trim() === '') {
                reject(new Error(this.ID_ERROR));
            }
            /** @type {?} */
            const theUrl = `${url}/${id.toString()}`;
            this.http
                .put(theUrl, data)
                .pipe(timeout(this.taminApplicationConfig.restTimeout))
                .toPromise()
                .then((/**
             * @param {?} response
             * @return {?}
             */
            (response) => resolve(response)))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            (error) => reject(error)));
        }));
    }
    /**
     * @param {?} url
     * @param {?} id
     * @return {?}
     */
    delete(url, id) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            if (url.trim() === '') {
                reject(new Error(this.URL_ERROR));
            }
            if (id.trim() === '') {
                reject(new Error(this.ID_ERROR));
            }
            /** @type {?} */
            const theUrl = `${url}/${id}`;
            this.http
                .delete(theUrl)
                .pipe(timeout(this.taminApplicationConfig.restTimeout))
                .toPromise()
                .then((/**
             * @param {?} response
             * @return {?}
             */
            (response) => resolve(response)))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            (error) => reject(error)));
        }));
    }
}
TaminRestService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
TaminRestService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: ['taminApplicationConfig',] }] },
    { type: RequestCacheService },
    { type: HttpClient }
];
/** @nocollapse */ TaminRestService.ngInjectableDef = i0.defineInjectable({ factory: function TaminRestService_Factory() { return new TaminRestService(i0.inject("taminApplicationConfig"), i0.inject(i1.RequestCacheService), i0.inject(i2.HttpClient)); }, token: TaminRestService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @protected
     */
    TaminRestService.prototype.URL_ERROR;
    /**
     * @type {?}
     * @protected
     */
    TaminRestService.prototype.ID_ERROR;
    /**
     * @type {?}
     * @private
     */
    TaminRestService.prototype.taminApplicationConfig;
    /**
     * @type {?}
     * @private
     */
    TaminRestService.prototype.requestCacheService;
    /**
     * @type {?}
     * @private
     */
    TaminRestService.prototype.http;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFtaW4tcmVzdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vdGFtaW4tZnJhbWV3b3JrLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL3RhbWluLXJlc3Qtc2VydmljZS90YW1pbi1yZXN0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBQyxNQUFNLEVBQUUsVUFBVSxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2pELE9BQU8sRUFBQyxVQUFVLEVBQUUsVUFBVSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFHNUQsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRXZDLE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLDBCQUEwQixDQUFDOzs7O0FBTTdELE1BQU0sT0FBTyxnQkFBZ0I7Ozs7OztJQUszQixZQUFzRCxzQkFBK0MsRUFDakYsbUJBQXdDLEVBQ3hDLElBQWdCO1FBRmtCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBeUI7UUFDakYsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4QyxTQUFJLEdBQUosSUFBSSxDQUFZO1FBTDFCLGNBQVMsR0FBRyxtQkFBbUIsQ0FBQztRQUNoQyxhQUFRLEdBQUcsa0JBQWtCLENBQUM7SUFLeEMsQ0FBQzs7Ozs7Ozs7Ozs7SUFFUyxPQUFPLENBQ2YsR0FBVyxFQUNYLE1BQWUsRUFDZixRQUFpQixFQUNqQixZQUE0QixFQUM1QixVQUF3QixFQUN4QixLQUFjOzs7WUFFVixNQUFNLEdBQUcsSUFBSSxVQUFVLEVBQUU7UUFFN0IsSUFBSSxNQUFNLElBQUksUUFBUSxFQUFFO1lBQ3RCLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztZQUNsRCxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMs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LEVBQUUsS0FBSyxFQUFFLEVBQUU7Z0JBQ3BCLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQzthQUNsQzs7a0JBRUssTUFBTSxHQUFHLEdBQUcsR0FBRyxJQUFJLEVBQUUsRUFBRTtZQUM3QixJQUFJLENBQUMsSUFBSTtpQkFDTixNQUFNLENBQUMsTUFBTSxDQUFDO2lCQUNkLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsQ0FBQyxDQUFDO2lCQUN0RCxTQUFTLEVBQUU7aUJBQ1gsSUFBSTs7OztZQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUM7aUJBQ3JDLEtBQUs7Ozs7WUFBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFDLENBQUM7UUFDckMsQ0FBQyxFQUFDLENBQUM7SUFDTCxDQUFDOzs7WUFuTkYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25COzs7OzRDQU1jLE1BQU0sU0FBQyx3QkFBd0I7WUFYdEMsbUJBQW1CO1lBTG5CLFVBQVU7Ozs7Ozs7O0lBYWhCLHFDQUEwQzs7Ozs7SUFDMUMsb0NBQXdDOzs7OztJQUU1QixrREFBeUY7Ozs7O0lBQ3pGLCtDQUFnRDs7Ozs7SUFDaEQsZ0NBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3QsIEluamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtIdHRwQ2xpZW50LCBIdHRwUGFyYW1zfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge1NlYXJjaFBhcmFtfSBmcm9tICcuLi8uLi9tb2RlbHMvc2VhcmNoLXBhcmFtLm1vZGVsJztcbmltcG9ydCB7U29ydFBhcmFtfSBmcm9tICcuLi8uLi9tb2RlbHMvc29ydC1wYXJhbS5tb2RlbCc7XG5pbXBvcnQge3RpbWVvdXR9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7SVRhbWluQXBwbGljYXRpb25Db25maWd9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvdGFtaW4tYXBwbGljYXRpb24tY29uZmlnJztcbmltcG9ydCB7UmVxdWVzdENhY2hlU2VydmljZX0gZnJvbSAnLi4vcmVxdWVzdC1jYWNoZS5zZXJ2aWNlJztcblxuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUYW1pblJlc3RTZXJ2aWNlIHtcblxuICBwcm90ZWN0ZWQgVVJMX0VSUk9SID0gJ3VybCBub3Qgc3BlY2lmaWVkJztcbiAgcHJvdGVjdGVkIElEX0VSUk9SID0gJ2lkIG5vdCBzcGVjaWZpZWQnO1xuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoJ3RhbWluQXBwbGljYXRpb25Db25maWcnKSBwcml2YXRlIHRhbWluQXBwbGljYXRpb25Db25maWc6IElUYW1pbkFwcGxpY2F0aW9uQ29uZmlnLFxuICAgICAgICAgICAgICBwcml2YXRlIHJlcXVlc3RDYWNoZVNlcnZpY2U6IFJlcXVlc3RDYWNoZVNlcnZpY2UsXG4gICAgICAgICAgICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCkge1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldERhdGEoXG4gICAgdXJsOiBzdHJpbmcsXG4gICAgcGFnZU5vPzogbnVtYmVyLFxuICAgIHBhZ2VTaXplPzogbnVtYmVyLFxuICAgIHNlYXJjaFBhcmFtcz86IFNlYXJjaFBhcmFtW10sXG4gICAgc29ydFBhcmFtcz86IFNvcnRQYXJhbVtdLFxuICAgIHF1ZXJ5Pzogb2JqZWN0KTogUHJvbWlzZTxhbnk+IHtcbiAgICAvLyBsZXQgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xuICAgIGxldCBwYXJhbXMgPSBuZXcgSHR0cFBhcmFtcygpO1xuXG4gICAgaWYgKHBhZ2VObyAmJiBwYWdlU2l6ZSkge1xuICAgICAgcGFyYW1zID0gcGFyYW1zLmFwcGVuZCgncGFnZScsIHBhZ2VOby50b1N0cmluZygpKTtcbiAgICAgIHBhcmFtcyA9IHBhcmFtcy5hcHBlbmQoJ3N0YXJ0JywgKChwYWdlTm8gLSAxKSAqIHBhZ2VTaXplKS50b1N0cmluZygpKTtcbiAgICAgIHBhcmFtcyA9IHBhcmFtcy5hcHBlbmQoJ2xpbWl0JywgcGFnZVNpemUudG9TdHJpbmcoKSk7XG4gICAgfVxuXG4gICAgaWYgKHF1ZXJ5KSB7XG4gICAgICBPYmplY3Qua2V5cyhxdWVyeSkuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgIHBhcmFtcyA9IHBhcmFtcy5hcHBlbmQoa2V5LCBxdWVyeVtrZXldKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChzZWFyY2hQYXJhbXMpIHtcbiAgICAgIHBhcmFtcyA9IHBhcmFtcy5hcHBlbmQoJ2ZpbHRlcicsIEpTT04uc3RyaW5naWZ5KHNlYXJjaFBhcmFtcykpO1xuICAgIH1cbiAgICBpZiAoc29ydFBhcmFtcykge1xuICAgICAgcGFyYW1zID0gcGFyYW1zLmFwcGVuZCgnc29ydCcsIEpTT04uc3RyaW5naWZ5KHNvcnRQYXJhbXMpKTtcbiAgICB9XG4gICAgLy8gcGFyYW1zID0gcGFyYW1zLmFwcGVuZCgnX2RjJywgKG5ldyBEYXRlKCkpLmdldFRpbWUoKS50b1N0cmluZygpKTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh0aGlzLnJlcXVlc3RDYWNoZVNlcnZpY2UuaGFzQ2FjaGVkKHVybCkpIHtcbiAgICAgICAgcmVzb2x2ZSh0aGlzLnJlcXVlc3RDYWNoZVNlcnZpY2UuZ2V0Q2FjaGVkKHVybCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5odHRwLmdldCh1cmwsIHtwYXJhbXN9KVxuICAgICAgICAgIC5waXBlKHRpbWVvdXQodGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlc3RUaW1lb3V0KSlcbiAgICAgICAgICAudG9Qcm9taXNlKClcbiAgICAgICAgICAudGhlbih2YWx1ZSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5yZXF1ZXN0Q2FjaGVTZXJ2aWNlLmlzQ2FjaGVhYmxlKHVybCkpIHtcbiAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0Q2FjaGVTZXJ2aWNlLnNldENhY2hlKHVybCwgdmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAuY2F0Y2gocmVhc29uID0+IHtcbiAgICAgICAgICAgIHJlamVjdChyZWFzb24pO1xuICAgICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZ2V0QmxvYih1cmw6IHN0cmluZywgc2VhcmNoUGFyYW1zPzogU2VhcmNoUGFyYW1bXSk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbGV0IHBhcmFtcyA9IG5ldyBIdHRwUGFyYW1zKCk7XG4gICAgICBpZiAoc2VhcmNoUGFyYW1zKSB7XG4gICAgICAgIHBhcmFtcyA9IHBhcmFtcy5hcHBlbmQoJ2ZpbHRlcicsIEpTT04uc3RyaW5naWZ5KHNlYXJjaFBhcmFtcykpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmh0dHAuZ2V0KHVybCwge3BhcmFtcywgcmVzcG9uc2VUeXBlOiAnYmxvYid9KVxuICAgICAgICAucGlwZSh0aW1lb3V0KHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZXN0VGltZW91dCkpXG4gICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHJlc29sdmUocmVzcG9uc2UpKVxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiByZWplY3QoZXJyb3IpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldEFsbCh1cmw6IHN0cmluZywgcXVlcnlTZWFyY2hQYXJhbXM/OiBTZWFyY2hQYXJhbVtdLCBxdWVyeVNvcnRQYXJhbXM/OiBTb3J0UGFyYW1bXSwgcXVlcnk/OiBvYmplY3QpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh1cmwudHJpbSgpID09PSAnJykge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKHRoaXMuVVJMX0VSUk9SKSk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZ2V0RGF0YSh1cmwsIG51bGwsIG51bGwsIHF1ZXJ5U2VhcmNoUGFyYW1zLCBxdWVyeVNvcnRQYXJhbXMsIHF1ZXJ5KVxuICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHJlc29sdmUocmVzcG9uc2UpKVxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiByZWplY3QoZXJyb3IpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldFBhZ2UodXJsOiBzdHJpbmcsIHBhZ2VObzogbnVtYmVyLCBwYWdlU2l6ZTogbnVtYmVyLCBxdWVyeVNlYXJjaFBhcmFtcz86IFNlYXJjaFBhcmFtW10sIHF1ZXJ5U29ydFBhcmFtcz86IFNvcnRQYXJhbVtdLCBxdWVyeT86IG9iamVjdCk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5nZXREYXRhKHVybCwgcGFnZU5vLCBwYWdlU2l6ZSwgcXVlcnlTZWFyY2hQYXJhbXMsIHF1ZXJ5U29ydFBhcmFtcywgcXVlcnkpXG4gICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4gcmVzb2x2ZShyZXNwb25zZSkpXG4gICAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHJlamVjdChlcnJvcikpO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0QWxsTWFuYWdlZDxUTW9kZWw+KHVybDogc3RyaW5nLCBxdWVyeVNlYXJjaFBhcmFtcz86IFNlYXJjaFBhcmFtW10sIHF1ZXJ5U29ydFBhcmFtcz86IFNvcnRQYXJhbVtdLCBxdWVyeT86IG9iamVjdCk6IFByb21pc2U8VE1vZGVsPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPFRNb2RlbD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5nZXREYXRhKHVybCwgbnVsbCwgbnVsbCwgcXVlcnlTZWFyY2hQYXJhbXMsIHF1ZXJ5U29ydFBhcmFtcywgcXVlcnkpXG4gICAgICAgIC50aGVuKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEpIHtcbiAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UuZGF0YSBhcyBUTW9kZWwpO1xuICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UubGlzdCkge1xuICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZS5saXN0IGFzIFRNb2RlbCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiByZWplY3QoZXJyb3IpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldFBhZ2VNYW5hZ2VkPFRNb2RlbD4odXJsOiBzdHJpbmcsIHBhZ2VObzogbnVtYmVyLCBwYWdlU2l6ZTogbnVtYmVyLCBxdWVyeVNlYXJjaFBhcmFtcz86IFNlYXJjaFBhcmFtW10sIHF1ZXJ5U29ydFBhcmFtcz86IFNvcnRQYXJhbVtdLCBxdWVyeT86IG9iamVjdCk6IFByb21pc2U8VE1vZGVsPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPFRNb2RlbD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5nZXREYXRhKHVybCwgcGFnZU5vLCBwYWdlU2l6ZSwgcXVlcnlTZWFyY2hQYXJhbXMsIHF1ZXJ5U29ydFBhcmFtcywgcXVlcnkpXG4gICAgICAgIC50aGVuKChyZXNwb25zZTogYW55KSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEpIHtcbiAgICAgICAgICAgIHJlc29sdmUocmVzcG9uc2UuZGF0YSBhcyBUTW9kZWwpO1xuICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2UubGlzdCkge1xuICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZS5saXN0IGFzIFRNb2RlbCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiByZWplY3QoZXJyb3IpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldEJ5SWQodXJsOiBzdHJpbmcsIGlkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGlmICh1cmwudHJpbSgpID09PSAnJykge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKHRoaXMuVVJMX0VSUk9SKSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChpZC50cmltKCkgPT09ICcnKSB7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IodGhpcy5JRF9FUlJPUikpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB0aGVVcmwgPSBgJHt1cmx9LyR7aWR9YDtcblxuICAgICAgdGhpcy5nZXREYXRhKHRoZVVybClcbiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiByZXNvbHZlKHJlc3BvbnNlKSlcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gcmVqZWN0KGVycm9yKSk7XG4gICAgfSk7XG4gIH1cblxuICBnZXRCeUlkTWFuYWdlZDxUTW9kZWw+KHVybDogc3RyaW5nLCBpZDogbnVtYmVyKTogUHJvbWlzZTxUTW9kZWw+IHtcbiAgICBjb25zdCB0aGVVcmwgPSBgJHt1cmx9LyR7aWR9YDtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmdldERhdGEodXJsKVxuICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHJlc29sdmUocmVzcG9uc2UuZGF0YSBhcyBUTW9kZWwpKVxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiByZWplY3QoZXJyb3IpKTtcbiAgICB9KTtcbiAgfVxuXG4gIGNyZWF0ZSh1cmw6IHN0cmluZywgZGF0YTogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBpZiAodXJsLnRyaW0oKSA9PT0gJycpIHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcih0aGlzLlVSTF9FUlJPUikpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmh0dHBcbiAgICAgICAgLnBvc3QodXJsLCBkYXRhKVxuICAgICAgICAucGlwZSh0aW1lb3V0KHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZXN0VGltZW91dCkpXG4gICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xuICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgdXBkYXRlPFRNb2RlbD4odXJsOiBzdHJpbmcsIGlkOiBzdHJpbmcsIGRhdGE6IFRNb2RlbCk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaWYgKHVybC50b1N0cmluZygpLnRyaW0oKSA9PT0gJycpIHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcih0aGlzLlVSTF9FUlJPUikpO1xuICAgICAgfVxuXG4gICAgICBpZiAoaWQudHJpbSgpID09PSAnJykge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKHRoaXMuSURfRVJST1IpKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdGhlVXJsID0gYCR7dXJsfS8ke2lkLnRvU3RyaW5nKCl9YDtcbiAgICAgIHRoaXMuaHR0cFxuICAgICAgICAucHV0KHRoZVVybCwgZGF0YSlcbiAgICAgICAgLnBpcGUodGltZW91dCh0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVzdFRpbWVvdXQpKVxuICAgICAgICAudG9Qcm9taXNlKClcbiAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiByZXNvbHZlKHJlc3BvbnNlKSlcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4gcmVqZWN0KGVycm9yKSk7XG4gICAgfSk7XG4gIH1cblxuICBkZWxldGUodXJsOiBzdHJpbmcsIGlkOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgaWYgKHVybC50cmltKCkgPT09ICcnKSB7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IodGhpcy5VUkxfRVJST1IpKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGlkLnRyaW0oKSA9PT0gJycpIHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcih0aGlzLklEX0VSUk9SKSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRoZVVybCA9IGAke3VybH0vJHtpZH1gO1xuICAgICAgdGhpcy5odHRwXG4gICAgICAgIC5kZWxldGUodGhlVXJsKVxuICAgICAgICAucGlwZSh0aW1lb3V0KHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZXN0VGltZW91dCkpXG4gICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAudGhlbigocmVzcG9uc2UpID0+IHJlc29sdmUocmVzcG9uc2UpKVxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiByZWplY3QoZXJyb3IpKTtcbiAgICB9KTtcbiAgfVxufVxuIl19