/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Inject, Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Router } from '@angular/router';
import { TaminRestService } from '../tamin-rest-service/tamin-rest.service';
import { TaminStorageService } from '../tamin-storage/tamin-storage.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "../tamin-rest-service/tamin-rest.service";
import * as i3 from "../tamin-storage/tamin-storage.service";
import * as i4 from "@angular/common/http";
export class TaminSecurityService {
    /**
     * @param {?} taminApplicationConfig
     * @param {?} router
     * @param {?} taminRestService
     * @param {?} taminStorageService
     * @param {?} httpClient
     */
    constructor(taminApplicationConfig, router, taminRestService, taminStorageService, httpClient) {
        this.taminApplicationConfig = taminApplicationConfig;
        this.router = router;
        this.taminRestService = taminRestService;
        this.taminStorageService = taminStorageService;
        this.httpClient = httpClient;
        this._currentUser = null;
        this.tokenName = 'access_token';
        this.tokenExpire = 'expires_in';
        this.redirectUrl = 'redirect_url';
        // debugger;
    }
    /**
     * @return {?}
     */
    get currentUser() {
        return this._currentUser;
    }
    /**
     * @private
     * @param {?} url
     * @return {?}
     */
    addRedirectUrl(url) {
        this.taminStorageService.set(this.redirectUrl, url);
    }
    /**
     * @return {?}
     */
    getRedirectUrl() {
        return this.taminStorageService.get(this.redirectUrl);
    }
    /**
     * @return {?}
     */
    removeRedirectUrl() {
        this.taminStorageService.remove(this.redirectUrl);
    }
    /**
     * @private
     * @param {?} token
     * @param {?} expireIn
     * @return {?}
     */
    addToken(token, expireIn) {
        this.taminStorageService.set(this.tokenName, token);
        this.taminStorageService.set(this.tokenExpire, expireIn);
    }
    /**
     * @return {?}
     */
    getToken() {
        return this.taminStorageService.get(this.tokenName);
    }
    /**
     * @return {?}
     */
    hasToken() {
        return this.taminStorageService.exists(this.tokenName);
    }
    /**
     * @return {?}
     */
    removeToken() {
        this.taminStorageService.remove(this.tokenName);
        this.taminStorageService.remove(this.tokenExpire);
    }
    /**
     * @return {?}
     */
    checkToken() {
        if (!this.taminStorageService.exists(this.tokenName) || !this.taminStorageService.exists(this.tokenExpire)) {
            return false;
        }
        /** @type {?} */
        const accessToken = this.taminStorageService.get(this.tokenName);
        /** @type {?} */
        const expiresIn = this.taminStorageService.get(this.tokenExpire);
        /** @type {?} */
        const thisTime = Number(new Date().getTime());
        if (Number(thisTime) > Number(expiresIn)) {
            this.removeToken();
            return false;
        }
        return true;
    }
    /**
     * @return {?}
     */
    loginCallbackCheck() {
        // debugger;
        /** @type {?} */
        const tmp1 = window.location.hash.replace('#', '').split('&');
        /** @type {?} */
        const hashParams = tmp1.map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            /** @type {?} */
            const t = value.split('=');
            /** @type {?} */
            const n = t[0];
            /** @type {?} */
            const v = t[1];
            /** @type {?} */
            const result = {};
            result[n] = v;
            return result;
        }));
        /** @type {?} */
        const tmp2 = window.location.search.replace('?', '').split('&');
        /** @type {?} */
        const searchParams = tmp2.map((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            /** @type {?} */
            const t = value.split('=');
            /** @type {?} */
            const n = t[0];
            /** @type {?} */
            const v = t[1];
            /** @type {?} */
            const result = {};
            result[n] = v;
            return result;
        }));
        /** @type {?} */
        const accessToken = hashParams.find((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            return value.hasOwnProperty('access_token');
        }));
        /** @type {?} */
        const expiresIn = hashParams.find((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            return value.hasOwnProperty('expires_in');
        }));
        /** @type {?} */
        const hp = searchParams.find((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            return value.hasOwnProperty('hp');
        }));
        if (accessToken && expiresIn) {
            /** @type {?} */
            const currentTime = new Date().getTime();
            this.addToken(accessToken['access_token'], Number(currentTime) + (Number(expiresIn['expires_in']) * 1000));
            window.history.replaceState({}, document.title, '');
            if (hp) {
                window.history.replaceState({}, document.title, '/#/' + hp['hp']);
            }
            else {
                window.history.replaceState({}, document.title, '/#/main');
            }
        }
    }
    /**
     * @return {?}
     */
    getUserName() {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.taminRestService.getAll(this.taminApplicationConfig.getUserNameUrl)
                .then((/**
             * @param {?} data
             * @return {?}
             */
            (data) => {
                resolve(`${data.data.firstName} ${data.data.lastName}`);
            }))
                .catch((/**
             * @param {?} reason
             * @return {?}
             */
            reason => {
                reject('');
            }));
        }));
    }
    /**
     * @return {?}
     */
    getCurrentUser() {
        this._currentUser = null;
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.taminRestService.getAll(this.taminApplicationConfig.getUserNameUrl)
                .then((/**
             * @param {?} data
             * @return {?}
             */
            (data) => {
                this._currentUser = data.data;
                resolve(data.data);
            }))
                .catch((/**
             * @param {?} reason
             * @return {?}
             */
            reason => {
                reject(reason);
            }));
        }));
    }
    /**
     * @private
     * @return {?}
     */
    redirectToLoginWithCordova() {
        this.router.navigate(['login']);
        // const url = [
        //   this.taminApplicationConfig.authenticationEndpoint,
        //   '?',
        //   // `redirect_uri=${window.location.href}`,
        //   `redirect_uri=${this.taminApplicationConfig.redirectUrl}`,
        //   '&',
        //   `response_type=${this.taminApplicationConfig.responseType}`,
        //   '&',
        //   `client_id=${this.taminApplicationConfig.clientId}`
        // ].join('');
        //
        // SafariViewController.isAvailable(function (available) {
        //   if (available) {
        //     SafariViewController.show(
        //       {
        //         url: url
        //       },
        //       function (result) {
        //       },
        //       function (error) {
        //       }
        //     );
        //   }
        // });
    }
    /**
     * @private
     * @param {?=} url
     * @return {?}
     */
    redirectToLoginWithBrowser(url = '') {
        this.removeToken();
        /** @type {?} */
        const adressParts = url === '' ? window.location.href.split('/#/') : url;
        /** @type {?} */
        let hp = '';
        /** @type {?} */
        let returnUrl = '';
        if (adressParts.length === 1) {
            returnUrl = adressParts[0];
        }
        else {
            hp = adressParts[1];
            returnUrl = adressParts[0] + '?hp=' + hp;
        }
        window.location.href = [
            this.taminApplicationConfig.authenticationEndpoint,
            '?',
            `redirect_uri=${this.taminApplicationConfig.redirectUrl}`,
            '&',
            `response_type=${this.taminApplicationConfig.responseType}`,
            '&',
            `client_id=${this.taminApplicationConfig.clientId}`
        ].join('');
    }
    /**
     * @param {?=} url
     * @return {?}
     */
    redirectToLogin(url = '') {
        if (window.hasOwnProperty('cordova')) {
            this.redirectToLoginWithCordova();
        }
        else {
            if (url !== '') {
                this.addRedirectUrl(url);
            }
            this.redirectToLoginWithBrowser(url);
        }
    }
    /**
     * @return {?}
     */
    getLoginUrl() {
        /** @type {?} */
        const tmp = [
            this.taminApplicationConfig.authenticationEndpoint,
            '?',
            `redirect_uri=${this.taminApplicationConfig.redirectUrl}`,
            '&',
            `response_type=${this.taminApplicationConfig.responseType}`,
            '&',
            `client_id=${this.taminApplicationConfig.clientId}`
        ].join('');
        return tmp;
    }
    /**
     * @return {?}
     */
    redirectToLogout() {
        if (window.hasOwnProperty('cordova')) {
            this.removeToken();
        }
        else {
            /** @type {?} */
            const returnUrl = this.taminApplicationConfig.baseUrl;
            this.removeToken();
            window.location.href =
                `${this.taminApplicationConfig.logoutUrl}?redirect_uri=${this.taminApplicationConfig.redirectUrl}&response_type=${this.taminApplicationConfig.responseType}&client_id=${this.taminApplicationConfig.clientId}`;
        }
    }
    /**
     * @param {?} un
     * @param {?} pw
     * @param {?} clientId
     * @param {?} security
     * @return {?}
     */
    mobileLogin(un, pw, clientId, security) {
        this.removeToken();
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            taminLogin.login(un, pw, this.taminApplicationConfig.authenticationEndpoint, clientId, security, (/**
             * @param {?} value
             * @return {?}
             */
            (value) => {
                /** @type {?} */
                const result = JSON.parse(value);
                /** @type {?} */
                const currentTime = new Date().getTime();
                this.addToken(result.access_token, Number(currentTime) + (Number(result.expires_in) * 1000));
                resolve();
            }), (/**
             * @return {?}
             */
            () => {
                reject();
            }));
        }));
    }
    /**
     * @param {?} url
     * @return {?}
     */
    hasAccressTo(url) {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        (resolve, reject) => {
            this.httpClient.get(url)
                .toPromise()
                .then((/**
             * @param {?} data
             * @return {?}
             */
            data => {
                resolve(true);
            }))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            (error) => {
                if (error.status === 401) {
                    resolve(false);
                }
            }));
        }));
    }
}
TaminSecurityService.decorators = [
    { type: Injectable, args: [{ providedIn: 'root' },] }
];
/** @nocollapse */
TaminSecurityService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: ['taminApplicationConfig',] }] },
    { type: Router },
    { type: TaminRestService },
    { type: TaminStorageService },
    { type: HttpClient }
];
/** @nocollapse */ TaminSecurityService.ngInjectableDef = i0.defineInjectable({ factory: function TaminSecurityService_Factory() { return new TaminSecurityService(i0.inject("taminApplicationConfig"), i0.inject(i1.Router), i0.inject(i2.TaminRestService), i0.inject(i3.TaminStorageService), i0.inject(i4.HttpClient)); }, token: TaminSecurityService, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype._currentUser;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.tokenName;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.tokenExpire;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.redirectUrl;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.taminApplicationConfig;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.taminRestService;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.taminStorageService;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.httpClient;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFtaW4tc2VjdXJpdHkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3RhbWluLWZyYW1ld29yay8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy90YW1pbi1zZWN1cml0eS90YW1pbi1zZWN1cml0eS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUMsVUFBVSxFQUFvQixNQUFNLHNCQUFzQixDQUFDO0FBRW5FLE9BQU8sRUFBQyxNQUFNLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUN2QyxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSwwQ0FBMEMsQ0FBQztBQUMxRSxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSx3Q0FBd0MsQ0FBQzs7Ozs7O0FBSzNFLE1BQU0sT0FBTyxvQkFBb0I7Ozs7Ozs7O0lBTS9CLFlBRVUsc0JBQStDLEVBQy9DLE1BQWMsRUFDZCxnQkFBa0MsRUFDbEMsbUJBQXdDLEVBQ3hDLFVBQXNCO1FBSnRCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBeUI7UUFDL0MsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4QyxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBWHhCLGlCQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLGNBQVMsR0FBRyxjQUFjLENBQUM7UUFDM0IsZ0JBQVcsR0FBRyxZQUFZLENBQUM7UUFDM0IsZ0JBQVcsR0FBRyxjQUFjLENBQUM7UUFTbkMsWUFBWTtJQUNkLENBQUM7Ozs7SUFFRCxJQUFJLFdBQVc7UUFDYixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDM0IsQ0FBQzs7Ozs7O0lBRU8sY0FBYyxDQUFDLEdBQUc7UUFDeEIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLEdBQUcs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O1lBQUUsR0FBRyxFQUFFO2dCQUNOLE1BQU0sRUFBRSxDQUFDO1lBQ1gsQ0FBQyxFQUFDLENBQUM7UUFDTCxDQUFDLEVBQUMsQ0FBQztJQUNMLENBQUM7Ozs7O0lBRUQsWUFBWSxDQUFDLEdBQVc7UUFDdEIsT0FBTyxJQUFJLE9BQU87Ozs7O1FBQVUsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDOUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO2lCQUNyQixTQUFTLEVBQUU7aUJBQ1gsSUFBSTs7OztZQUFDLElBQUksQ0FBQyxFQUFFO2dCQUNYLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNoQixDQUFDLEVBQUM7aUJBQ0QsS0FBSzs7OztZQUFDLENBQUMsS0FBd0IsRUFBRSxFQUFFO2dCQUNsQyxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssR0FBRyxFQUFFO29CQUN4QixPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQ2hCO1lBQ0gsQ0FBQyxFQUFDLENBQUM7UUFDUCxDQUFDLEVBQUMsQ0FBQztJQUNMLENBQUM7OztZQTVQRixVQUFVLFNBQUMsRUFBQyxVQUFVLEVBQUUsTUFBTSxFQUFDOzs7OzRDQVEzQixNQUFNLFNBQUMsd0JBQXdCO1lBZDVCLE1BQU07WUFDTixnQkFBZ0I7WUFDaEIsbUJBQW1CO1lBSm5CLFVBQVU7Ozs7Ozs7O0lBVWhCLDRDQUE0Qjs7Ozs7SUFDNUIseUNBQW1DOzs7OztJQUNuQywyQ0FBbUM7Ozs7O0lBQ25DLDJDQUFxQzs7Ozs7SUFHbkMsc0RBQ3VEOzs7OztJQUN2RCxzQ0FBc0I7Ozs7O0lBQ3RCLGdEQUEwQzs7Ozs7SUFDMUMsbURBQWdEOzs7OztJQUNoRCwwQ0FBOEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdCwgSW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0h0dHBDbGllbnQsIEh0dHBFcnJvclJlc3BvbnNlfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge0lUYW1pbkFwcGxpY2F0aW9uQ29uZmlnfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3RhbWluLWFwcGxpY2F0aW9uLWNvbmZpZyc7XG5pbXBvcnQge1JvdXRlcn0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7VGFtaW5SZXN0U2VydmljZX0gZnJvbSAnLi4vdGFtaW4tcmVzdC1zZXJ2aWNlL3RhbWluLXJlc3Quc2VydmljZSc7XG5pbXBvcnQge1RhbWluU3RvcmFnZVNlcnZpY2V9IGZyb20gJy4uL3RhbWluLXN0b3JhZ2UvdGFtaW4tc3RvcmFnZS5zZXJ2aWNlJztcblxuZGVjbGFyZSBsZXQgdGFtaW5Mb2dpbjogYW55O1xuXG5ASW5qZWN0YWJsZSh7cHJvdmlkZWRJbjogJ3Jvb3QnfSlcbmV4cG9ydCBjbGFzcyBUYW1pblNlY3VyaXR5U2VydmljZSB7XG4gIHByaXZhdGUgX2N1cnJlbnRVc2VyID0gbnVsbDtcbiAgcHJpdmF0ZSB0b2tlbk5hbWUgPSAnYWNjZXNzX3Rva2VuJztcbiAgcHJpdmF0ZSB0b2tlbkV4cGlyZSA9ICdleHBpcmVzX2luJztcbiAgcHJpdmF0ZSByZWRpcmVjdFVybCA9ICdyZWRpcmVjdF91cmwnO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoJ3RhbWluQXBwbGljYXRpb25Db25maWcnKVxuICAgIHByaXZhdGUgdGFtaW5BcHBsaWNhdGlvbkNvbmZpZzogSVRhbWluQXBwbGljYXRpb25Db25maWcsXG4gICAgcHJpdmF0ZSByb3V0ZXI6IFJvdXRlcixcbiAgICBwcml2YXRlIHRhbWluUmVzdFNlcnZpY2U6IFRhbWluUmVzdFNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0YW1pblN0b3JhZ2VTZXJ2aWNlOiBUYW1pblN0b3JhZ2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgaHR0cENsaWVudDogSHR0cENsaWVudCkge1xuICAgIC8vIGRlYnVnZ2VyO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRVc2VyKCk6IGFueSB7XG4gICAgcmV0dXJuIHRoaXMuX2N1cnJlbnRVc2VyO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRSZWRpcmVjdFVybCh1cmwpIHtcbiAgICB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2Uuc2V0KHRoaXMucmVkaXJlY3RVcmwsIHVybCk7XG4gIH1cblxuICBnZXRSZWRpcmVjdFVybCgpIHtcbiAgICByZXR1cm4gdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLmdldCh0aGlzLnJlZGlyZWN0VXJsKTtcbiAgfVxuXG4gIHJlbW92ZVJlZGlyZWN0VXJsKCkge1xuICAgIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5yZW1vdmUodGhpcy5yZWRpcmVjdFVybCk7XG4gIH1cblxuICBwcml2YXRlIGFkZFRva2VuKHRva2VuOiBhbnksIGV4cGlyZUluOiBhbnkpIHtcbiAgICB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2Uuc2V0KHRoaXMudG9rZW5OYW1lLCB0b2tlbik7XG4gICAgdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLnNldCh0aGlzLnRva2VuRXhwaXJlLCBleHBpcmVJbik7XG4gIH1cblxuICBwdWJsaWMgZ2V0VG9rZW4oKSB7XG4gICAgcmV0dXJuIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5nZXQodGhpcy50b2tlbk5hbWUpO1xuICB9XG5cbiAgcHVibGljIGhhc1Rva2VuKCkge1xuICAgIHJldHVybiB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZXhpc3RzKHRoaXMudG9rZW5OYW1lKTtcbiAgfVxuXG4gIHJlbW92ZVRva2VuKCkge1xuICAgIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5yZW1vdmUodGhpcy50b2tlbk5hbWUpO1xuICAgIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5yZW1vdmUodGhpcy50b2tlbkV4cGlyZSk7XG4gIH1cblxuICBjaGVja1Rva2VuKCkge1xuICAgIGlmICghdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLmV4aXN0cyh0aGlzLnRva2VuTmFtZSkgfHwgIXRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5leGlzdHModGhpcy50b2tlbkV4cGlyZSkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgYWNjZXNzVG9rZW4gPSB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZ2V0KHRoaXMudG9rZW5OYW1lKTtcbiAgICBjb25zdCBleHBpcmVzSW4gPSB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZ2V0KHRoaXMudG9rZW5FeHBpcmUpO1xuICAgIGNvbnN0IHRoaXNUaW1lID0gTnVtYmVyKG5ldyBEYXRlKCkuZ2V0VGltZSgpKTtcbiAgICBpZiAoTnVtYmVyKHRoaXNUaW1lKSA+IE51bWJlcihleHBpcmVzSW4pKSB7XG4gICAgICB0aGlzLnJlbW92ZVRva2VuKCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgbG9naW5DYWxsYmFja0NoZWNrKCkge1xuICAgIC8vIGRlYnVnZ2VyO1xuICAgIGNvbnN0IHRtcDEgPSB3aW5kb3cubG9jYXRpb24uaGFzaC5yZXBsYWNlKCcjJywgJycpLnNwbGl0KCcmJyk7XG4gICAgY29uc3QgaGFzaFBhcmFtcyA9IHRtcDEubWFwKHZhbHVlID0+IHtcbiAgICAgIGNvbnN0IHQgPSB2YWx1ZS5zcGxpdCgnPScpO1xuICAgICAgY29uc3QgbiA9IHRbMF07XG4gICAgICBjb25zdCB2ID0gdFsxXTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgICAgcmVzdWx0W25dID0gdjtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSk7XG5cbiAgICBjb25zdCB0bXAyID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaC5yZXBsYWNlKCc/JywgJycpLnNwbGl0KCcmJyk7XG4gICAgY29uc3Qgc2VhcmNoUGFyYW1zID0gdG1wMi5tYXAodmFsdWUgPT4ge1xuICAgICAgY29uc3QgdCA9IHZhbHVlLnNwbGl0KCc9Jyk7XG4gICAgICBjb25zdCBuID0gdFswXTtcbiAgICAgIGNvbnN0IHYgPSB0WzFdO1xuICAgICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgICByZXN1bHRbbl0gPSB2O1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9KTtcblxuICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gaGFzaFBhcmFtcy5maW5kKHZhbHVlID0+IHtcbiAgICAgIHJldHVybiB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgnYWNjZXNzX3Rva2VuJyk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBleHBpcmVzSW4gPSBoYXNoUGFyYW1zLmZpbmQodmFsdWUgPT4ge1xuICAgICAgcmV0dXJuIHZhbHVlLmhhc093blByb3BlcnR5KCdleHBpcmVzX2luJyk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBocCA9IHNlYXJjaFBhcmFtcy5maW5kKHZhbHVlID0+IHtcbiAgICAgIHJldHVybiB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgnaHAnKTtcbiAgICB9KTtcblxuICAgIGlmIChhY2Nlc3NUb2tlbiAmJiBleHBpcmVzSW4pIHtcbiAgICAgIGNvbnN0IGN1cnJlbnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICB0aGlzLmFkZFRva2VuKGFjY2Vzc1Rva2VuWydhY2Nlc3NfdG9rZW4nXSwgTnVtYmVyKGN1cnJlbnRUaW1lKSArIChOdW1iZXIoZXhwaXJlc0luWydleHBpcmVzX2luJ10pICogMTAwMCkpO1xuICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgJycpO1xuXG4gICAgICBpZiAoaHApIHtcbiAgICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgJy8jLycgKyBocFsnaHAnXSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCAnLyMvbWFpbicpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGdldFVzZXJOYW1lKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy50YW1pblJlc3RTZXJ2aWNlLmdldEFsbCh0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuZ2V0VXNlck5hbWVVcmwpXG4gICAgICAgIC50aGVuKChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgICByZXNvbHZlKGAke2RhdGEuZGF0YS5maXJzdE5hbWV9ICR7ZGF0YS5kYXRhLmxhc3ROYW1lfWApO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2gocmVhc29uID0+IHtcbiAgICAgICAgICByZWplY3QoJycpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldEN1cnJlbnRVc2VyKCk6IFByb21pc2U8YW55PiB7XG4gICAgdGhpcy5fY3VycmVudFVzZXIgPSBudWxsO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMudGFtaW5SZXN0U2VydmljZS5nZXRBbGwodGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmdldFVzZXJOYW1lVXJsKVxuICAgICAgICAudGhlbigoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgdGhpcy5fY3VycmVudFVzZXIgPSBkYXRhLmRhdGE7XG4gICAgICAgICAgcmVzb2x2ZShkYXRhLmRhdGEpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2gocmVhc29uID0+IHtcbiAgICAgICAgICByZWplY3QocmVhc29uKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlZGlyZWN0VG9Mb2dpbldpdGhDb3Jkb3ZhKCkge1xuICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnbG9naW4nXSk7XG4gICAgLy8gY29uc3QgdXJsID0gW1xuICAgIC8vICAgdGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmF1dGhlbnRpY2F0aW9uRW5kcG9pbnQsXG4gICAgLy8gICAnPycsXG4gICAgLy8gICAvLyBgcmVkaXJlY3RfdXJpPSR7d2luZG93LmxvY2F0aW9uLmhyZWZ9YCxcbiAgICAvLyAgIGByZWRpcmVjdF91cmk9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVkaXJlY3RVcmx9YCxcbiAgICAvLyAgICcmJyxcbiAgICAvLyAgIGByZXNwb25zZV90eXBlPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlc3BvbnNlVHlwZX1gLFxuICAgIC8vICAgJyYnLFxuICAgIC8vICAgYGNsaWVudF9pZD0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5jbGllbnRJZH1gXG4gICAgLy8gXS5qb2luKCcnKTtcbiAgICAvL1xuICAgIC8vIFNhZmFyaVZpZXdDb250cm9sbGVyLmlzQXZhaWxhYmxlKGZ1bmN0aW9uIChhdmFpbGFibGUpIHtcbiAgICAvLyAgIGlmIChhdmFpbGFibGUpIHtcbiAgICAvLyAgICAgU2FmYXJpVmlld0NvbnRyb2xsZXIuc2hvdyhcbiAgICAvLyAgICAgICB7XG4gICAgLy8gICAgICAgICB1cmw6IHVybFxuICAgIC8vICAgICAgIH0sXG4gICAgLy8gICAgICAgZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgIC8vICAgICAgIH0sXG4gICAgLy8gICAgICAgZnVuY3Rpb24gKGVycm9yKSB7XG4gICAgLy8gICAgICAgfVxuICAgIC8vICAgICApO1xuICAgIC8vICAgfVxuICAgIC8vIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSByZWRpcmVjdFRvTG9naW5XaXRoQnJvd3Nlcih1cmwgPSAnJykge1xuICAgIHRoaXMucmVtb3ZlVG9rZW4oKTtcbiAgICBjb25zdCBhZHJlc3NQYXJ0cyA9IHVybCA9PT0gJycgPyB3aW5kb3cubG9jYXRpb24uaHJlZi5zcGxpdCgnLyMvJykgOiB1cmw7XG4gICAgbGV0IGhwID0gJyc7XG4gICAgbGV0IHJldHVyblVybCA9ICcnO1xuXG4gICAgaWYgKGFkcmVzc1BhcnRzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgcmV0dXJuVXJsID0gYWRyZXNzUGFydHNbMF07XG4gICAgfSBlbHNlIHtcbiAgICAgIGhwID0gYWRyZXNzUGFydHNbMV07XG4gICAgICByZXR1cm5VcmwgPSBhZHJlc3NQYXJ0c1swXSArICc/aHA9JyArIGhwO1xuICAgIH1cblxuICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gW1xuICAgICAgdGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmF1dGhlbnRpY2F0aW9uRW5kcG9pbnQsXG4gICAgICAnPycsXG4gICAgICBgcmVkaXJlY3RfdXJpPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlZGlyZWN0VXJsfWAsXG4gICAgICAnJicsXG4gICAgICBgcmVzcG9uc2VfdHlwZT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZXNwb25zZVR5cGV9YCxcbiAgICAgICcmJyxcbiAgICAgIGBjbGllbnRfaWQ9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuY2xpZW50SWR9YFxuICAgIF0uam9pbignJyk7XG4gIH1cblxuICByZWRpcmVjdFRvTG9naW4odXJsID0gJycpIHtcbiAgICBpZiAod2luZG93Lmhhc093blByb3BlcnR5KCdjb3Jkb3ZhJykpIHtcbiAgICAgIHRoaXMucmVkaXJlY3RUb0xvZ2luV2l0aENvcmRvdmEoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHVybCAhPT0gJycpIHtcbiAgICAgICAgdGhpcy5hZGRSZWRpcmVjdFVybCh1cmwpO1xuICAgICAgfVxuICAgICAgdGhpcy5yZWRpcmVjdFRvTG9naW5XaXRoQnJvd3Nlcih1cmwpO1xuICAgIH1cbiAgfVxuXG4gIGdldExvZ2luVXJsKCkge1xuICAgIGNvbnN0IHRtcCA9IFtcbiAgICAgIHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5hdXRoZW50aWNhdGlvbkVuZHBvaW50LFxuICAgICAgJz8nLFxuICAgICAgYHJlZGlyZWN0X3VyaT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZWRpcmVjdFVybH1gLFxuICAgICAgJyYnLFxuICAgICAgYHJlc3BvbnNlX3R5cGU9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVzcG9uc2VUeXBlfWAsXG4gICAgICAnJicsXG4gICAgICBgY2xpZW50X2lkPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmNsaWVudElkfWBcbiAgICBdLmpvaW4oJycpO1xuICAgIHJldHVybiB0bXA7XG4gIH1cblxuICByZWRpcmVjdFRvTG9nb3V0KCkge1xuICAgIGlmICh3aW5kb3cuaGFzT3duUHJvcGVydHkoJ2NvcmRvdmEnKSkge1xuICAgICAgdGhpcy5yZW1vdmVUb2tlbigpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCByZXR1cm5VcmwgPSB0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuYmFzZVVybDtcbiAgICAgIHRoaXMucmVtb3ZlVG9rZW4oKTtcbiAgICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID1cbiAgICAgICAgYCR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmxvZ291dFVybH0/cmVkaXJlY3RfdXJpPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlZGlyZWN0VXJsfSZyZXNwb25zZV90eXBlPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlc3BvbnNlVHlwZX0mY2xpZW50X2lkPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmNsaWVudElkfWA7XG4gICAgfVxuICB9XG5cbiAgbW9iaWxlTG9naW4odW4sIHB3LCBjbGllbnRJZCwgc2VjdXJpdHkpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLnJlbW92ZVRva2VuKCk7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRhbWluTG9naW4ubG9naW4odW4sIHB3LCB0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuYXV0aGVudGljYXRpb25FbmRwb2ludCwgY2xpZW50SWQsIHNlY3VyaXR5LCAodmFsdWUpID0+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gSlNPTi5wYXJzZSh2YWx1ZSk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgIHRoaXMuYWRkVG9rZW4ocmVzdWx0LmFjY2Vzc190b2tlbiwgTnVtYmVyKGN1cnJlbnRUaW1lKSArIChOdW1iZXIocmVzdWx0LmV4cGlyZXNfaW4pICogMTAwMCkpO1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9LCAoKSA9PiB7XG4gICAgICAgIHJlamVjdCgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBoYXNBY2NyZXNzVG8odXJsOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8Ym9vbGVhbj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5odHRwQ2xpZW50LmdldCh1cmwpXG4gICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAudGhlbihkYXRhID0+IHtcbiAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICAgIGlmIChlcnJvci5zdGF0dXMgPT09IDQwMSkge1xuICAgICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5cblxuXG4vKlxuXG5pbXBvcnQge0luamVjdCwgSW5qZWN0YWJsZX0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0h0dHBDbGllbnQsIEh0dHBFcnJvclJlc3BvbnNlfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge0lUYW1pbkFwcGxpY2F0aW9uQ29uZmlnfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3RhbWluLWFwcGxpY2F0aW9uLWNvbmZpZyc7XG5pbXBvcnQge1JvdXRlcn0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7VGFtaW5SZXN0U2VydmljZX0gZnJvbSAnLi4vdGFtaW4tcmVzdC1zZXJ2aWNlL3RhbWluLXJlc3Quc2VydmljZSc7XG5pbXBvcnQge1RhbWluU3RvcmFnZVNlcnZpY2V9IGZyb20gJy4uL3RhbWluLXN0b3JhZ2UvdGFtaW4tc3RvcmFnZS5zZXJ2aWNlJztcblxuZGVjbGFyZSBsZXQgdGFtaW5Mb2dpbjogYW55O1xuXG5ASW5qZWN0YWJsZSh7cHJvdmlkZWRJbjogJ3Jvb3QnfSlcbmV4cG9ydCBjbGFzcyBUYW1pblNlY3VyaXR5U2VydmljZSB7XG4gIHByaXZhdGUgX2N1cnJlbnRVc2VyID0gbnVsbDtcbiAgLy8gcHJpdmF0ZSByZWZyZXNoVG9rZW4gPSAncmVmcmVzaCc7XG4gIC8vIHByaXZhdGUgcmVmcmVzaFRva2VuRXhwaXJlID0gJ3JlZnJlc2hfZXhwaXJlc19pbic7XG4gIHByaXZhdGUgdG9rZW5OYW1lID0gJ2FjY2Vzc190b2tlbic7XG4gIHByaXZhdGUgdG9rZW5FeHBpcmUgPSAnZXhwaXJlc19pbic7XG4gIHByaXZhdGUgcmVkaXJlY3RVcmwgPSAncmVkaXJlY3RfdXJsJztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KCd0YW1pbkFwcGxpY2F0aW9uQ29uZmlnJylcbiAgICBwcml2YXRlIHRhbWluQXBwbGljYXRpb25Db25maWc6IElUYW1pbkFwcGxpY2F0aW9uQ29uZmlnLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSB0YW1pblJlc3RTZXJ2aWNlOiBUYW1pblJlc3RTZXJ2aWNlLFxuICAgIHByaXZhdGUgdGFtaW5TdG9yYWdlU2VydmljZTogVGFtaW5TdG9yYWdlU2VydmljZSxcbiAgICBwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQpIHtcbiAgICAvLyBkZWJ1Z2dlcjtcbiAgfVxuXG4gIGdldCBjdXJyZW50VXNlcigpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLl9jdXJyZW50VXNlcjtcbiAgfVxuXG4gIHByaXZhdGUgYWRkUmVkaXJlY3RVcmwodXJsKSB7XG4gICAgdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLnNldCh0aGlzLnJlZGlyZWN0VXJsLCB1cmwpO1xuICB9XG5cbiAgZ2V0UmVkaXJlY3RVcmwoKSB7XG4gICAgcmV0dXJuIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5nZXQodGhpcy5yZWRpcmVjdFVybCk7XG4gIH1cblxuICByZW1vdmVSZWRpcmVjdFVybCgpIHtcbiAgICB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UucmVtb3ZlKHRoaXMucmVkaXJlY3RVcmwpO1xuICB9XG5cbiAgYWRkVG9rZW4odG9rZW46IGFueSwgZXhwaXJlSW46IGFueSkge1xuICAgIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5zZXQodGhpcy50b2tlbk5hbWUsIHRva2VuKTtcbiAgICB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2Uuc2V0KHRoaXMudG9rZW5FeHBpcmUsIGV4cGlyZUluKTtcbiAgfVxuXG4vISpcbiAgYWRkUmVmcmVzaFRva2VuKHRva2VuOiBhbnksIGV4cGlyZUluOiBhbnkpIHtcbiAgICB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2Uuc2V0KHRoaXMucmVmcmVzaFRva2VuLCB0b2tlbik7XG4gICAgdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLnNldCh0aGlzLnJlZnJlc2hUb2tlbkV4cGlyZSwgZXhwaXJlSW4pO1xuICB9XG4qIS9cblxuLyEqXG4gIHJlTmV3VG9rZW4oKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8YW55PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBjb25zdCB0aGVVcmwgPSBgJHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVmcmVzaFRva2VuVXJsfT9yZWZyZXNoX3Rva2VuPSR7dGhpcy5nZXRSZWZyZXNoVG9rZW4oKX1gO1xuICAgICAgdGhpcy5odHRwQ2xpZW50XG4gICAgICAgIC5nZXQ8YW55Pih0aGVVcmwpXG4gICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAudGhlbih2YWx1ZSA9PiB7XG4gICAgICAgICAgaWYgKCF2YWx1ZSkge1xuICAgICAgICAgICAgY29uc3QgYWRyZXNzUGFydHMgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5zcGxpdCgnLyMvJyk7XG4gICAgICAgICAgICBsZXQgcmVkaXJlY3RVcmwgPSAnJztcblxuICAgICAgICAgICAgaWYgKGFkcmVzc1BhcnRzLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICByZWRpcmVjdFVybCA9IGFkcmVzc1BhcnRzWzFdO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5yZWRpcmVjdFRvTG9naW4ocmVkaXJlY3RVcmwpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLmFkZFRva2VuKHZhbHVlLmFjY2VzcywgdmFsdWUuYWNjZXNzRXhwaXJlc0luKTtcbiAgICAgICAgICAvLyB0aGlzLmFkZFJlZnJlc2hUb2tlbih2YWx1ZS5yZWZyZXNoLCB2YWx1ZS5yZWZyZXNoRXhwaXJlc0luKTtcbiAgICAgICAgICByZXNvbHZlKHZhbHVlKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKHJlYXNvbiA9PiB7XG4gICAgICAgICAgcmVqZWN0KHJlYXNvbik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4qIS9cblxuICBwdWJsaWMgZ2V0VG9rZW4oKSB7XG4gICAgcmV0dXJuIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5nZXQodGhpcy50b2tlbk5hbWUpO1xuICB9XG5cbi8hKlxuICBwdWJsaWMgZ2V0UmVmcmVzaFRva2VuKCkge1xuICAgIHJldHVybiB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZ2V0KHRoaXMucmVmcmVzaFRva2VuKTtcbiAgfVxuKiEvXG5cbiAgcHVibGljIGhhc1Rva2VuKCkge1xuICAgIHJldHVybiB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZXhpc3RzKHRoaXMudG9rZW5OYW1lKTtcbiAgfVxuXG4vISpcbiAgcHVibGljIGhhc1JlZnJlc2hUb2tlbigpIHtcbiAgICByZXR1cm4gdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLmV4aXN0cyh0aGlzLnJlZnJlc2hUb2tlbik7XG4gIH1cbiohL1xuXG4gIHJlbW92ZVRva2VuKCkge1xuICAgIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5yZW1vdmUodGhpcy50b2tlbk5hbWUpO1xuICAgIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5yZW1vdmUodGhpcy50b2tlbkV4cGlyZSk7XG4gICAgLy8gdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLnJlbW92ZSh0aGlzLnJlZnJlc2hUb2tlbik7XG4gICAgLy8gdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLnJlbW92ZSh0aGlzLnJlZnJlc2hUb2tlbkV4cGlyZSk7XG4gIH1cblxuICBjaGVja1Rva2VuKCkge1xuICAgIGlmICghdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLmV4aXN0cyh0aGlzLnRva2VuTmFtZSkgfHwgIXRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5leGlzdHModGhpcy50b2tlbkV4cGlyZSkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgYWNjZXNzVG9rZW4gPSB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZ2V0KHRoaXMudG9rZW5OYW1lKTtcbiAgICBjb25zdCBleHBpcmVzSW4gPSB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZ2V0KHRoaXMudG9rZW5FeHBpcmUpO1xuICAgIGNvbnN0IHRoaXNUaW1lID0gTnVtYmVyKG5ldyBEYXRlKCkuZ2V0VGltZSgpKTtcbiAgICBpZiAoTnVtYmVyKHRoaXNUaW1lKSA+IE51bWJlcihleHBpcmVzSW4pKSB7XG4gICAgICB0aGlzLnJlbW92ZVRva2VuKCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgbG9naW5DYWxsYmFja0NoZWNrKCkge1xuICAgIGNvbnN0IHRtcDEgPSB3aW5kb3cubG9jYXRpb24uaGFzaC5yZXBsYWNlKCcjJywgJycpLnNwbGl0KCcmJyk7XG4gICAgY29uc3QgaGFzaFBhcmFtcyA9IHRtcDEubWFwKHZhbHVlID0+IHtcbiAgICAgIGNvbnN0IHQgPSB2YWx1ZS5zcGxpdCgnPScpO1xuICAgICAgY29uc3QgbiA9IHRbMF07XG4gICAgICBjb25zdCB2ID0gdFsxXTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgICAgcmVzdWx0W25dID0gdjtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSk7XG5cbiAgICBjb25zdCB0bXAyID0gd2luZG93LmxvY2F0aW9uLnNlYXJjaC5yZXBsYWNlKCc/JywgJycpLnNwbGl0KCcmJyk7XG4gICAgY29uc3Qgc2VhcmNoUGFyYW1zID0gdG1wMi5tYXAodmFsdWUgPT4ge1xuICAgICAgY29uc3QgdCA9IHZhbHVlLnNwbGl0KCc9Jyk7XG4gICAgICBjb25zdCBuID0gdFswXTtcbiAgICAgIGNvbnN0IHYgPSB0WzFdO1xuICAgICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgICByZXN1bHRbbl0gPSB2O1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9KTtcblxuLyEqXG4gICAgY29uc3QgcmVmcmVzaFRva2VuID0gaGFzaFBhcmFtcy5maW5kKHZhbHVlID0+IHtcbiAgICAgIHJldHVybiB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgncmVmcmVzaCcpO1xuICAgIH0pO1xuKiEvXG5cbi8hKlxuICAgIGNvbnN0IHJlZnJlc2hUb2tlbkV4cGlyZXNJbiA9IGhhc2hQYXJhbXMuZmluZCh2YWx1ZSA9PiB7XG4gICAgICByZXR1cm4gdmFsdWUuaGFzT3duUHJvcGVydHkoJ3JlZnJlc2hfZXhwaXJlc19pbicpO1xuICAgIH0pO1xuKiEvXG5cbiAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IGhhc2hQYXJhbXMuZmluZCh2YWx1ZSA9PiB7XG4gICAgICByZXR1cm4gdmFsdWUuaGFzT3duUHJvcGVydHkoJ2FjY2Vzc190b2tlbicpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgZXhwaXJlc0luID0gaGFzaFBhcmFtcy5maW5kKHZhbHVlID0+IHtcbiAgICAgIHJldHVybiB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgnZXhwaXJlc19pbicpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgaHAgPSBzZWFyY2hQYXJhbXMuZmluZCh2YWx1ZSA9PiB7XG4gICAgICByZXR1cm4gdmFsdWUuaGFzT3duUHJvcGVydHkoJ2hwJyk7XG4gICAgfSk7XG5cbiAgICBpZiAoYWNjZXNzVG9rZW4gJiYgZXhwaXJlc0luKSB7XG4gICAgICBjb25zdCBjdXJyZW50VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgdGhpcy5hZGRUb2tlbihhY2Nlc3NUb2tlblsnYWNjZXNzX3Rva2VuJ10sIE51bWJlcihjdXJyZW50VGltZSkgKyAoTnVtYmVyKGV4cGlyZXNJblsnZXhwaXJlc19pbiddKSAqIDEwMDApKTtcbiAgICAgIC8vIHRoaXMuYWRkUmVmcmVzaFRva2VuKHJlZnJlc2hUb2tlblsncmVmcmVzaCddLCBOdW1iZXIoY3VycmVudFRpbWUpICsgKE51bWJlcihyZWZyZXNoVG9rZW5FeHBpcmVzSW5bJ3JlZnJlc2hfZXhwaXJlc19pbiddKSAqIDEwMDApKTtcbiAgICAgIHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsICcnKTtcblxuICAgICAgaWYgKGhwKSB7XG4gICAgICAgIHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsICcvIy8nICsgaHBbJ2hwJ10pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgJy8jL21haW4nKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBnZXRVc2VyTmFtZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMudGFtaW5SZXN0U2VydmljZS5nZXRBbGwodGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmdldFVzZXJOYW1lVXJsKVxuICAgICAgICAudGhlbigoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZShgJHtkYXRhLmRhdGEuZmlyc3ROYW1lfSAke2RhdGEuZGF0YS5sYXN0TmFtZX1gKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKHJlYXNvbiA9PiB7XG4gICAgICAgICAgcmVqZWN0KCcnKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBnZXRDdXJyZW50VXNlcigpOiBQcm9taXNlPGFueT4ge1xuICAgIHRoaXMuX2N1cnJlbnRVc2VyID0gbnVsbDtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnRhbWluUmVzdFNlcnZpY2UuZ2V0QWxsKHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5nZXRVc2VyTmFtZVVybClcbiAgICAgICAgLnRoZW4oKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICAgIHRoaXMuX2N1cnJlbnRVc2VyID0gZGF0YS5kYXRhO1xuICAgICAgICAgIHJlc29sdmUoZGF0YS5kYXRhKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKHJlYXNvbiA9PiB7XG4gICAgICAgICAgcmVqZWN0KHJlYXNvbik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSByZWRpcmVjdFRvTG9naW5XaXRoQ29yZG92YSgpIHtcbiAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJ2xvZ2luJ10pO1xuICAgIC8vIGNvbnN0IHVybCA9IFtcbiAgICAvLyAgIHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5hdXRoZW50aWNhdGlvbkVuZHBvaW50LFxuICAgIC8vICAgJz8nLFxuICAgIC8vICAgLy8gYHJlZGlyZWN0X3VyaT0ke3dpbmRvdy5sb2NhdGlvbi5ocmVmfWAsXG4gICAgLy8gICBgcmVkaXJlY3RfdXJpPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlZGlyZWN0VXJsfWAsXG4gICAgLy8gICAnJicsXG4gICAgLy8gICBgcmVzcG9uc2VfdHlwZT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZXNwb25zZVR5cGV9YCxcbiAgICAvLyAgICcmJyxcbiAgICAvLyAgIGBjbGllbnRfaWQ9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuY2xpZW50SWR9YFxuICAgIC8vIF0uam9pbignJyk7XG4gICAgLy9cbiAgICAvLyBTYWZhcmlWaWV3Q29udHJvbGxlci5pc0F2YWlsYWJsZShmdW5jdGlvbiAoYXZhaWxhYmxlKSB7XG4gICAgLy8gICBpZiAoYXZhaWxhYmxlKSB7XG4gICAgLy8gICAgIFNhZmFyaVZpZXdDb250cm9sbGVyLnNob3coXG4gICAgLy8gICAgICAge1xuICAgIC8vICAgICAgICAgdXJsOiB1cmxcbiAgICAvLyAgICAgICB9LFxuICAgIC8vICAgICAgIGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAvLyAgICAgICB9LFxuICAgIC8vICAgICAgIGZ1bmN0aW9uIChlcnJvcikge1xuICAgIC8vICAgICAgIH1cbiAgICAvLyAgICAgKTtcbiAgICAvLyAgIH1cbiAgICAvLyB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVkaXJlY3RUb0xvZ2luV2l0aEJyb3dzZXIodXJsID0gJycpIHtcbiAgICB0aGlzLnJlbW92ZVRva2VuKCk7XG4gICAgY29uc3QgYWRyZXNzUGFydHMgPSB1cmwgPT09ICcnID8gd2luZG93LmxvY2F0aW9uLmhyZWYuc3BsaXQoJy8jLycpIDogdXJsO1xuICAgIGxldCBocCA9ICcnO1xuICAgIGxldCByZXR1cm5VcmwgPSAnJztcblxuICAgIGlmIChhZHJlc3NQYXJ0cy5sZW5ndGggPT09IDEpIHtcbiAgICAgIHJldHVyblVybCA9IGFkcmVzc1BhcnRzWzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICBocCA9IGFkcmVzc1BhcnRzWzFdO1xuICAgICAgcmV0dXJuVXJsID0gYWRyZXNzUGFydHNbMF0gKyAnP2hwPScgKyBocDtcbiAgICB9XG5cbiAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IFtcbiAgICAgIHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5hdXRoZW50aWNhdGlvbkVuZHBvaW50LFxuICAgICAgJz8nLFxuICAgICAgYHJlZGlyZWN0X3VyaT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZWRpcmVjdFVybH1gLFxuICAgICAgJyYnLFxuICAgICAgYHJlc3BvbnNlX3R5cGU9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVzcG9uc2VUeXBlfWAsXG4gICAgICAnJicsXG4gICAgICBgY2xpZW50X2lkPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmNsaWVudElkfWBcbiAgICBdLmpvaW4oJycpO1xuICB9XG5cbiAgcmVkaXJlY3RUb0xvZ2luKHVybCA9ICcnKSB7XG4gICAgaWYgKHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgnY29yZG92YScpKSB7XG4gICAgICB0aGlzLnJlZGlyZWN0VG9Mb2dpbldpdGhDb3Jkb3ZhKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh1cmwgIT09ICcnKSB7XG4gICAgICAgIHRoaXMuYWRkUmVkaXJlY3RVcmwodXJsKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucmVkaXJlY3RUb0xvZ2luV2l0aEJyb3dzZXIodXJsKTtcbiAgICB9XG4gIH1cblxuICBnZXRMb2dpblVybCgpIHtcbiAgICBjb25zdCB0bXAgPSBbXG4gICAgICB0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuYXV0aGVudGljYXRpb25FbmRwb2ludCxcbiAgICAgICc/JyxcbiAgICAgIGByZWRpcmVjdF91cmk9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVkaXJlY3RVcmx9YCxcbiAgICAgICcmJyxcbiAgICAgIGByZXNwb25zZV90eXBlPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlc3BvbnNlVHlwZX1gLFxuICAgICAgJyYnLFxuICAgICAgYGNsaWVudF9pZD0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5jbGllbnRJZH1gXG4gICAgXS5qb2luKCcnKTtcbiAgICByZXR1cm4gdG1wO1xuICB9XG5cbiAgcmVkaXJlY3RUb0xvZ291dCgpIHtcbiAgICBpZiAod2luZG93Lmhhc093blByb3BlcnR5KCdjb3Jkb3ZhJykpIHtcbiAgICAgIHRoaXMucmVtb3ZlVG9rZW4oKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcmV0dXJuVXJsID0gdGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmJhc2VVcmw7XG4gICAgICB0aGlzLnJlbW92ZVRva2VuKCk7XG4gICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9XG4gICAgICAgIGAke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5sb2dvdXRVcmx9P3JlZGlyZWN0X3VyaT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZWRpcmVjdFVybH0mcmVzcG9uc2VfdHlwZT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZXNwb25zZVR5cGV9JmNsaWVudF9pZD0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5jbGllbnRJZH1gO1xuICAgIH1cbiAgfVxuXG4gIG1vYmlsZUxvZ2luKHVuLCBwdywgY2xpZW50SWQsIHNlY3VyaXR5KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5yZW1vdmVUb2tlbigpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0YW1pbkxvZ2luLmxvZ2luKHVuLCBwdywgdGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmF1dGhlbnRpY2F0aW9uRW5kcG9pbnQsIGNsaWVudElkLCBzZWN1cml0eSwgKHZhbHVlKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IEpTT04ucGFyc2UodmFsdWUpO1xuICAgICAgICBjb25zdCBjdXJyZW50VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICB0aGlzLmFkZFRva2VuKHJlc3VsdC5hY2Nlc3NfdG9rZW4sIE51bWJlcihjdXJyZW50VGltZSkgKyAoTnVtYmVyKHJlc3VsdC5leHBpcmVzX2luKSAqIDEwMDApKTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSwgKCkgPT4ge1xuICAgICAgICByZWplY3QoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgaGFzQWNjcmVzc1RvKHVybDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuaHR0cENsaWVudC5nZXQodXJsKVxuICAgICAgICAudG9Qcm9taXNlKClcbiAgICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICBpZiAoZXJyb3Iuc3RhdHVzID09PSA0MDEpIHtcbiAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cbiovXG4iXX0=