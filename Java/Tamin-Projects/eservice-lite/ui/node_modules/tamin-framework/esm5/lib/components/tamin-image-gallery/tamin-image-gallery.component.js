/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, Component, ElementRef, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { Subscription } from 'rxjs';
import { TaminLazyLoadService } from '../../services/tamin-lazy-load/tamin-lazy-load.service';
import { OverlayService } from '../../services/overlay/overlay.service';
import { isNullOrUndefined } from 'util';
import { Guid } from '../../helpers/guid';
import { PersianNumberPipe } from '../../pipes/persian-number.pipe';
/* In Cordova, we need to install the https://github.com/caixiangsap/filechooser.git */
var TaminImageGalleryComponent = /** @class */ (function () {
    function TaminImageGalleryComponent(taminLazyLoadService, changeDetectorRef, overlayService) {
        this.taminLazyLoadService = taminLazyLoadService;
        this.changeDetectorRef = changeDetectorRef;
        this.overlayService = overlayService;
        this.images = [];
        this.insertable = true;
        this.maxImageSize = 120;
        this.afterInsert = new EventEmitter();
        this.afterRemove = new EventEmitter();
        this.beforeInsert = new EventEmitter();
        this.beforeRemove = new EventEmitter();
        this._subscription = new Subscription();
    }
    /**
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @param {?} title
     * @param {?=} tag
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.selectImage = /**
     * @param {?} title
     * @param {?=} tag
     * @return {?}
     */
    function (title, tag) {
        if (tag === void 0) { tag = null; }
        /** @type {?} */
        var me = this;
        this.defaultTitle = title;
        this.defaultTag = tag;
        if (window.hasOwnProperty('cordova')) {
            this.checkPermission().then((/**
             * @param {?} value
             * @return {?}
             */
            function (value) {
                if (value) {
                    filechooser.open({ 'mime': 'image/*' }, (/**
                     * @param {?} data
                     * @return {?}
                     */
                    function (data) {
                        me.getBase64FromImageUrl(data.url);
                    }), (/**
                     * @param {?} reason
                     * @return {?}
                     */
                    function (reason) {
                        me.showAlert('پیام سیستم', 'خطا در بارگذاری فایل');
                    }));
                }
            })).catch((/**
             * @param {?} reason
             * @return {?}
             */
            function (reason) {
                me.showAlert('پیام سیستم', 'خطا در دسترسی به تصاویر ذخیره شده');
            }));
        }
        else {
            this.imageInput.nativeElement.click();
        }
    };
    /**
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var me = this;
        this.imageInput.nativeElement.addEventListener('change', (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (e.srcElement.files[0].size > me.maxImageSize * 1024) {
                /** @type {?} */
                var persianNumberPipe = new PersianNumberPipe();
                /** @type {?} */
                var message = persianNumberPipe.transform('اندازه فایل تصویر نمی تواند بیش از' + ' ' + me.maxImageSize.toString() + ' ' + 'کیلو بایت باشد.');
                me.showAlert('پیام سیستم', message);
                e.srcElement.value = '';
                return;
            }
            /** @type {?} */
            var reader = new FileReader();
            reader.readAsDataURL(e.srcElement.files[0]);
            reader.onload = (/**
             * @param {?} event
             * @return {?}
             */
            function (event) {
                /** @type {?} */
                var model = new ImageModel();
                model.source = ((/** @type {?} */ (event.target))).result;
                model.title = _this.defaultTitle;
                model.tag = _this.defaultTag;
                model.id = model.id = Guid.create().toString();
                if (!_this.images.find((/**
                 * @param {?} c
                 * @return {?}
                 */
                function (c) { return c.source === model.source; }))) {
                    _this.beforeInsert.emit();
                    me.images.push(model);
                    _this.afterInsert.emit(model);
                    _this.changeDetectorRef.detectChanges();
                    _this._gallery.update();
                    _this.imageInput.nativeElement.value = '';
                }
            });
        }));
        this._subscription.add(this.taminLazyLoadService.loadJs('assets/viewerjs/dist/viewer.js').subscribe((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            _this._subscription.add(_this.taminLazyLoadService.loadCss('assets/viewerjs/dist/viewer.css').subscribe((/**
             * @param {?} value1
             * @return {?}
             */
            function (value1) {
                _this._gallery = new Viewer(_this.imageContainer.nativeElement);
            })));
        })));
    };
    /**
     * @param {?} model
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.addImage = /**
     * @param {?} model
     * @return {?}
     */
    function (model) {
        if (isNullOrUndefined(model)) {
            alert('اطلاعات تصویر نادرست است.');
            return;
        }
        this.beforeInsert.emit(model);
        model.id = Guid.create().toString();
        this.images.push(model);
        this.afterInsert.emit(model);
        this.changeDetectorRef.detectChanges();
        this._gallery.update();
    };
    /**
     * @param {?} id
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.removeImage = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        var _this = this;
        this.showQuestionBox('پیام سیستم', 'آیا مطمئن هستید', (/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var model = _this.images.find((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.id === id; }));
            _this.beforeRemove.emit(model);
            _this.images = _this.images.filter((/**
             * @param {?} obj
             * @return {?}
             */
            function (obj) { return obj.id !== id; }));
            _this.changeDetectorRef.detectChanges();
            _this._gallery.update();
            _this.afterRemove.emit(model);
        }), (/**
         * @return {?}
         */
        function () {
        }));
    };
    /**
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.startWaiting = /**
     * @return {?}
     */
    function () {
        this._overlay = this.overlayService.show(this.host.nativeElement);
    };
    /**
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.stopWaiting = /**
     * @return {?}
     */
    function () {
        this.overlayService.hide(this._overlay);
    };
    /**
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.stopWaiting();
        this._subscription.unsubscribe();
    };
    /**
     * @private
     * @param {?} title
     * @param {?} message
     * @param {?} yesCallback
     * @param {?} noCallback
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.showQuestionBox = /**
     * @private
     * @param {?} title
     * @param {?} message
     * @param {?} yesCallback
     * @param {?} noCallback
     * @return {?}
     */
    function (title, message, yesCallback, noCallback) {
        alertify.confirm(title, message, yesCallback, noCallback)
            .set({
            labels: { ok: 'بلی', cancel: 'خیر' }
        });
    };
    /**
     * @private
     * @param {?} title
     * @param {?} message
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.showAlert = /**
     * @private
     * @param {?} title
     * @param {?} message
     * @return {?}
     */
    function (title, message) {
        alertify.alert(title, message);
    };
    /**
     * @param {?} url
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.getBase64FromImageUrl = /**
     * @param {?} url
     * @return {?}
     */
    function (url) {
        var _this = this;
        /** @type {?} */
        var me = this;
        /** @type {?} */
        var img = new Image();
        img.setAttribute('crossOrigin', 'anonymous');
        img.onload = (/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            /** @type {?} */
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            /** @type {?} */
            var dataURL = canvas.toDataURL('image/png');
            if (_this.dataURLtoBlob(dataURL).size > me.maxImageSize * 1024) {
                /** @type {?} */
                var persianNumberPipe = new PersianNumberPipe();
                /** @type {?} */
                var message = persianNumberPipe.transform('اندازه فایل تصویر نمی تواند بیش از' + ' ' + me.maxImageSize.toString() + ' ' + 'کیلو بایت باشد.');
                me.showAlert('پیام سیستم', message);
                return;
            }
            /** @type {?} */
            var model = new ImageModel();
            model.source = dataURL;
            model.title = _this.defaultTitle;
            model.tag = _this.defaultTag;
            model.id = model.id = Guid.create().toString();
            if (!_this.images.find((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.source === model.source; }))) {
                _this.beforeInsert.emit();
                me.images.push(model);
                _this.afterInsert.emit(model);
                _this.changeDetectorRef.detectChanges();
                _this._gallery.update();
                _this.imageInput.nativeElement.value = '';
            }
            // alert(dataURL.replace(/^data:image\/(png|jpg);base64,/, ''));
        });
        img.src = url;
    };
    /**
     * @param {?} dataURL
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.dataURLtoBlob = /**
     * @param {?} dataURL
     * @return {?}
     */
    function (dataURL) {
        /** @type {?} */
        var binary = atob(dataURL.split(',')[1]);
        // Create 8-bit unsigned array
        /** @type {?} */
        var array = [];
        for (var i = 0; i < binary.length; i++) {
            array.push(binary.charCodeAt(i));
        }
        return new Blob([new Uint8Array(array)], { type: 'image/png' });
    };
    /**
     * @return {?}
     */
    TaminImageGalleryComponent.prototype.checkPermission = /**
     * @return {?}
     */
    function () {
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) {
            // @ts-ignore
            /** @type {?} */
            var Permission = window.plugins.Permission;
            /** @type {?} */
            var permission = 'android.permission.WRITE_EXTERNAL_STORAGE';
            Permission.has(permission, (/**
             * @param {?} results
             * @return {?}
             */
            function (results) {
                if (!results[permission]) {
                    Permission.request(permission, (/**
                     * @param {?} result
                     * @return {?}
                     */
                    function (result) {
                        if (result[permission]) {
                            resolve(true);
                        }
                        else {
                            resolve(false);
                        }
                    }), (/**
                     * @param {?} reason
                     * @return {?}
                     */
                    function (reason) {
                        reject(reason);
                    }));
                }
                else {
                    resolve(true);
                }
            }), (/**
             * @param {?} reason
             * @return {?}
             */
            function (reason) {
                reject(reason);
            }));
        }));
    };
    TaminImageGalleryComponent.decorators = [
        { type: Component, args: [{
                    selector: 'tamin-image-gallery',
                    template: "<div #host>\n  <div class=\"image-container\" #imageContainer>\n    <ng-container *ngFor=\"let img of images\">\n\n      <div class=\"gallery-image-container\">\n        <div class=\"title\">{{img.title}}</div>\n        <img [attr.src]=\"img.source\" alt=\"\" class=\"img\">\n        <div class=\"footer\" *ngIf=\"img.removeable\">\n          <span><i class=\"icon-trash-empty remove\" (click)=\"removeImage(img.id)\"></i></span>\n        </div>\n      </div>\n    </ng-container>\n  </div>\n  <input type=\"file\" name=\"name\" style=\"display: none;\" accept=\".jpg,.jpeg\" #imageInput/>\n</div>\n",
                    styles: [".image-container{display:flex;flex-wrap:wrap;width:calc(100% - 10px);min-height:100px;border:1px solid #cacaca;margin:5px}.gallery-image-container{width:180px;margin:10px;border:1px solid #0b7dda;position:relative}.gallery-image-container .title{color:#fff;background-color:#0b7dda;width:100%;padding:3px;text-align:center}.gallery-image-container .img{padding:5px;width:100%;height:auto}.gallery-image-container .footer{color:#fff;background-color:#0b7dda;width:100%;padding:3px;text-align:center;position:absolute;bottom:0}.gallery-image-container .remove{cursor:pointer}"]
                }] }
    ];
    /** @nocollapse */
    TaminImageGalleryComponent.ctorParameters = function () { return [
        { type: TaminLazyLoadService },
        { type: ChangeDetectorRef },
        { type: OverlayService }
    ]; };
    TaminImageGalleryComponent.propDecorators = {
        imageContainer: [{ type: ViewChild, args: ['imageContainer',] }],
        imageInput: [{ type: ViewChild, args: ['imageInput',] }],
        host: [{ type: ViewChild, args: ['host',] }],
        insertable: [{ type: Input }],
        maxImageSize: [{ type: Input }],
        afterInsert: [{ type: Output }],
        afterRemove: [{ type: Output }],
        beforeInsert: [{ type: Output }],
        beforeRemove: [{ type: Output }]
    };
    return TaminImageGalleryComponent;
}());
export { TaminImageGalleryComponent };
if (false) {
    /** @type {?} */
    TaminImageGalleryComponent.prototype.imageContainer;
    /** @type {?} */
    TaminImageGalleryComponent.prototype.imageInput;
    /** @type {?} */
    TaminImageGalleryComponent.prototype.host;
    /** @type {?} */
    TaminImageGalleryComponent.prototype.images;
    /**
     * @type {?}
     * @private
     */
    TaminImageGalleryComponent.prototype._gallery;
    /** @type {?} */
    TaminImageGalleryComponent.prototype.insertable;
    /** @type {?} */
    TaminImageGalleryComponent.prototype.maxImageSize;
    /** @type {?} */
    TaminImageGalleryComponent.prototype.afterInsert;
    /** @type {?} */
    TaminImageGalleryComponent.prototype.afterRemove;
    /** @type {?} */
    TaminImageGalleryComponent.prototype.beforeInsert;
    /** @type {?} */
    TaminImageGalleryComponent.prototype.beforeRemove;
    /**
     * @type {?}
     * @private
     */
    TaminImageGalleryComponent.prototype._subscription;
    /**
     * @type {?}
     * @private
     */
    TaminImageGalleryComponent.prototype._overlay;
    /**
     * @type {?}
     * @private
     */
    TaminImageGalleryComponent.prototype.defaultTitle;
    /**
     * @type {?}
     * @private
     */
    TaminImageGalleryComponent.prototype.defaultTag;
    /**
     * @type {?}
     * @private
     */
    TaminImageGalleryComponent.prototype.taminLazyLoadService;
    /**
     * @type {?}
     * @private
     */
    TaminImageGalleryComponent.prototype.changeDetectorRef;
    /**
     * @type {?}
     * @private
     */
    TaminImageGalleryComponent.prototype.overlayService;
}
var ImageModel = /** @class */ (function () {
    function ImageModel() {
        this.removeable = true;
    }
    return ImageModel;
}());
export { ImageModel };
if (false) {
    /** @type {?} */
    ImageModel.prototype.source;
    /** @type {?} */
    ImageModel.prototype.id;
    /** @type {?} */
    ImageModel.prototype.tag;
    /** @type {?} */
    ImageModel.prototype.title;
    /** @type {?} */
    ImageModel.prototype.removeable;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFtaW4taW1hZ2UtZ2FsbGVyeS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly90YW1pbi1mcmFtZXdvcmsvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy90YW1pbi1pbWFnZS1nYWxsZXJ5L3RhbWluLWltYWdlLWdhbGxlcnkuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBRUwsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxVQUFVLEVBQ1YsWUFBWSxFQUNaLEtBQUssRUFHTCxNQUFNLEVBQ04sU0FBUyxFQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBQyxZQUFZLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDbEMsT0FBTyxFQUFDLG9CQUFvQixFQUFDLE1BQU0sd0RBQXdELENBQUM7QUFDNUYsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLHdDQUF3QyxDQUFDO0FBQ3RFLE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUN2QyxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFDeEMsT0FBTyxFQUFDLGlCQUFpQixFQUFDLE1BQU0saUNBQWlDLENBQUM7O0FBUWxFO0lBd0JFLG9DQUFvQixvQkFBMEMsRUFBVSxpQkFBb0MsRUFBVSxjQUE4QjtRQUFoSSx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQVUsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUFVLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQWJwSixXQUFNLEdBQXNCLEVBQUUsQ0FBQztRQUV0QixlQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLGlCQUFZLEdBQUcsR0FBRyxDQUFDO1FBQ2xCLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQWMsQ0FBQztRQUM3QyxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFjLENBQUM7UUFDN0MsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ2xD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SUFDNUIsaURBQXVEOztJQUN2RCxpREFBdUQ7O0lBQ3ZELGtEQUE0Qzs7SUFDNUMsa0RBQXdEOzs7OztJQUN4RCxtREFBMkM7Ozs7O0lBQzNDLDhDQUFzQjs7Ozs7SUFDdEIsa0RBQTZCOzs7OztJQUM3QixnREFBd0I7Ozs7O0lBRVosMERBQWtEOzs7OztJQUFFLHVEQUE0Qzs7Ozs7SUFBRSxvREFBc0M7O0FBNkx0SjtJQUFBO1FBS0UsZUFBVSxHQUFHLElBQUksQ0FBQztJQUNwQixDQUFDO0lBQUQsaUJBQUM7QUFBRCxDQUFDLEFBTkQsSUFNQzs7OztJQUxDLDRCQUFZOztJQUNaLHdCQUFXOztJQUNYLHlCQUFTOztJQUNULDJCQUFjOztJQUNkLGdDQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFmdGVyVmlld0luaXQsXG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFZpZXdDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7U3Vic2NyaXB0aW9ufSBmcm9tICdyeGpzJztcbmltcG9ydCB7VGFtaW5MYXp5TG9hZFNlcnZpY2V9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RhbWluLWxhenktbG9hZC90YW1pbi1sYXp5LWxvYWQuc2VydmljZSc7XG5pbXBvcnQge092ZXJsYXlTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9vdmVybGF5L292ZXJsYXkuc2VydmljZSc7XG5pbXBvcnQge2lzTnVsbE9yVW5kZWZpbmVkfSBmcm9tICd1dGlsJztcbmltcG9ydCB7R3VpZH0gZnJvbSAnLi4vLi4vaGVscGVycy9ndWlkJztcbmltcG9ydCB7UGVyc2lhbk51bWJlclBpcGV9IGZyb20gJy4uLy4uL3BpcGVzL3BlcnNpYW4tbnVtYmVyLnBpcGUnO1xuXG5kZWNsYXJlIHZhciBhbGVydGlmeTogYW55O1xuZGVjbGFyZSBsZXQgVmlld2VyOiBhbnk7XG5kZWNsYXJlIGxldCBmaWxlY2hvb3NlcjogYW55O1xuXG4vKiBJbiBDb3Jkb3ZhLCB3ZSBuZWVkIHRvIGluc3RhbGwgdGhlIGh0dHBzOi8vZ2l0aHViLmNvbS9jYWl4aWFuZ3NhcC9maWxlY2hvb3Nlci5naXQgKi9cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAndGFtaW4taW1hZ2UtZ2FsbGVyeScsXG4gIHRlbXBsYXRlVXJsOiAnLi90YW1pbi1pbWFnZS1nYWxsZXJ5LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vdGFtaW4taW1hZ2UtZ2FsbGVyeS5jb21wb25lbnQuc2NzcyddXG59KVxuXG5leHBvcnQgY2xhc3MgVGFtaW5JbWFnZUdhbGxlcnlDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XG5cbiAgQFZpZXdDaGlsZCgnaW1hZ2VDb250YWluZXInKSBpbWFnZUNvbnRhaW5lcjogRWxlbWVudFJlZjtcbiAgQFZpZXdDaGlsZCgnaW1hZ2VJbnB1dCcpIGltYWdlSW5wdXQ6IEVsZW1lbnRSZWY7XG4gIEBWaWV3Q2hpbGQoJ2hvc3QnKSBob3N0OiBFbGVtZW50UmVmO1xuICBpbWFnZXM6IEFycmF5PEltYWdlTW9kZWw+ID0gW107XG4gIHByaXZhdGUgX2dhbGxlcnk6IGFueTtcbiAgQElucHV0KCkgaW5zZXJ0YWJsZSA9IHRydWU7XG4gIEBJbnB1dCgpIG1heEltYWdlU2l6ZSA9IDEyMDtcbiAgQE91dHB1dCgpIGFmdGVySW5zZXJ0ID0gbmV3IEV2ZW50RW1pdHRlcjxJbWFnZU1vZGVsPigpO1xuICBAT3V0cHV0KCkgYWZ0ZXJSZW1vdmUgPSBuZXcgRXZlbnRFbWl0dGVyPEltYWdlTW9kZWw+KCk7XG4gIEBPdXRwdXQoKSBiZWZvcmVJbnNlcnQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBiZWZvcmVSZW1vdmUgPSBuZXcgRXZlbnRFbWl0dGVyPEltYWdlTW9kZWw+KCk7XG4gIHByaXZhdGUgX3N1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcbiAgcHJpdmF0ZSBfb3ZlcmxheTogYW55O1xuICBwcml2YXRlIGRlZmF1bHRUaXRsZTogc3RyaW5nO1xuICBwcml2YXRlIGRlZmF1bHRUYWc6IGFueTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRhbWluTGF6eUxvYWRTZXJ2aWNlOiBUYW1pbkxhenlMb2FkU2VydmljZSwgcHJpdmF0ZSBjaGFuZ2VEZXRlY3RvclJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsIHByaXZhdGUgb3ZlcmxheVNlcnZpY2U6IE92ZXJsYXlTZXJ2aWNlKSB7XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgfVxuXG4gIHNlbGVjdEltYWdlKHRpdGxlLCB0YWc6IGFueSA9IG51bGwpIHtcbiAgICBjb25zdCBtZSA9IHRoaXM7XG4gICAgdGhpcy5kZWZhdWx0VGl0bGUgPSB0aXRsZTtcbiAgICB0aGlzLmRlZmF1bHRUYWcgPSB0YWc7XG4gICAgaWYgKHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgnY29yZG92YScpKSB7XG4gICAgICB0aGlzLmNoZWNrUGVybWlzc2lvbigpLnRoZW4odmFsdWUgPT4ge1xuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICBmaWxlY2hvb3Nlci5vcGVuKHsnbWltZSc6ICdpbWFnZS8qJ30sXG4gICAgICAgICAgICAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgICBtZS5nZXRCYXNlNjRGcm9tSW1hZ2VVcmwoZGF0YS51cmwpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIChyZWFzb24pID0+IHtcbiAgICAgICAgICAgICAgbWUuc2hvd0FsZXJ0KCfZvtuM2KfZhSDYs9uM2LPYqtmFJywgJ9iu2LfYpyDYr9ixINio2KfYsdqv2LDYp9ix24wg2YHYp9uM2YQnKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChyZWFzb24gPT4ge1xuICAgICAgICBtZS5zaG93QWxlcnQoJ9m+24zYp9mFINiz24zYs9iq2YUnLCAn2K7Yt9inINiv2LEg2K/Ys9iq2LHYs9uMINio2Ycg2KrYtdin2YjbjNixINiw2K7bjNix2Ycg2LTYr9mHJyk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5pbWFnZUlucHV0Lm5hdGl2ZUVsZW1lbnQuY2xpY2soKTtcbiAgICB9XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgY29uc3QgbWUgPSB0aGlzO1xuICAgIHRoaXMuaW1hZ2VJbnB1dC5uYXRpdmVFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7XG4gICAgICBpZiAoZS5zcmNFbGVtZW50LmZpbGVzWzBdLnNpemUgPiBtZS5tYXhJbWFnZVNpemUgKiAxMDI0KSB7XG4gICAgICAgIGNvbnN0IHBlcnNpYW5OdW1iZXJQaXBlID0gbmV3IFBlcnNpYW5OdW1iZXJQaXBlKCk7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBwZXJzaWFuTnVtYmVyUGlwZS50cmFuc2Zvcm0oJ9in2YbYr9in2LLZhyDZgdin24zZhCDYqti12YjbjNixINmG2YXbjCDYqtmI2KfZhtivINio24zYtCDYp9iyJyArICcgJyArIG1lLm1heEltYWdlU2l6ZS50b1N0cmluZygpICsgJyAnICsgJ9qp24zZhNmIINio2KfbjNiqINio2KfYtNivLicpO1xuICAgICAgICBtZS5zaG93QWxlcnQoJ9m+24zYp9mFINiz24zYs9iq2YUnLCBtZXNzYWdlKTtcbiAgICAgICAgZS5zcmNFbGVtZW50LnZhbHVlID0gJyc7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKGUuc3JjRWxlbWVudC5maWxlc1swXSk7XG4gICAgICByZWFkZXIub25sb2FkID0gKGV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IG1vZGVsID0gbmV3IEltYWdlTW9kZWwoKTtcbiAgICAgICAgbW9kZWwuc291cmNlID0gKDxhbnk+ZXZlbnQudGFyZ2V0KS5yZXN1bHQ7XG4gICAgICAgIG1vZGVsLnRpdGxlID0gdGhpcy5kZWZhdWx0VGl0bGU7XG4gICAgICAgIG1vZGVsLnRhZyA9IHRoaXMuZGVmYXVsdFRhZztcbiAgICAgICAgbW9kZWwuaWQgPSBtb2RlbC5pZCA9IEd1aWQuY3JlYXRlKCkudG9TdHJpbmcoKTtcbiAgICAgICAgaWYgKCF0aGlzLmltYWdlcy5maW5kKGMgPT4gYy5zb3VyY2UgPT09IG1vZGVsLnNvdXJjZSkpIHtcbiAgICAgICAgICB0aGlzLmJlZm9yZUluc2VydC5lbWl0KCk7XG4gICAgICAgICAgbWUuaW1hZ2VzLnB1c2gobW9kZWwpO1xuICAgICAgICAgIHRoaXMuYWZ0ZXJJbnNlcnQuZW1pdChtb2RlbCk7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICAgICAgdGhpcy5fZ2FsbGVyeS51cGRhdGUoKTtcbiAgICAgICAgICB0aGlzLmltYWdlSW5wdXQubmF0aXZlRWxlbWVudC52YWx1ZSA9ICcnO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0pO1xuXG4gICAgdGhpcy5fc3Vic2NyaXB0aW9uLmFkZCh0aGlzLnRhbWluTGF6eUxvYWRTZXJ2aWNlLmxvYWRKcygnYXNzZXRzL3ZpZXdlcmpzL2Rpc3Qvdmlld2VyLmpzJykuc3Vic2NyaWJlKHZhbHVlID0+IHtcbiAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9uLmFkZChcbiAgICAgICAgICB0aGlzLnRhbWluTGF6eUxvYWRTZXJ2aWNlLmxvYWRDc3MoJ2Fzc2V0cy92aWV3ZXJqcy9kaXN0L3ZpZXdlci5jc3MnKS5zdWJzY3JpYmUodmFsdWUxID0+IHtcbiAgICAgICAgICAgIHRoaXMuX2dhbGxlcnkgPSBuZXcgVmlld2VyKHRoaXMuaW1hZ2VDb250YWluZXIubmF0aXZlRWxlbWVudCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGFkZEltYWdlKG1vZGVsOiBJbWFnZU1vZGVsKSB7XG4gICAgaWYgKGlzTnVsbE9yVW5kZWZpbmVkKG1vZGVsKSkge1xuICAgICAgYWxlcnQoJ9in2LfZhNin2LnYp9iqINiq2LXZiNuM2LEg2YbYp9iv2LHYs9iqINin2LPYqi4nKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5iZWZvcmVJbnNlcnQuZW1pdChtb2RlbCk7XG4gICAgbW9kZWwuaWQgPSBHdWlkLmNyZWF0ZSgpLnRvU3RyaW5nKCk7XG4gICAgdGhpcy5pbWFnZXMucHVzaChtb2RlbCk7XG4gICAgdGhpcy5hZnRlckluc2VydC5lbWl0KG1vZGVsKTtcbiAgICB0aGlzLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICB0aGlzLl9nYWxsZXJ5LnVwZGF0ZSgpO1xuICB9XG5cbiAgcmVtb3ZlSW1hZ2UoaWQ6IHN0cmluZykge1xuICAgIHRoaXMuc2hvd1F1ZXN0aW9uQm94KCfZvtuM2KfZhSDYs9uM2LPYqtmFJywgJ9ii24zYpyDZhdi32YXYptmGINmH2LPYqtuM2K8nLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2RlbCA9IHRoaXMuaW1hZ2VzLmZpbmQoYyA9PiBjLmlkID09PSBpZCk7XG4gICAgICB0aGlzLmJlZm9yZVJlbW92ZS5lbWl0KG1vZGVsKTtcbiAgICAgIHRoaXMuaW1hZ2VzID0gdGhpcy5pbWFnZXMuZmlsdGVyKG9iaiA9PiBvYmouaWQgIT09IGlkKTtcbiAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgdGhpcy5fZ2FsbGVyeS51cGRhdGUoKTtcbiAgICAgIHRoaXMuYWZ0ZXJSZW1vdmUuZW1pdChtb2RlbCk7XG4gICAgfSwgKCkgPT4ge1xuICAgIH0pO1xuICB9XG5cbiAgc3RhcnRXYWl0aW5nKCkge1xuICAgIHRoaXMuX292ZXJsYXkgPSB0aGlzLm92ZXJsYXlTZXJ2aWNlLnNob3codGhpcy5ob3N0Lm5hdGl2ZUVsZW1lbnQpO1xuICB9XG5cbiAgc3RvcFdhaXRpbmcoKSB7XG4gICAgdGhpcy5vdmVybGF5U2VydmljZS5oaWRlKHRoaXMuX292ZXJsYXkpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5zdG9wV2FpdGluZygpO1xuICAgIHRoaXMuX3N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzaG93UXVlc3Rpb25Cb3godGl0bGU6IHN0cmluZywgbWVzc2FnZTogc3RyaW5nLCB5ZXNDYWxsYmFjazogRnVuY3Rpb24sIG5vQ2FsbGJhY2s6IEZ1bmN0aW9uKSB7XG4gICAgYWxlcnRpZnkuY29uZmlybSh0aXRsZSwgbWVzc2FnZSwgeWVzQ2FsbGJhY2ssIG5vQ2FsbGJhY2spXG4gICAgICAuc2V0KHtcbiAgICAgICAgbGFiZWxzOiB7b2s6ICfYqNmE24wnLCBjYW5jZWw6ICfYrtuM2LEnfVxuICAgICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHNob3dBbGVydCh0aXRsZTogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICBhbGVydGlmeS5hbGVydCh0aXRsZSwgbWVzc2FnZSk7XG4gIH1cblxuICBnZXRCYXNlNjRGcm9tSW1hZ2VVcmwodXJsKSB7XG4gICAgY29uc3QgbWUgPSB0aGlzO1xuICAgIGNvbnN0IGltZyA9IG5ldyBJbWFnZSgpO1xuICAgIGltZy5zZXRBdHRyaWJ1dGUoJ2Nyb3NzT3JpZ2luJywgJ2Fub255bW91cycpO1xuICAgIGltZy5vbmxvYWQgPSAoKSA9PiB7XG4gICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgIGNhbnZhcy53aWR0aCA9IGltZy53aWR0aDtcbiAgICAgIGNhbnZhcy5oZWlnaHQgPSBpbWcuaGVpZ2h0O1xuICAgICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7XG4gICAgICBjdHguZHJhd0ltYWdlKGltZywgMCwgMCk7XG4gICAgICBjb25zdCBkYXRhVVJMID0gY2FudmFzLnRvRGF0YVVSTCgnaW1hZ2UvcG5nJyk7XG4gICAgICBpZiAodGhpcy5kYXRhVVJMdG9CbG9iKGRhdGFVUkwpLnNpemUgPiBtZS5tYXhJbWFnZVNpemUgKiAxMDI0KSB7XG4gICAgICAgIGNvbnN0IHBlcnNpYW5OdW1iZXJQaXBlID0gbmV3IFBlcnNpYW5OdW1iZXJQaXBlKCk7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBwZXJzaWFuTnVtYmVyUGlwZS50cmFuc2Zvcm0oJ9in2YbYr9in2LLZhyDZgdin24zZhCDYqti12YjbjNixINmG2YXbjCDYqtmI2KfZhtivINio24zYtCDYp9iyJyArICcgJyArIG1lLm1heEltYWdlU2l6ZS50b1N0cmluZygpICsgJyAnICsgJ9qp24zZhNmIINio2KfbjNiqINio2KfYtNivLicpO1xuICAgICAgICBtZS5zaG93QWxlcnQoJ9m+24zYp9mFINiz24zYs9iq2YUnLCBtZXNzYWdlKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgbW9kZWwgPSBuZXcgSW1hZ2VNb2RlbCgpO1xuICAgICAgbW9kZWwuc291cmNlID0gZGF0YVVSTDtcbiAgICAgIG1vZGVsLnRpdGxlID0gdGhpcy5kZWZhdWx0VGl0bGU7XG4gICAgICBtb2RlbC50YWcgPSB0aGlzLmRlZmF1bHRUYWc7XG4gICAgICBtb2RlbC5pZCA9IG1vZGVsLmlkID0gR3VpZC5jcmVhdGUoKS50b1N0cmluZygpO1xuICAgICAgaWYgKCF0aGlzLmltYWdlcy5maW5kKGMgPT4gYy5zb3VyY2UgPT09IG1vZGVsLnNvdXJjZSkpIHtcbiAgICAgICAgdGhpcy5iZWZvcmVJbnNlcnQuZW1pdCgpO1xuICAgICAgICBtZS5pbWFnZXMucHVzaChtb2RlbCk7XG4gICAgICAgIHRoaXMuYWZ0ZXJJbnNlcnQuZW1pdChtb2RlbCk7XG4gICAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgICB0aGlzLl9nYWxsZXJ5LnVwZGF0ZSgpO1xuICAgICAgICB0aGlzLmltYWdlSW5wdXQubmF0aXZlRWxlbWVudC52YWx1ZSA9ICcnO1xuICAgICAgfVxuICAgICAgLy8gYWxlcnQoZGF0YVVSTC5yZXBsYWNlKC9eZGF0YTppbWFnZVxcLyhwbmd8anBnKTtiYXNlNjQsLywgJycpKTtcbiAgICB9O1xuICAgIGltZy5zcmMgPSB1cmw7XG4gIH1cblxuICBkYXRhVVJMdG9CbG9iKGRhdGFVUkwpIHtcbiAgICBjb25zdCBiaW5hcnkgPSBhdG9iKGRhdGFVUkwuc3BsaXQoJywnKVsxXSk7XG4gICAgLy8gQ3JlYXRlIDgtYml0IHVuc2lnbmVkIGFycmF5XG4gICAgY29uc3QgYXJyYXkgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGJpbmFyeS5sZW5ndGg7IGkrKykge1xuICAgICAgYXJyYXkucHVzaChiaW5hcnkuY2hhckNvZGVBdChpKSk7XG4gICAgfVxuICAgIHJldHVybiBuZXcgQmxvYihbbmV3IFVpbnQ4QXJyYXkoYXJyYXkpXSwge3R5cGU6ICdpbWFnZS9wbmcnfSk7XG4gIH1cblxuICBjaGVja1Blcm1pc3Npb24oKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIGNvbnN0IFBlcm1pc3Npb24gPSB3aW5kb3cucGx1Z2lucy5QZXJtaXNzaW9uO1xuICAgICAgY29uc3QgcGVybWlzc2lvbiA9ICdhbmRyb2lkLnBlcm1pc3Npb24uV1JJVEVfRVhURVJOQUxfU1RPUkFHRSc7XG4gICAgICBQZXJtaXNzaW9uLmhhcyhwZXJtaXNzaW9uLCAocmVzdWx0cykgPT4ge1xuICAgICAgICBpZiAoIXJlc3VsdHNbcGVybWlzc2lvbl0pIHtcbiAgICAgICAgICBQZXJtaXNzaW9uLnJlcXVlc3QocGVybWlzc2lvbiwgKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3VsdFtwZXJtaXNzaW9uXSkge1xuICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZShmYWxzZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSwgKHJlYXNvbikgPT4ge1xuICAgICAgICAgICAgcmVqZWN0KHJlYXNvbik7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfVxuICAgICAgfSwgKHJlYXNvbikgPT4ge1xuICAgICAgICByZWplY3QocmVhc29uKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBJbWFnZU1vZGVsIHtcbiAgc291cmNlOiBhbnk7XG4gIGlkOiBzdHJpbmc7XG4gIHRhZzogYW55O1xuICB0aXRsZTogc3RyaW5nO1xuICByZW1vdmVhYmxlID0gdHJ1ZTtcbn1cbiJdfQ==