/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Inject, Injectable } from '@angular/core';
import { HttpClient } from '@angular/common/http';
import { Router } from '@angular/router';
import { TaminRestService } from '../tamin-rest-service/tamin-rest.service';
import { TaminStorageService } from '../tamin-storage/tamin-storage.service';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "../tamin-rest-service/tamin-rest.service";
import * as i3 from "../tamin-storage/tamin-storage.service";
import * as i4 from "@angular/common/http";
var TaminSecurityService = /** @class */ (function () {
    function TaminSecurityService(taminApplicationConfig, router, taminRestService, taminStorageService, httpClient) {
        this.taminApplicationConfig = taminApplicationConfig;
        this.router = router;
        this.taminRestService = taminRestService;
        this.taminStorageService = taminStorageService;
        this.httpClient = httpClient;
        this._currentUser = null;
        this.tokenName = 'access_token';
        this.tokenExpire = 'expires_in';
        this.redirectUrl = 'redirect_url';
        // debugger;
    }
    Object.defineProperty(TaminSecurityService.prototype, "currentUser", {
        get: /**
         * @return {?}
         */
        function () {
            return this._currentUser;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @param {?} url
     * @return {?}
     */
    TaminSecurityService.prototype.addRedirectUrl = /**
     * @private
     * @param {?} url
     * @return {?}
     */
    function (url) {
        this.taminStorageService.set(this.redirectUrl, url);
    };
    /**
     * @return {?}
     */
    TaminSecurityService.prototype.getRedirectUrl = /**
     * @return {?}
     */
    function () {
        return this.taminStorageService.get(this.redirectUrl);
    };
    /**
     * @return {?}
     */
    TaminSecurityService.prototype.removeRedirectUrl = /**
     * @return {?}
     */
    function () {
        this.taminStorageService.remove(this.redirectUrl);
    };
    /**
     * @private
     * @param {?} token
     * @param {?} expireIn
     * @return {?}
     */
    TaminSecurityService.prototype.addToken = /**
     * @private
     * @param {?} token
     * @param {?} expireIn
     * @return {?}
     */
    function (token, expireIn) {
        this.taminStorageService.set(this.tokenName, token);
        this.taminStorageService.set(this.tokenExpire, expireIn);
    };
    /**
     * @return {?}
     */
    TaminSecurityService.prototype.getToken = /**
     * @return {?}
     */
    function () {
        return this.taminStorageService.get(this.tokenName);
    };
    /**
     * @return {?}
     */
    TaminSecurityService.prototype.hasToken = /**
     * @return {?}
     */
    function () {
        return this.taminStorageService.exists(this.tokenName);
    };
    /**
     * @return {?}
     */
    TaminSecurityService.prototype.removeToken = /**
     * @return {?}
     */
    function () {
        this.taminStorageService.remove(this.tokenName);
        this.taminStorageService.remove(this.tokenExpire);
    };
    /**
     * @return {?}
     */
    TaminSecurityService.prototype.checkToken = /**
     * @return {?}
     */
    function () {
        if (!this.taminStorageService.exists(this.tokenName) || !this.taminStorageService.exists(this.tokenExpire)) {
            return false;
        }
        /** @type {?} */
        var accessToken = this.taminStorageService.get(this.tokenName);
        /** @type {?} */
        var expiresIn = this.taminStorageService.get(this.tokenExpire);
        /** @type {?} */
        var thisTime = Number(new Date().getTime());
        if (Number(thisTime) > Number(expiresIn)) {
            this.removeToken();
            return false;
        }
        return true;
    };
    /**
     * @return {?}
     */
    TaminSecurityService.prototype.loginCallbackCheck = /**
     * @return {?}
     */
    function () {
        // debugger;
        /** @type {?} */
        var tmp1 = window.location.hash.replace('#', '').split('&');
        /** @type {?} */
        var hashParams = tmp1.map((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            /** @type {?} */
            var t = value.split('=');
            /** @type {?} */
            var n = t[0];
            /** @type {?} */
            var v = t[1];
            /** @type {?} */
            var result = {};
            result[n] = v;
            return result;
        }));
        /** @type {?} */
        var tmp2 = window.location.search.replace('?', '').split('&');
        /** @type {?} */
        var searchParams = tmp2.map((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            /** @type {?} */
            var t = value.split('=');
            /** @type {?} */
            var n = t[0];
            /** @type {?} */
            var v = t[1];
            /** @type {?} */
            var result = {};
            result[n] = v;
            return result;
        }));
        /** @type {?} */
        var accessToken = hashParams.find((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            return value.hasOwnProperty('access_token');
        }));
        /** @type {?} */
        var expiresIn = hashParams.find((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            return value.hasOwnProperty('expires_in');
        }));
        /** @type {?} */
        var hp = searchParams.find((/**
         * @param {?} value
         * @return {?}
         */
        function (value) {
            return value.hasOwnProperty('hp');
        }));
        if (accessToken && expiresIn) {
            /** @type {?} */
            var currentTime = new Date().getTime();
            this.addToken(accessToken['access_token'], Number(currentTime) + (Number(expiresIn['expires_in']) * 1000));
            window.history.replaceState({}, document.title, '');
            if (hp) {
                window.history.replaceState({}, document.title, '/#/' + hp['hp']);
            }
            else {
                window.history.replaceState({}, document.title, '/#/main');
            }
        }
    };
    /**
     * @return {?}
     */
    TaminSecurityService.prototype.getUserName = /**
     * @return {?}
     */
    function () {
        var _this = this;
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) {
            _this.taminRestService.getAll(_this.taminApplicationConfig.getUserNameUrl)
                .then((/**
             * @param {?} data
             * @return {?}
             */
            function (data) {
                resolve(data.data.firstName + " " + data.data.lastName);
            }))
                .catch((/**
             * @param {?} reason
             * @return {?}
             */
            function (reason) {
                reject('');
            }));
        }));
    };
    /**
     * @return {?}
     */
    TaminSecurityService.prototype.getCurrentUser = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this._currentUser = null;
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) {
            _this.taminRestService.getAll(_this.taminApplicationConfig.getUserNameUrl)
                .then((/**
             * @param {?} data
             * @return {?}
             */
            function (data) {
                _this._currentUser = data.data;
                resolve(data.data);
            }))
                .catch((/**
             * @param {?} reason
             * @return {?}
             */
            function (reason) {
                reject(reason);
            }));
        }));
    };
    /**
     * @private
     * @return {?}
     */
    TaminSecurityService.prototype.redirectToLoginWithCordova = /**
     * @private
     * @return {?}
     */
    function () {
        this.router.navigate(['login']);
        // const url = [
        //   this.taminApplicationConfig.authenticationEndpoint,
        //   '?',
        //   // `redirect_uri=${window.location.href}`,
        //   `redirect_uri=${this.taminApplicationConfig.redirectUrl}`,
        //   '&',
        //   `response_type=${this.taminApplicationConfig.responseType}`,
        //   '&',
        //   `client_id=${this.taminApplicationConfig.clientId}`
        // ].join('');
        //
        // SafariViewController.isAvailable(function (available) {
        //   if (available) {
        //     SafariViewController.show(
        //       {
        //         url: url
        //       },
        //       function (result) {
        //       },
        //       function (error) {
        //       }
        //     );
        //   }
        // });
    };
    /**
     * @private
     * @param {?=} url
     * @return {?}
     */
    TaminSecurityService.prototype.redirectToLoginWithBrowser = /**
     * @private
     * @param {?=} url
     * @return {?}
     */
    function (url) {
        if (url === void 0) { url = ''; }
        this.removeToken();
        /** @type {?} */
        var adressParts = url === '' ? window.location.href.split('/#/') : url;
        /** @type {?} */
        var hp = '';
        /** @type {?} */
        var returnUrl = '';
        if (adressParts.length === 1) {
            returnUrl = adressParts[0];
        }
        else {
            hp = adressParts[1];
            returnUrl = adressParts[0] + '?hp=' + hp;
        }
        window.location.href = [
            this.taminApplicationConfig.authenticationEndpoint,
            '?',
            "redirect_uri=" + this.taminApplicationConfig.redirectUrl,
            '&',
            "response_type=" + this.taminApplicationConfig.responseType,
            '&',
            "client_id=" + this.taminApplicationConfig.clientId
        ].join('');
    };
    /**
     * @param {?=} url
     * @return {?}
     */
    TaminSecurityService.prototype.redirectToLogin = /**
     * @param {?=} url
     * @return {?}
     */
    function (url) {
        if (url === void 0) { url = ''; }
        if (window.hasOwnProperty('cordova')) {
            this.redirectToLoginWithCordova();
        }
        else {
            if (url !== '') {
                this.addRedirectUrl(url);
            }
            this.redirectToLoginWithBrowser(url);
        }
    };
    /**
     * @return {?}
     */
    TaminSecurityService.prototype.getLoginUrl = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var tmp = [
            this.taminApplicationConfig.authenticationEndpoint,
            '?',
            "redirect_uri=" + this.taminApplicationConfig.redirectUrl,
            '&',
            "response_type=" + this.taminApplicationConfig.responseType,
            '&',
            "client_id=" + this.taminApplicationConfig.clientId
        ].join('');
        return tmp;
    };
    /**
     * @return {?}
     */
    TaminSecurityService.prototype.redirectToLogout = /**
     * @return {?}
     */
    function () {
        if (window.hasOwnProperty('cordova')) {
            this.removeToken();
        }
        else {
            /** @type {?} */
            var returnUrl = this.taminApplicationConfig.baseUrl;
            this.removeToken();
            window.location.href =
                this.taminApplicationConfig.logoutUrl + "?redirect_uri=" + this.taminApplicationConfig.redirectUrl + "&response_type=" + this.taminApplicationConfig.responseType + "&client_id=" + this.taminApplicationConfig.clientId;
        }
    };
    /**
     * @param {?} un
     * @param {?} pw
     * @param {?} clientId
     * @param {?} security
     * @return {?}
     */
    TaminSecurityService.prototype.mobileLogin = /**
     * @param {?} un
     * @param {?} pw
     * @param {?} clientId
     * @param {?} security
     * @return {?}
     */
    function (un, pw, clientId, security) {
        var _this = this;
        this.removeToken();
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) {
            taminLogin.login(un, pw, _this.taminApplicationConfig.authenticationEndpoint, clientId, security, (/**
             * @param {?} value
             * @return {?}
             */
            function (value) {
                /** @type {?} */
                var result = JSON.parse(value);
                /** @type {?} */
                var currentTime = new Date().getTime();
                _this.addToken(result.access_token, Number(currentTime) + (Number(result.expires_in) * 1000));
                resolve();
            }), (/**
             * @return {?}
             */
            function () {
                reject();
            }));
        }));
    };
    /**
     * @param {?} url
     * @return {?}
     */
    TaminSecurityService.prototype.hasAccressTo = /**
     * @param {?} url
     * @return {?}
     */
    function (url) {
        var _this = this;
        return new Promise((/**
         * @param {?} resolve
         * @param {?} reject
         * @return {?}
         */
        function (resolve, reject) {
            _this.httpClient.get(url)
                .toPromise()
                .then((/**
             * @param {?} data
             * @return {?}
             */
            function (data) {
                resolve(true);
            }))
                .catch((/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                if (error.status === 401) {
                    resolve(false);
                }
            }));
        }));
    };
    TaminSecurityService.decorators = [
        { type: Injectable, args: [{ providedIn: 'root' },] }
    ];
    /** @nocollapse */
    TaminSecurityService.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: ['taminApplicationConfig',] }] },
        { type: Router },
        { type: TaminRestService },
        { type: TaminStorageService },
        { type: HttpClient }
    ]; };
    /** @nocollapse */ TaminSecurityService.ngInjectableDef = i0.defineInjectable({ factory: function TaminSecurityService_Factory() { return new TaminSecurityService(i0.inject("taminApplicationConfig"), i0.inject(i1.Router), i0.inject(i2.TaminRestService), i0.inject(i3.TaminStorageService), i0.inject(i4.HttpClient)); }, token: TaminSecurityService, providedIn: "root" });
    return TaminSecurityService;
}());
export { TaminSecurityService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype._currentUser;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.tokenName;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.tokenExpire;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.redirectUrl;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.taminApplicationConfig;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.router;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.taminRestService;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.taminStorageService;
    /**
     * @type {?}
     * @private
     */
    TaminSecurityService.prototype.httpClient;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFtaW4tc2VjdXJpdHkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL3RhbWluLWZyYW1ld29yay8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy90YW1pbi1zZWN1cml0eS90YW1pbi1zZWN1cml0eS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUMsTUFBTSxFQUFFLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUMsVUFBVSxFQUFvQixNQUFNLHNCQUFzQixDQUFDO0FBRW5FLE9BQU8sRUFBQyxNQUFNLEVBQUMsTUFBTSxpQkFBaUIsQ0FBQztBQUN2QyxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsTUFBTSwwQ0FBMEMsQ0FBQztBQUMxRSxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSx3Q0FBd0MsQ0FBQzs7Ozs7O0FBSTNFO0lBT0UsOEJBRVUsc0JBQStDLEVBQy9DLE1BQWMsRUFDZCxnQkFBa0MsRUFDbEMsbUJBQXdDLEVBQ3hDLFVBQXNCO1FBSnRCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBeUI7UUFDL0MsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4QyxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBWHhCLGlCQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLGNBQVMsR0FBRyxjQUFjLENBQUM7UUFDM0IsZ0JBQVcsR0FBRyxZQUFZLENBQUM7UUFDM0IsZ0JBQVcsR0FBRyxjQUFjLENBQUM7UUFTbkMsWUFBWTtJQUNkLENBQUM7SUFFRCxzQkFBSSw2Q0FBVzs7OztRQUFmO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDO1FBQzNCLENBQUM7OztPQUFBOzs7Ozs7SUFFTyw2Q0FBYzs7Ozs7SUFBdEIsVUFBdUIsR0FBRztRQUN4QixJQUFJLENBQUMsbUJBQW1CLENBQUMsR0FB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QUFJLENBQUMsQ0FBQyxDQUFDO2dCQUM3RixPQUFPLEVBQUUsQ0FBQztZQUNaLENBQUM7OztZQUFFO2dCQUNELE1BQU0sRUFBRSxDQUFDO1lBQ1gsQ0FBQyxFQUFDLENBQUM7UUFDTCxDQUFDLEVBQUMsQ0FBQztJQUNMLENBQUM7Ozs7O0lBRUQsMkNBQVk7Ozs7SUFBWixVQUFhLEdBQVc7UUFBeEIsaUJBYUM7UUFaQyxPQUFPLElBQUksT0FBTzs7Ozs7UUFBVSxVQUFDLE9BQU8sRUFBRSxNQUFNO1lBQzFDLEtBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztpQkFDckIsU0FBUyxFQUFFO2lCQUNYLElBQUk7Ozs7WUFBQyxVQUFBLElBQUk7Z0JBQ1IsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2hCLENBQUMsRUFBQztpQkFDRCxLQUFLOzs7O1lBQUMsVUFBQyxLQUF3QjtnQkFDOUIsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLEdBQUcsRUFBRTtvQkFDeEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUNoQjtZQUNILENBQUMsRUFBQyxDQUFDO1FBQ1AsQ0FBQyxFQUFDLENBQUM7SUFDTCxDQUFDOztnQkE1UEYsVUFBVSxTQUFDLEVBQUMsVUFBVSxFQUFFLE1BQU0sRUFBQzs7OztnREFRM0IsTUFBTSxTQUFDLHdCQUF3QjtnQkFkNUIsTUFBTTtnQkFDTixnQkFBZ0I7Z0JBQ2hCLG1CQUFtQjtnQkFKbkIsVUFBVTs7OytCQURsQjtDQXNRQyxBQTdQRCxJQTZQQztTQTVQWSxvQkFBb0I7Ozs7OztJQUMvQiw0Q0FBNEI7Ozs7O0lBQzVCLHlDQUFtQzs7Ozs7SUFDbkMsMkNBQW1DOzs7OztJQUNuQywyQ0FBcUM7Ozs7O0lBR25DLHNEQUN1RDs7Ozs7SUFDdkQsc0NBQXNCOzs7OztJQUN0QixnREFBMEM7Ozs7O0lBQzFDLG1EQUFnRDs7Ozs7SUFDaEQsMENBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtJbmplY3QsIEluamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtIdHRwQ2xpZW50LCBIdHRwRXJyb3JSZXNwb25zZX0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtJVGFtaW5BcHBsaWNhdGlvbkNvbmZpZ30gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy90YW1pbi1hcHBsaWNhdGlvbi1jb25maWcnO1xuaW1wb3J0IHtSb3V0ZXJ9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQge1RhbWluUmVzdFNlcnZpY2V9IGZyb20gJy4uL3RhbWluLXJlc3Qtc2VydmljZS90YW1pbi1yZXN0LnNlcnZpY2UnO1xuaW1wb3J0IHtUYW1pblN0b3JhZ2VTZXJ2aWNlfSBmcm9tICcuLi90YW1pbi1zdG9yYWdlL3RhbWluLXN0b3JhZ2Uuc2VydmljZSc7XG5cbmRlY2xhcmUgbGV0IHRhbWluTG9naW46IGFueTtcblxuQEluamVjdGFibGUoe3Byb3ZpZGVkSW46ICdyb290J30pXG5leHBvcnQgY2xhc3MgVGFtaW5TZWN1cml0eVNlcnZpY2Uge1xuICBwcml2YXRlIF9jdXJyZW50VXNlciA9IG51bGw7XG4gIHByaXZhdGUgdG9rZW5OYW1lID0gJ2FjY2Vzc190b2tlbic7XG4gIHByaXZhdGUgdG9rZW5FeHBpcmUgPSAnZXhwaXJlc19pbic7XG4gIHByaXZhdGUgcmVkaXJlY3RVcmwgPSAncmVkaXJlY3RfdXJsJztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KCd0YW1pbkFwcGxpY2F0aW9uQ29uZmlnJylcbiAgICBwcml2YXRlIHRhbWluQXBwbGljYXRpb25Db25maWc6IElUYW1pbkFwcGxpY2F0aW9uQ29uZmlnLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSB0YW1pblJlc3RTZXJ2aWNlOiBUYW1pblJlc3RTZXJ2aWNlLFxuICAgIHByaXZhdGUgdGFtaW5TdG9yYWdlU2VydmljZTogVGFtaW5TdG9yYWdlU2VydmljZSxcbiAgICBwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQpIHtcbiAgICAvLyBkZWJ1Z2dlcjtcbiAgfVxuXG4gIGdldCBjdXJyZW50VXNlcigpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLl9jdXJyZW50VXNlcjtcbiAgfVxuXG4gIHByaXZhdGUgYWRkUmVkaXJlY3RVcmwodXJsKSB7XG4gICAgdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLnNldCh0aGlzLnJlZGlyZWN0VXJsLCB1cmwpO1xuICB9XG5cbiAgZ2V0UmVkaXJlY3RVcmwoKSB7XG4gICAgcmV0dXJuIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5nZXQodGhpcy5yZWRpcmVjdFVybCk7XG4gIH1cblxuICByZW1vdmVSZWRpcmVjdFVybCgpIHtcbiAgICB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UucmVtb3ZlKHRoaXMucmVkaXJlY3RVcmwpO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRUb2tlbih0b2tlbjogYW55LCBleHBpcmVJbjogYW55KSB7XG4gICAgdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLnNldCh0aGlzLnRva2VuTmFtZSwgdG9rZW4pO1xuICAgIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5zZXQodGhpcy50b2tlbkV4cGlyZSwgZXhwaXJlSW4pO1xuICB9XG5cbiAgcHVibGljIGdldFRva2VuKCkge1xuICAgIHJldHVybiB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZ2V0KHRoaXMudG9rZW5OYW1lKTtcbiAgfVxuXG4gIHB1YmxpYyBoYXNUb2tlbigpIHtcbiAgICByZXR1cm4gdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLmV4aXN0cyh0aGlzLnRva2VuTmFtZSk7XG4gIH1cblxuICByZW1vdmVUb2tlbigpIHtcbiAgICB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UucmVtb3ZlKHRoaXMudG9rZW5OYW1lKTtcbiAgICB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UucmVtb3ZlKHRoaXMudG9rZW5FeHBpcmUpO1xuICB9XG5cbiAgY2hlY2tUb2tlbigpIHtcbiAgICBpZiAoIXRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5leGlzdHModGhpcy50b2tlbk5hbWUpIHx8ICF0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZXhpc3RzKHRoaXMudG9rZW5FeHBpcmUpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLmdldCh0aGlzLnRva2VuTmFtZSk7XG4gICAgY29uc3QgZXhwaXJlc0luID0gdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLmdldCh0aGlzLnRva2VuRXhwaXJlKTtcbiAgICBjb25zdCB0aGlzVGltZSA9IE51bWJlcihuZXcgRGF0ZSgpLmdldFRpbWUoKSk7XG4gICAgaWYgKE51bWJlcih0aGlzVGltZSkgPiBOdW1iZXIoZXhwaXJlc0luKSkge1xuICAgICAgdGhpcy5yZW1vdmVUb2tlbigpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGxvZ2luQ2FsbGJhY2tDaGVjaygpIHtcbiAgICAvLyBkZWJ1Z2dlcjtcbiAgICBjb25zdCB0bXAxID0gd2luZG93LmxvY2F0aW9uLmhhc2gucmVwbGFjZSgnIycsICcnKS5zcGxpdCgnJicpO1xuICAgIGNvbnN0IGhhc2hQYXJhbXMgPSB0bXAxLm1hcCh2YWx1ZSA9PiB7XG4gICAgICBjb25zdCB0ID0gdmFsdWUuc3BsaXQoJz0nKTtcbiAgICAgIGNvbnN0IG4gPSB0WzBdO1xuICAgICAgY29uc3QgdiA9IHRbMV07XG4gICAgICBjb25zdCByZXN1bHQgPSB7fTtcbiAgICAgIHJlc3VsdFtuXSA9IHY7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0pO1xuXG4gICAgY29uc3QgdG1wMiA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gucmVwbGFjZSgnPycsICcnKS5zcGxpdCgnJicpO1xuICAgIGNvbnN0IHNlYXJjaFBhcmFtcyA9IHRtcDIubWFwKHZhbHVlID0+IHtcbiAgICAgIGNvbnN0IHQgPSB2YWx1ZS5zcGxpdCgnPScpO1xuICAgICAgY29uc3QgbiA9IHRbMF07XG4gICAgICBjb25zdCB2ID0gdFsxXTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgICAgcmVzdWx0W25dID0gdjtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSk7XG5cbiAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IGhhc2hQYXJhbXMuZmluZCh2YWx1ZSA9PiB7XG4gICAgICByZXR1cm4gdmFsdWUuaGFzT3duUHJvcGVydHkoJ2FjY2Vzc190b2tlbicpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgZXhwaXJlc0luID0gaGFzaFBhcmFtcy5maW5kKHZhbHVlID0+IHtcbiAgICAgIHJldHVybiB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgnZXhwaXJlc19pbicpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgaHAgPSBzZWFyY2hQYXJhbXMuZmluZCh2YWx1ZSA9PiB7XG4gICAgICByZXR1cm4gdmFsdWUuaGFzT3duUHJvcGVydHkoJ2hwJyk7XG4gICAgfSk7XG5cbiAgICBpZiAoYWNjZXNzVG9rZW4gJiYgZXhwaXJlc0luKSB7XG4gICAgICBjb25zdCBjdXJyZW50VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgdGhpcy5hZGRUb2tlbihhY2Nlc3NUb2tlblsnYWNjZXNzX3Rva2VuJ10sIE51bWJlcihjdXJyZW50VGltZSkgKyAoTnVtYmVyKGV4cGlyZXNJblsnZXhwaXJlc19pbiddKSAqIDEwMDApKTtcbiAgICAgIHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsICcnKTtcblxuICAgICAgaWYgKGhwKSB7XG4gICAgICAgIHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsICcvIy8nICsgaHBbJ2hwJ10pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKHt9LCBkb2N1bWVudC50aXRsZSwgJy8jL21haW4nKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBnZXRVc2VyTmFtZSgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMudGFtaW5SZXN0U2VydmljZS5nZXRBbGwodGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmdldFVzZXJOYW1lVXJsKVxuICAgICAgICAudGhlbigoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZShgJHtkYXRhLmRhdGEuZmlyc3ROYW1lfSAke2RhdGEuZGF0YS5sYXN0TmFtZX1gKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKHJlYXNvbiA9PiB7XG4gICAgICAgICAgcmVqZWN0KCcnKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBnZXRDdXJyZW50VXNlcigpOiBQcm9taXNlPGFueT4ge1xuICAgIHRoaXMuX2N1cnJlbnRVc2VyID0gbnVsbDtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnRhbWluUmVzdFNlcnZpY2UuZ2V0QWxsKHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5nZXRVc2VyTmFtZVVybClcbiAgICAgICAgLnRoZW4oKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICAgIHRoaXMuX2N1cnJlbnRVc2VyID0gZGF0YS5kYXRhO1xuICAgICAgICAgIHJlc29sdmUoZGF0YS5kYXRhKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKHJlYXNvbiA9PiB7XG4gICAgICAgICAgcmVqZWN0KHJlYXNvbik7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSByZWRpcmVjdFRvTG9naW5XaXRoQ29yZG92YSgpIHtcbiAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZShbJ2xvZ2luJ10pO1xuICAgIC8vIGNvbnN0IHVybCA9IFtcbiAgICAvLyAgIHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5hdXRoZW50aWNhdGlvbkVuZHBvaW50LFxuICAgIC8vICAgJz8nLFxuICAgIC8vICAgLy8gYHJlZGlyZWN0X3VyaT0ke3dpbmRvdy5sb2NhdGlvbi5ocmVmfWAsXG4gICAgLy8gICBgcmVkaXJlY3RfdXJpPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlZGlyZWN0VXJsfWAsXG4gICAgLy8gICAnJicsXG4gICAgLy8gICBgcmVzcG9uc2VfdHlwZT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZXNwb25zZVR5cGV9YCxcbiAgICAvLyAgICcmJyxcbiAgICAvLyAgIGBjbGllbnRfaWQ9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuY2xpZW50SWR9YFxuICAgIC8vIF0uam9pbignJyk7XG4gICAgLy9cbiAgICAvLyBTYWZhcmlWaWV3Q29udHJvbGxlci5pc0F2YWlsYWJsZShmdW5jdGlvbiAoYXZhaWxhYmxlKSB7XG4gICAgLy8gICBpZiAoYXZhaWxhYmxlKSB7XG4gICAgLy8gICAgIFNhZmFyaVZpZXdDb250cm9sbGVyLnNob3coXG4gICAgLy8gICAgICAge1xuICAgIC8vICAgICAgICAgdXJsOiB1cmxcbiAgICAvLyAgICAgICB9LFxuICAgIC8vICAgICAgIGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAvLyAgICAgICB9LFxuICAgIC8vICAgICAgIGZ1bmN0aW9uIChlcnJvcikge1xuICAgIC8vICAgICAgIH1cbiAgICAvLyAgICAgKTtcbiAgICAvLyAgIH1cbiAgICAvLyB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVkaXJlY3RUb0xvZ2luV2l0aEJyb3dzZXIodXJsID0gJycpIHtcbiAgICB0aGlzLnJlbW92ZVRva2VuKCk7XG4gICAgY29uc3QgYWRyZXNzUGFydHMgPSB1cmwgPT09ICcnID8gd2luZG93LmxvY2F0aW9uLmhyZWYuc3BsaXQoJy8jLycpIDogdXJsO1xuICAgIGxldCBocCA9ICcnO1xuICAgIGxldCByZXR1cm5VcmwgPSAnJztcblxuICAgIGlmIChhZHJlc3NQYXJ0cy5sZW5ndGggPT09IDEpIHtcbiAgICAgIHJldHVyblVybCA9IGFkcmVzc1BhcnRzWzBdO1xuICAgIH0gZWxzZSB7XG4gICAgICBocCA9IGFkcmVzc1BhcnRzWzFdO1xuICAgICAgcmV0dXJuVXJsID0gYWRyZXNzUGFydHNbMF0gKyAnP2hwPScgKyBocDtcbiAgICB9XG5cbiAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9IFtcbiAgICAgIHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5hdXRoZW50aWNhdGlvbkVuZHBvaW50LFxuICAgICAgJz8nLFxuICAgICAgYHJlZGlyZWN0X3VyaT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZWRpcmVjdFVybH1gLFxuICAgICAgJyYnLFxuICAgICAgYHJlc3BvbnNlX3R5cGU9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVzcG9uc2VUeXBlfWAsXG4gICAgICAnJicsXG4gICAgICBgY2xpZW50X2lkPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmNsaWVudElkfWBcbiAgICBdLmpvaW4oJycpO1xuICB9XG5cbiAgcmVkaXJlY3RUb0xvZ2luKHVybCA9ICcnKSB7XG4gICAgaWYgKHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgnY29yZG92YScpKSB7XG4gICAgICB0aGlzLnJlZGlyZWN0VG9Mb2dpbldpdGhDb3Jkb3ZhKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh1cmwgIT09ICcnKSB7XG4gICAgICAgIHRoaXMuYWRkUmVkaXJlY3RVcmwodXJsKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucmVkaXJlY3RUb0xvZ2luV2l0aEJyb3dzZXIodXJsKTtcbiAgICB9XG4gIH1cblxuICBnZXRMb2dpblVybCgpIHtcbiAgICBjb25zdCB0bXAgPSBbXG4gICAgICB0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuYXV0aGVudGljYXRpb25FbmRwb2ludCxcbiAgICAgICc/JyxcbiAgICAgIGByZWRpcmVjdF91cmk9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVkaXJlY3RVcmx9YCxcbiAgICAgICcmJyxcbiAgICAgIGByZXNwb25zZV90eXBlPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlc3BvbnNlVHlwZX1gLFxuICAgICAgJyYnLFxuICAgICAgYGNsaWVudF9pZD0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5jbGllbnRJZH1gXG4gICAgXS5qb2luKCcnKTtcbiAgICByZXR1cm4gdG1wO1xuICB9XG5cbiAgcmVkaXJlY3RUb0xvZ291dCgpIHtcbiAgICBpZiAod2luZG93Lmhhc093blByb3BlcnR5KCdjb3Jkb3ZhJykpIHtcbiAgICAgIHRoaXMucmVtb3ZlVG9rZW4oKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgcmV0dXJuVXJsID0gdGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmJhc2VVcmw7XG4gICAgICB0aGlzLnJlbW92ZVRva2VuKCk7XG4gICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9XG4gICAgICAgIGAke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5sb2dvdXRVcmx9P3JlZGlyZWN0X3VyaT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZWRpcmVjdFVybH0mcmVzcG9uc2VfdHlwZT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZXNwb25zZVR5cGV9JmNsaWVudF9pZD0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5jbGllbnRJZH1gO1xuICAgIH1cbiAgfVxuXG4gIG1vYmlsZUxvZ2luKHVuLCBwdywgY2xpZW50SWQsIHNlY3VyaXR5KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5yZW1vdmVUb2tlbigpO1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0YW1pbkxvZ2luLmxvZ2luKHVuLCBwdywgdGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmF1dGhlbnRpY2F0aW9uRW5kcG9pbnQsIGNsaWVudElkLCBzZWN1cml0eSwgKHZhbHVlKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IEpTT04ucGFyc2UodmFsdWUpO1xuICAgICAgICBjb25zdCBjdXJyZW50VGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICB0aGlzLmFkZFRva2VuKHJlc3VsdC5hY2Nlc3NfdG9rZW4sIE51bWJlcihjdXJyZW50VGltZSkgKyAoTnVtYmVyKHJlc3VsdC5leHBpcmVzX2luKSAqIDEwMDApKTtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSwgKCkgPT4ge1xuICAgICAgICByZWplY3QoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgaGFzQWNjcmVzc1RvKHVybDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuaHR0cENsaWVudC5nZXQodXJsKVxuICAgICAgICAudG9Qcm9taXNlKClcbiAgICAgICAgLnRoZW4oZGF0YSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICBpZiAoZXJyb3Iuc3RhdHVzID09PSA0MDEpIHtcbiAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cblxuXG5cblxuLypcblxuaW1wb3J0IHtJbmplY3QsIEluamVjdGFibGV9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtIdHRwQ2xpZW50LCBIdHRwRXJyb3JSZXNwb25zZX0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtJVGFtaW5BcHBsaWNhdGlvbkNvbmZpZ30gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy90YW1pbi1hcHBsaWNhdGlvbi1jb25maWcnO1xuaW1wb3J0IHtSb3V0ZXJ9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQge1RhbWluUmVzdFNlcnZpY2V9IGZyb20gJy4uL3RhbWluLXJlc3Qtc2VydmljZS90YW1pbi1yZXN0LnNlcnZpY2UnO1xuaW1wb3J0IHtUYW1pblN0b3JhZ2VTZXJ2aWNlfSBmcm9tICcuLi90YW1pbi1zdG9yYWdlL3RhbWluLXN0b3JhZ2Uuc2VydmljZSc7XG5cbmRlY2xhcmUgbGV0IHRhbWluTG9naW46IGFueTtcblxuQEluamVjdGFibGUoe3Byb3ZpZGVkSW46ICdyb290J30pXG5leHBvcnQgY2xhc3MgVGFtaW5TZWN1cml0eVNlcnZpY2Uge1xuICBwcml2YXRlIF9jdXJyZW50VXNlciA9IG51bGw7XG4gIC8vIHByaXZhdGUgcmVmcmVzaFRva2VuID0gJ3JlZnJlc2gnO1xuICAvLyBwcml2YXRlIHJlZnJlc2hUb2tlbkV4cGlyZSA9ICdyZWZyZXNoX2V4cGlyZXNfaW4nO1xuICBwcml2YXRlIHRva2VuTmFtZSA9ICdhY2Nlc3NfdG9rZW4nO1xuICBwcml2YXRlIHRva2VuRXhwaXJlID0gJ2V4cGlyZXNfaW4nO1xuICBwcml2YXRlIHJlZGlyZWN0VXJsID0gJ3JlZGlyZWN0X3VybCc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdCgndGFtaW5BcHBsaWNhdGlvbkNvbmZpZycpXG4gICAgcHJpdmF0ZSB0YW1pbkFwcGxpY2F0aW9uQ29uZmlnOiBJVGFtaW5BcHBsaWNhdGlvbkNvbmZpZyxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgdGFtaW5SZXN0U2VydmljZTogVGFtaW5SZXN0U2VydmljZSxcbiAgICBwcml2YXRlIHRhbWluU3RvcmFnZVNlcnZpY2U6IFRhbWluU3RvcmFnZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50KSB7XG4gICAgLy8gZGVidWdnZXI7XG4gIH1cblxuICBnZXQgY3VycmVudFVzZXIoKTogYW55IHtcbiAgICByZXR1cm4gdGhpcy5fY3VycmVudFVzZXI7XG4gIH1cblxuICBwcml2YXRlIGFkZFJlZGlyZWN0VXJsKHVybCkge1xuICAgIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5zZXQodGhpcy5yZWRpcmVjdFVybCwgdXJsKTtcbiAgfVxuXG4gIGdldFJlZGlyZWN0VXJsKCkge1xuICAgIHJldHVybiB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZ2V0KHRoaXMucmVkaXJlY3RVcmwpO1xuICB9XG5cbiAgcmVtb3ZlUmVkaXJlY3RVcmwoKSB7XG4gICAgdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLnJlbW92ZSh0aGlzLnJlZGlyZWN0VXJsKTtcbiAgfVxuXG4gIGFkZFRva2VuKHRva2VuOiBhbnksIGV4cGlyZUluOiBhbnkpIHtcbiAgICB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2Uuc2V0KHRoaXMudG9rZW5OYW1lLCB0b2tlbik7XG4gICAgdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLnNldCh0aGlzLnRva2VuRXhwaXJlLCBleHBpcmVJbik7XG4gIH1cblxuLyEqXG4gIGFkZFJlZnJlc2hUb2tlbih0b2tlbjogYW55LCBleHBpcmVJbjogYW55KSB7XG4gICAgdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLnNldCh0aGlzLnJlZnJlc2hUb2tlbiwgdG9rZW4pO1xuICAgIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5zZXQodGhpcy5yZWZyZXNoVG9rZW5FeHBpcmUsIGV4cGlyZUluKTtcbiAgfVxuKiEvXG5cbi8hKlxuICByZU5ld1Rva2VuKCk6IFByb21pc2U8YW55PiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgY29uc3QgdGhlVXJsID0gYCR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlZnJlc2hUb2tlblVybH0/cmVmcmVzaF90b2tlbj0ke3RoaXMuZ2V0UmVmcmVzaFRva2VuKCl9YDtcbiAgICAgIHRoaXMuaHR0cENsaWVudFxuICAgICAgICAuZ2V0PGFueT4odGhlVXJsKVxuICAgICAgICAudG9Qcm9taXNlKClcbiAgICAgICAgLnRoZW4odmFsdWUgPT4ge1xuICAgICAgICAgIGlmICghdmFsdWUpIHtcbiAgICAgICAgICAgIGNvbnN0IGFkcmVzc1BhcnRzID0gd2luZG93LmxvY2F0aW9uLmhyZWYuc3BsaXQoJy8jLycpO1xuICAgICAgICAgICAgbGV0IHJlZGlyZWN0VXJsID0gJyc7XG5cbiAgICAgICAgICAgIGlmIChhZHJlc3NQYXJ0cy5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgICAgICAgcmVkaXJlY3RVcmwgPSBhZHJlc3NQYXJ0c1sxXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMucmVkaXJlY3RUb0xvZ2luKHJlZGlyZWN0VXJsKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5hZGRUb2tlbih2YWx1ZS5hY2Nlc3MsIHZhbHVlLmFjY2Vzc0V4cGlyZXNJbik7XG4gICAgICAgICAgLy8gdGhpcy5hZGRSZWZyZXNoVG9rZW4odmFsdWUucmVmcmVzaCwgdmFsdWUucmVmcmVzaEV4cGlyZXNJbik7XG4gICAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChyZWFzb24gPT4ge1xuICAgICAgICAgIHJlamVjdChyZWFzb24pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuKiEvXG5cbiAgcHVibGljIGdldFRva2VuKCkge1xuICAgIHJldHVybiB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZ2V0KHRoaXMudG9rZW5OYW1lKTtcbiAgfVxuXG4vISpcbiAgcHVibGljIGdldFJlZnJlc2hUb2tlbigpIHtcbiAgICByZXR1cm4gdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLmdldCh0aGlzLnJlZnJlc2hUb2tlbik7XG4gIH1cbiohL1xuXG4gIHB1YmxpYyBoYXNUb2tlbigpIHtcbiAgICByZXR1cm4gdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLmV4aXN0cyh0aGlzLnRva2VuTmFtZSk7XG4gIH1cblxuLyEqXG4gIHB1YmxpYyBoYXNSZWZyZXNoVG9rZW4oKSB7XG4gICAgcmV0dXJuIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5leGlzdHModGhpcy5yZWZyZXNoVG9rZW4pO1xuICB9XG4qIS9cblxuICByZW1vdmVUb2tlbigpIHtcbiAgICB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UucmVtb3ZlKHRoaXMudG9rZW5OYW1lKTtcbiAgICB0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UucmVtb3ZlKHRoaXMudG9rZW5FeHBpcmUpO1xuICAgIC8vIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5yZW1vdmUodGhpcy5yZWZyZXNoVG9rZW4pO1xuICAgIC8vIHRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5yZW1vdmUodGhpcy5yZWZyZXNoVG9rZW5FeHBpcmUpO1xuICB9XG5cbiAgY2hlY2tUb2tlbigpIHtcbiAgICBpZiAoIXRoaXMudGFtaW5TdG9yYWdlU2VydmljZS5leGlzdHModGhpcy50b2tlbk5hbWUpIHx8ICF0aGlzLnRhbWluU3RvcmFnZVNlcnZpY2UuZXhpc3RzKHRoaXMudG9rZW5FeHBpcmUpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IGFjY2Vzc1Rva2VuID0gdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLmdldCh0aGlzLnRva2VuTmFtZSk7XG4gICAgY29uc3QgZXhwaXJlc0luID0gdGhpcy50YW1pblN0b3JhZ2VTZXJ2aWNlLmdldCh0aGlzLnRva2VuRXhwaXJlKTtcbiAgICBjb25zdCB0aGlzVGltZSA9IE51bWJlcihuZXcgRGF0ZSgpLmdldFRpbWUoKSk7XG4gICAgaWYgKE51bWJlcih0aGlzVGltZSkgPiBOdW1iZXIoZXhwaXJlc0luKSkge1xuICAgICAgdGhpcy5yZW1vdmVUb2tlbigpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIGxvZ2luQ2FsbGJhY2tDaGVjaygpIHtcbiAgICBjb25zdCB0bXAxID0gd2luZG93LmxvY2F0aW9uLmhhc2gucmVwbGFjZSgnIycsICcnKS5zcGxpdCgnJicpO1xuICAgIGNvbnN0IGhhc2hQYXJhbXMgPSB0bXAxLm1hcCh2YWx1ZSA9PiB7XG4gICAgICBjb25zdCB0ID0gdmFsdWUuc3BsaXQoJz0nKTtcbiAgICAgIGNvbnN0IG4gPSB0WzBdO1xuICAgICAgY29uc3QgdiA9IHRbMV07XG4gICAgICBjb25zdCByZXN1bHQgPSB7fTtcbiAgICAgIHJlc3VsdFtuXSA9IHY7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0pO1xuXG4gICAgY29uc3QgdG1wMiA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2gucmVwbGFjZSgnPycsICcnKS5zcGxpdCgnJicpO1xuICAgIGNvbnN0IHNlYXJjaFBhcmFtcyA9IHRtcDIubWFwKHZhbHVlID0+IHtcbiAgICAgIGNvbnN0IHQgPSB2YWx1ZS5zcGxpdCgnPScpO1xuICAgICAgY29uc3QgbiA9IHRbMF07XG4gICAgICBjb25zdCB2ID0gdFsxXTtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgICAgcmVzdWx0W25dID0gdjtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSk7XG5cbi8hKlxuICAgIGNvbnN0IHJlZnJlc2hUb2tlbiA9IGhhc2hQYXJhbXMuZmluZCh2YWx1ZSA9PiB7XG4gICAgICByZXR1cm4gdmFsdWUuaGFzT3duUHJvcGVydHkoJ3JlZnJlc2gnKTtcbiAgICB9KTtcbiohL1xuXG4vISpcbiAgICBjb25zdCByZWZyZXNoVG9rZW5FeHBpcmVzSW4gPSBoYXNoUGFyYW1zLmZpbmQodmFsdWUgPT4ge1xuICAgICAgcmV0dXJuIHZhbHVlLmhhc093blByb3BlcnR5KCdyZWZyZXNoX2V4cGlyZXNfaW4nKTtcbiAgICB9KTtcbiohL1xuXG4gICAgY29uc3QgYWNjZXNzVG9rZW4gPSBoYXNoUGFyYW1zLmZpbmQodmFsdWUgPT4ge1xuICAgICAgcmV0dXJuIHZhbHVlLmhhc093blByb3BlcnR5KCdhY2Nlc3NfdG9rZW4nKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IGV4cGlyZXNJbiA9IGhhc2hQYXJhbXMuZmluZCh2YWx1ZSA9PiB7XG4gICAgICByZXR1cm4gdmFsdWUuaGFzT3duUHJvcGVydHkoJ2V4cGlyZXNfaW4nKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IGhwID0gc2VhcmNoUGFyYW1zLmZpbmQodmFsdWUgPT4ge1xuICAgICAgcmV0dXJuIHZhbHVlLmhhc093blByb3BlcnR5KCdocCcpO1xuICAgIH0pO1xuXG4gICAgaWYgKGFjY2Vzc1Rva2VuICYmIGV4cGlyZXNJbikge1xuICAgICAgY29uc3QgY3VycmVudFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgIHRoaXMuYWRkVG9rZW4oYWNjZXNzVG9rZW5bJ2FjY2Vzc190b2tlbiddLCBOdW1iZXIoY3VycmVudFRpbWUpICsgKE51bWJlcihleHBpcmVzSW5bJ2V4cGlyZXNfaW4nXSkgKiAxMDAwKSk7XG4gICAgICAvLyB0aGlzLmFkZFJlZnJlc2hUb2tlbihyZWZyZXNoVG9rZW5bJ3JlZnJlc2gnXSwgTnVtYmVyKGN1cnJlbnRUaW1lKSArIChOdW1iZXIocmVmcmVzaFRva2VuRXhwaXJlc0luWydyZWZyZXNoX2V4cGlyZXNfaW4nXSkgKiAxMDAwKSk7XG4gICAgICB3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCAnJyk7XG5cbiAgICAgIGlmIChocCkge1xuICAgICAgICB3aW5kb3cuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCAnLyMvJyArIGhwWydocCddKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHdpbmRvdy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsICcvIy9tYWluJyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0VXNlck5hbWUoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnRhbWluUmVzdFNlcnZpY2UuZ2V0QWxsKHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5nZXRVc2VyTmFtZVVybClcbiAgICAgICAgLnRoZW4oKGRhdGE6IGFueSkgPT4ge1xuICAgICAgICAgIHJlc29sdmUoYCR7ZGF0YS5kYXRhLmZpcnN0TmFtZX0gJHtkYXRhLmRhdGEubGFzdE5hbWV9YCk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChyZWFzb24gPT4ge1xuICAgICAgICAgIHJlamVjdCgnJyk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgZ2V0Q3VycmVudFVzZXIoKTogUHJvbWlzZTxhbnk+IHtcbiAgICB0aGlzLl9jdXJyZW50VXNlciA9IG51bGw7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy50YW1pblJlc3RTZXJ2aWNlLmdldEFsbCh0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuZ2V0VXNlck5hbWVVcmwpXG4gICAgICAgIC50aGVuKChkYXRhOiBhbnkpID0+IHtcbiAgICAgICAgICB0aGlzLl9jdXJyZW50VXNlciA9IGRhdGEuZGF0YTtcbiAgICAgICAgICByZXNvbHZlKGRhdGEuZGF0YSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaChyZWFzb24gPT4ge1xuICAgICAgICAgIHJlamVjdChyZWFzb24pO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVkaXJlY3RUb0xvZ2luV2l0aENvcmRvdmEoKSB7XG4gICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWydsb2dpbiddKTtcbiAgICAvLyBjb25zdCB1cmwgPSBbXG4gICAgLy8gICB0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuYXV0aGVudGljYXRpb25FbmRwb2ludCxcbiAgICAvLyAgICc/JyxcbiAgICAvLyAgIC8vIGByZWRpcmVjdF91cmk9JHt3aW5kb3cubG9jYXRpb24uaHJlZn1gLFxuICAgIC8vICAgYHJlZGlyZWN0X3VyaT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZWRpcmVjdFVybH1gLFxuICAgIC8vICAgJyYnLFxuICAgIC8vICAgYHJlc3BvbnNlX3R5cGU9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVzcG9uc2VUeXBlfWAsXG4gICAgLy8gICAnJicsXG4gICAgLy8gICBgY2xpZW50X2lkPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmNsaWVudElkfWBcbiAgICAvLyBdLmpvaW4oJycpO1xuICAgIC8vXG4gICAgLy8gU2FmYXJpVmlld0NvbnRyb2xsZXIuaXNBdmFpbGFibGUoZnVuY3Rpb24gKGF2YWlsYWJsZSkge1xuICAgIC8vICAgaWYgKGF2YWlsYWJsZSkge1xuICAgIC8vICAgICBTYWZhcmlWaWV3Q29udHJvbGxlci5zaG93KFxuICAgIC8vICAgICAgIHtcbiAgICAvLyAgICAgICAgIHVybDogdXJsXG4gICAgLy8gICAgICAgfSxcbiAgICAvLyAgICAgICBmdW5jdGlvbiAocmVzdWx0KSB7XG4gICAgLy8gICAgICAgfSxcbiAgICAvLyAgICAgICBmdW5jdGlvbiAoZXJyb3IpIHtcbiAgICAvLyAgICAgICB9XG4gICAgLy8gICAgICk7XG4gICAgLy8gICB9XG4gICAgLy8gfSk7XG4gIH1cblxuICBwcml2YXRlIHJlZGlyZWN0VG9Mb2dpbldpdGhCcm93c2VyKHVybCA9ICcnKSB7XG4gICAgdGhpcy5yZW1vdmVUb2tlbigpO1xuICAgIGNvbnN0IGFkcmVzc1BhcnRzID0gdXJsID09PSAnJyA/IHdpbmRvdy5sb2NhdGlvbi5ocmVmLnNwbGl0KCcvIy8nKSA6IHVybDtcbiAgICBsZXQgaHAgPSAnJztcbiAgICBsZXQgcmV0dXJuVXJsID0gJyc7XG5cbiAgICBpZiAoYWRyZXNzUGFydHMubGVuZ3RoID09PSAxKSB7XG4gICAgICByZXR1cm5VcmwgPSBhZHJlc3NQYXJ0c1swXTtcbiAgICB9IGVsc2Uge1xuICAgICAgaHAgPSBhZHJlc3NQYXJ0c1sxXTtcbiAgICAgIHJldHVyblVybCA9IGFkcmVzc1BhcnRzWzBdICsgJz9ocD0nICsgaHA7XG4gICAgfVxuXG4gICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBbXG4gICAgICB0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuYXV0aGVudGljYXRpb25FbmRwb2ludCxcbiAgICAgICc/JyxcbiAgICAgIGByZWRpcmVjdF91cmk9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVkaXJlY3RVcmx9YCxcbiAgICAgICcmJyxcbiAgICAgIGByZXNwb25zZV90eXBlPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlc3BvbnNlVHlwZX1gLFxuICAgICAgJyYnLFxuICAgICAgYGNsaWVudF9pZD0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5jbGllbnRJZH1gXG4gICAgXS5qb2luKCcnKTtcbiAgfVxuXG4gIHJlZGlyZWN0VG9Mb2dpbih1cmwgPSAnJykge1xuICAgIGlmICh3aW5kb3cuaGFzT3duUHJvcGVydHkoJ2NvcmRvdmEnKSkge1xuICAgICAgdGhpcy5yZWRpcmVjdFRvTG9naW5XaXRoQ29yZG92YSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAodXJsICE9PSAnJykge1xuICAgICAgICB0aGlzLmFkZFJlZGlyZWN0VXJsKHVybCk7XG4gICAgICB9XG4gICAgICB0aGlzLnJlZGlyZWN0VG9Mb2dpbldpdGhCcm93c2VyKHVybCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0TG9naW5VcmwoKSB7XG4gICAgY29uc3QgdG1wID0gW1xuICAgICAgdGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLmF1dGhlbnRpY2F0aW9uRW5kcG9pbnQsXG4gICAgICAnPycsXG4gICAgICBgcmVkaXJlY3RfdXJpPSR7dGhpcy50YW1pbkFwcGxpY2F0aW9uQ29uZmlnLnJlZGlyZWN0VXJsfWAsXG4gICAgICAnJicsXG4gICAgICBgcmVzcG9uc2VfdHlwZT0ke3RoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5yZXNwb25zZVR5cGV9YCxcbiAgICAgICcmJyxcbiAgICAgIGBjbGllbnRfaWQ9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuY2xpZW50SWR9YFxuICAgIF0uam9pbignJyk7XG4gICAgcmV0dXJuIHRtcDtcbiAgfVxuXG4gIHJlZGlyZWN0VG9Mb2dvdXQoKSB7XG4gICAgaWYgKHdpbmRvdy5oYXNPd25Qcm9wZXJ0eSgnY29yZG92YScpKSB7XG4gICAgICB0aGlzLnJlbW92ZVRva2VuKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJldHVyblVybCA9IHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5iYXNlVXJsO1xuICAgICAgdGhpcy5yZW1vdmVUb2tlbigpO1xuICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPVxuICAgICAgICBgJHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcubG9nb3V0VXJsfT9yZWRpcmVjdF91cmk9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVkaXJlY3RVcmx9JnJlc3BvbnNlX3R5cGU9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcucmVzcG9uc2VUeXBlfSZjbGllbnRfaWQ9JHt0aGlzLnRhbWluQXBwbGljYXRpb25Db25maWcuY2xpZW50SWR9YDtcbiAgICB9XG4gIH1cblxuICBtb2JpbGVMb2dpbih1biwgcHcsIGNsaWVudElkLCBzZWN1cml0eSk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMucmVtb3ZlVG9rZW4oKTtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGFtaW5Mb2dpbi5sb2dpbih1biwgcHcsIHRoaXMudGFtaW5BcHBsaWNhdGlvbkNvbmZpZy5hdXRoZW50aWNhdGlvbkVuZHBvaW50LCBjbGllbnRJZCwgc2VjdXJpdHksICh2YWx1ZSkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBKU09OLnBhcnNlKHZhbHVlKTtcbiAgICAgICAgY29uc3QgY3VycmVudFRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgdGhpcy5hZGRUb2tlbihyZXN1bHQuYWNjZXNzX3Rva2VuLCBOdW1iZXIoY3VycmVudFRpbWUpICsgKE51bWJlcihyZXN1bHQuZXhwaXJlc19pbikgKiAxMDAwKSk7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0sICgpID0+IHtcbiAgICAgICAgcmVqZWN0KCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIGhhc0FjY3Jlc3NUbyh1cmw6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxib29sZWFuPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLmh0dHBDbGllbnQuZ2V0KHVybClcbiAgICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAgIC50aGVuKGRhdGEgPT4ge1xuICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XG4gICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgaWYgKGVycm9yLnN0YXR1cyA9PT0gNDAxKSB7XG4gICAgICAgICAgICByZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG59XG4qL1xuIl19