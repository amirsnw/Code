/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Component, EventEmitter, forwardRef, Input, Output, ViewChild } from '@angular/core';
import { TaminDataGridComponent } from '../../tamin-data-grid/tamin-data-grid.component';
import { TaminDataGridConfiguration } from '../../../helpers/tamin.data.grid.configuration/tamin.data.grid.configuration';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { FieldBaseComponent } from '../../../base/field-base.component';
import { fromEvent, Subject } from 'rxjs';
import { debounceTime, distinctUntilChanged, switchMap } from 'rxjs/operators';
import { PickerContainerComponent } from '../../containers/picker-container/picker-container.component';
import { SearchOperator } from '../../../models/search-param.model';
export class TaminFieldAutoCompleteDataGridComponent extends FieldBaseComponent {
    constructor() {
        super(...arguments);
        this.maxSearchTermLength = 1;
        this.searchOperator = 'LIKE';
        this.searchPattern = '*{term}*';
        this.searchOperatorType = SearchOperator.EQUAL;
        this.beforeLoad = new EventEmitter();
        this.searchTerm = new Subject();
        this.filter = [];
        this.currentValue = '';
    }
    /**
     * @return {?}
     */
    initializeComponent() {
        setTimeout((/**
         * @return {?}
         */
        () => {
            this.picker.parent = this.inputElement;
            this.search(this.searchTerm).subscribe();
            this.theGrid.configuration = this.dataGridConfiguration;
            this.control = this.controlContainer.control.get(this.formControlName);
            if (this.casecadeControlName) {
                this.parent = this.controlContainer.control.get(this.casecadeControlName);
                this.subscription.add(this.parent.valueChanges.subscribe((/**
                 * @param {?} value
                 * @return {?}
                 */
                value => {
                    if (value && value !== '') {
                        this.parentValue = value;
                    }
                })));
            }
        }), 0);
    }
    /**
     * @return {?}
     */
    initValueAccessor() {
        /** @type {?} */
        const keyups = fromEvent(this.inputElement.nativeElement, 'keyup');
        this.subscription.add(keyups.subscribe((/**
         * @param {?} evt
         * @return {?}
         */
        (evt) => {
            if (evt.target.value.length >= this.maxSearchTermLength) {
                this.searchTerm.next(evt.target.value);
            }
        })));
        /** @type {?} */
        const focuses = fromEvent(this.inputElement.nativeElement, 'focus');
        this.subscription.add(focuses.subscribe((/**
         * @param {?} evt
         * @return {?}
         */
        (evt) => {
            this.onTouched();
        })));
    }
    /**
     * @return {?}
     */
    hidePopup() {
        this.picker.hide();
    }
    /**
     * @return {?}
     */
    showPopup() {
        this.picker.show();
        if (this.parentValue && this.parentValue !== '') {
            /** @type {?} */
            const tmp = this.theGrid.searchParams.find((/**
             * @param {?} c
             * @return {?}
             */
            c => c.property === this.parentValue));
            if (tmp) {
                this.theGrid.searchParams = this.theGrid.searchParams.filter((/**
                 * @param {?} obj
                 * @return {?}
                 */
                obj => obj !== tmp));
            }
            this.theGrid.searchParams.push({
                property: this.casecadeControlFieldName,
                value: this.parentValue,
                operator: this.searchOperatorType
            });
        }
        this.theGrid.refreshData();
    }
    /**
     * @param {?} terms
     * @return {?}
     */
    search(terms) {
        return terms.pipe(debounceTime(400), distinctUntilChanged(), switchMap((/**
         * @param {?} term
         * @return {?}
         */
        term => this.searchEntries(term))));
    }
    /**
     * @param {?} term
     * @return {?}
     */
    searchEntries(term) {
        this.currentValue = '';
        if (term === '') {
            this.hidePopup();
        }
        else {
            this.theGrid.searchParams = [];
            /** @type {?} */
            const searchTerm = this.searchPattern.replace('{term}', term);
            this.theGrid.searchParams = [{ property: this.displayField, value: searchTerm, operator: this.searchOperator }];
            this.theGrid.searchParams = this.theGrid.searchParams.concat(this.filter);
            if (this.parentValue && this.parentValue !== '') {
                this.theGrid.searchParams.push({
                    property: this.casecadeControlFieldName,
                    value: this.parentValue,
                    operator: this.searchOperatorType
                });
            }
            this.beforeLoad.emit();
            // this.theGrid.refreshData();
            this.showPopup();
        }
        this.onChange('');
        return term === '' ? [] : term;
    }
    /**
     * @param {?} val
     * @return {?}
     */
    onItemSelected(val) {
        if (!val) {
            this.onChange('');
            this.hidePopup();
            return;
        }
        /** @type {?} */
        const displayField = this.deepFind(val, this.displayField);
        /** @type {?} */
        const valueField = this.deepFind(val, this.valueField);
        if (!displayField || !valueField) {
            this.inputElement.nativeElement.value = '';
            this.currentValue = '';
            this.onChange('');
            return;
        }
        this.inputElement.nativeElement.value = displayField;
        this.currentValue = valueField;
        this.onChange(valueField);
        this.hidePopup();
    }
    /**
     * @return {?}
     */
    afterRefreshData() {
        this.picker.update();
    }
    /**
     * @param {?} value
     * @return {?}
     */
    writeValue(value) {
        /** @type {?} */
        const theValue = value == null ? '' : value;
        if (theValue !== '') {
            this.loadData(theValue);
        }
        else {
            this.currentValue = '';
            setTimeout((/**
             * @return {?}
             */
            () => {
                this.inputElement.nativeElement.value = '';
            }), 0);
        }
    }
    /**
     * @private
     * @param {?} theValue
     * @return {?}
     */
    loadData(theValue) {
        /** @type {?} */
        const theUrl = this.dataGridConfiguration.serviceUrl;
        /** @type {?} */
        const id = this.dataGridConfiguration.id;
        /** @type {?} */
        const searchParam = [
            {
                property: id,
                value: theValue,
                operator: this.searchOperatorType
            }
        ];
        if (this.parentValue && this.parentValue !== '') {
            searchParam.push({
                property: this.casecadeControlFieldName,
                value: this.parentValue,
                operator: this.searchOperatorType
            });
        }
        this.startWaiting();
        this.restService.getPage(theUrl, 0, 10000, searchParam)
            .then((/**
         * @param {?} value
         * @return {?}
         */
        value => {
            this.stopWaiting();
            if (value.data.list.length === 0) {
                this.onChange('');
            }
            this.onItemSelected(value.data.list[0]);
            this.theGrid.dataItems = [];
            this.theGrid.dataItems.push(value.data.list[0]);
        }))
            .catch((/**
         * @param {?} reason
         * @return {?}
         */
        reason => {
            this.stopWaiting();
            this.onChange('');
        }));
    }
    /**
     * @return {?}
     */
    pickerBeforeHide() {
        if (this.currentValue === '') {
            this.inputElement.nativeElement.value = '';
        }
    }
    /**
     * @return {?}
     */
    pickerBeforeShow() {
    }
}
TaminFieldAutoCompleteDataGridComponent.decorators = [
    { type: Component, args: [{
                selector: 'tamin-field-auto-complete-data-grid',
                template: "<input\n  type=\"text\"\n  class=\"tamin-form-control-input\"\n  [disabled]=\"control.disabled\"\n  [attr.placeholder]=\"placeHolder\"\n  [class.tamin-form-control-valid]=\"control.touched && control.valid\"\n  [class.tamin-form-control-invalid]=\"control.touched && !control.valid\"\n  #inputElement>\n<tamin-picker-container #picker (berforeHide)=\"pickerBeforeHide()\" (berforeShow)=\"pickerBeforeShow()\">\n  <tamin-data-grid #theGrid (itemSelect)=\"onItemSelected($event)\" (afterRefreshData)=\"afterRefreshData()\"\n                   [allowBreakPoints]=\"false\" [showHover]=\"true\">\n  </tamin-data-grid>\n</tamin-picker-container>\n",
                providers: [
                    {
                        provide: NG_VALUE_ACCESSOR,
                        useExisting: forwardRef((/**
                         * @return {?}
                         */
                        () => TaminFieldAutoCompleteDataGridComponent)),
                        multi: true
                    }
                ],
                styles: [""]
            }] }
];
TaminFieldAutoCompleteDataGridComponent.propDecorators = {
    dataGridConfiguration: [{ type: Input }],
    casecadeControlName: [{ type: Input }],
    casecadeControlFieldName: [{ type: Input }],
    displayField: [{ type: Input }],
    valueField: [{ type: Input }],
    maxSearchTermLength: [{ type: Input }],
    searchOperator: [{ type: Input }],
    searchPattern: [{ type: Input }],
    searchOperatorType: [{ type: Input }],
    beforeLoad: [{ type: Output }],
    theGrid: [{ type: ViewChild, args: ['theGrid',] }],
    picker: [{ type: ViewChild, args: ['picker',] }]
};
if (false) {
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.dataGridConfiguration;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.casecadeControlName;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.casecadeControlFieldName;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.displayField;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.valueField;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.maxSearchTermLength;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.searchOperator;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.searchPattern;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.searchOperatorType;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.beforeLoad;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.theGrid;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.picker;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.searchTerm;
    /** @type {?} */
    TaminFieldAutoCompleteDataGridComponent.prototype.filter;
    /**
     * @type {?}
     * @private
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.selectedValue;
    /**
     * @type {?}
     * @private
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.currentValue;
    /**
     * @type {?}
     * @private
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.parent;
    /**
     * @type {?}
     * @private
     */
    TaminFieldAutoCompleteDataGridComponent.prototype.parentValue;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFtaW4tZmllbGQtYXV0by1jb21wbGV0ZS1kYXRhLWdyaWQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vdGFtaW4tZnJhbWV3b3JrLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvZmllbGRzL3RhbWluLWZpZWxkLWF1dG8tY29tcGxldGUtZGF0YS1ncmlkL3RhbWluLWZpZWxkLWF1dG8tY29tcGxldGUtZGF0YS1ncmlkLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQzVGLE9BQU8sRUFBQyxzQkFBc0IsRUFBQyxNQUFNLGlEQUFpRCxDQUFDO0FBQ3ZGLE9BQU8sRUFBQywwQkFBMEIsRUFBQyxNQUFNLDhFQUE4RSxDQUFDO0FBQ3hILE9BQU8sRUFBa0IsaUJBQWlCLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNsRSxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSxvQ0FBb0MsQ0FBQztBQUN0RSxPQUFPLEVBQUMsU0FBUyxFQUFjLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUNwRCxPQUFPLEVBQUMsWUFBWSxFQUFFLG9CQUFvQixFQUFFLFNBQVMsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzdFLE9BQU8sRUFBQyx3QkFBd0IsRUFBQyxNQUFNLDhEQUE4RCxDQUFDO0FBQ3RHLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxvQ0FBb0MsQ0FBQztBQWVsRSxNQUFNLE9BQU8sdUNBQXdDLFNBQVEsa0JBQWtCO0lBYi9FOztRQW1CVyx3QkFBbUIsR0FBRyxDQUFDLENBQUM7UUFDeEIsbUJBQWMsR0FBRyxNQUFNLENBQUM7UUFDeEIsa0JBQWEsR0FBRyxVQUFVLENBQUM7UUFDM0IsdUJBQWtCLEdBQW1CLGNBQWMsQ0FBQyxLQUFLLENBQUM7UUFDekQs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Qzs7OztJQUVELGdCQUFnQjtJQUNoQixDQUFDOzs7WUFuTUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxxQ0FBcUM7Z0JBQy9DLDhvQkFBbUU7Z0JBRW5FLFNBQVMsRUFBRTtvQkFDVDt3QkFDRSxPQUFPLEVBQUUsaUJBQWlCO3dCQUMxQixXQUFXLEVBQUUsVUFBVTs7O3dCQUFDLEdBQUcsRUFBRSxDQUFDLHVDQUF1QyxFQUFDO3dCQUN0RSxLQUFLLEVBQUUsSUFBSTtxQkFDWjtpQkFDRjs7YUFDRjs7O29DQUdFLEtBQUs7a0NBQ0wsS0FBSzt1Q0FDTCxLQUFLOzJCQUNMLEtBQUs7eUJBQ0wsS0FBSztrQ0FDTCxLQUFLOzZCQUNMLEtBQUs7NEJBQ0wsS0FBSztpQ0FDTCxLQUFLO3lCQUNMLE1BQU07c0JBQ04sU0FBUyxTQUFDLFNBQVM7cUJBQ25CLFNBQVMsU0FBQyxRQUFROzs7O0lBWG5CLHdFQUEyRDs7SUFDM0Qsc0VBQXFDOztJQUNyQywyRUFBMEM7O0lBQzFDLCtEQUE4Qjs7SUFDOUIsNkRBQTRCOztJQUM1QixzRUFBaUM7O0lBQ2pDLGlFQUFpQzs7SUFDakMsZ0VBQW9DOztJQUNwQyxxRUFBbUU7O0lBQ25FLDZEQUEwQzs7SUFDMUMsMERBQXNEOztJQUN0RCx5REFBc0Q7O0lBQ3RELDZEQUFtQzs7SUFDbkMseURBQVk7Ozs7O0lBQ1osZ0VBQThCOzs7OztJQUM5QiwrREFBMEI7Ozs7O0lBQzFCLHlEQUFnQzs7Ozs7SUFDaEMsOERBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgZm9yd2FyZFJlZiwgSW5wdXQsIE91dHB1dCwgVmlld0NoaWxkfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7VGFtaW5EYXRhR3JpZENvbXBvbmVudH0gZnJvbSAnLi4vLi4vdGFtaW4tZGF0YS1ncmlkL3RhbWluLWRhdGEtZ3JpZC5jb21wb25lbnQnO1xuaW1wb3J0IHtUYW1pbkRhdGFHcmlkQ29uZmlndXJhdGlvbn0gZnJvbSAnLi4vLi4vLi4vaGVscGVycy90YW1pbi5kYXRhLmdyaWQuY29uZmlndXJhdGlvbi90YW1pbi5kYXRhLmdyaWQuY29uZmlndXJhdGlvbic7XG5pbXBvcnQge0Fic3RyYWN0Q29udHJvbCwgTkdfVkFMVUVfQUNDRVNTT1J9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7RmllbGRCYXNlQ29tcG9uZW50fSBmcm9tICcuLi8uLi8uLi9iYXNlL2ZpZWxkLWJhc2UuY29tcG9uZW50JztcbmltcG9ydCB7ZnJvbUV2ZW50LCBPYnNlcnZhYmxlLCBTdWJqZWN0fSBmcm9tICdyeGpzJztcbmltcG9ydCB7ZGVib3VuY2VUaW1lLCBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgc3dpdGNoTWFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge1BpY2tlckNvbnRhaW5lckNvbXBvbmVudH0gZnJvbSAnLi4vLi4vY29udGFpbmVycy9waWNrZXItY29udGFpbmVyL3BpY2tlci1jb250YWluZXIuY29tcG9uZW50JztcbmltcG9ydCB7U2VhcmNoT3BlcmF0b3J9IGZyb20gJy4uLy4uLy4uL21vZGVscy9zZWFyY2gtcGFyYW0ubW9kZWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICd0YW1pbi1maWVsZC1hdXRvLWNvbXBsZXRlLWRhdGEtZ3JpZCcsXG4gIHRlbXBsYXRlVXJsOiAnLi90YW1pbi1maWVsZC1hdXRvLWNvbXBsZXRlLWRhdGEtZ3JpZC5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL3RhbWluLWZpZWxkLWF1dG8tY29tcGxldGUtZGF0YS1ncmlkLmNvbXBvbmVudC5zY3NzJ10sXG4gIHByb3ZpZGVyczogW1xuICAgIHtcbiAgICAgIHByb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLFxuICAgICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gVGFtaW5GaWVsZEF1dG9Db21wbGV0ZURhdGFHcmlkQ29tcG9uZW50KSxcbiAgICAgIG11bHRpOiB0cnVlXG4gICAgfVxuICBdXG59KVxuXG5leHBvcnQgY2xhc3MgVGFtaW5GaWVsZEF1dG9Db21wbGV0ZURhdGFHcmlkQ29tcG9uZW50IGV4dGVuZHMgRmllbGRCYXNlQ29tcG9uZW50IHtcbiAgQElucHV0KCkgZGF0YUdyaWRDb25maWd1cmF0aW9uOiBUYW1pbkRhdGFHcmlkQ29uZmlndXJhdGlvbjtcbiAgQElucHV0KCkgY2FzZWNhZGVDb250cm9sTmFtZTogc3RyaW5nO1xuICBASW5wdXQoKSBjYXNlY2FkZUNvbnRyb2xGaWVsZE5hbWU6IHN0cmluZztcbiAgQElucHV0KCkgZGlzcGxheUZpZWxkOiBzdHJpbmc7XG4gIEBJbnB1dCgpIHZhbHVlRmllbGQ6IHN0cmluZztcbiAgQElucHV0KCkgbWF4U2VhcmNoVGVybUxlbmd0aCA9IDE7XG4gIEBJbnB1dCgpIHNlYXJjaE9wZXJhdG9yID0gJ0xJS0UnO1xuICBASW5wdXQoKSBzZWFyY2hQYXR0ZXJuID0gJyp7dGVybX0qJztcbiAgQElucHV0KCkgc2VhcmNoT3BlcmF0b3JUeXBlOiBTZWFyY2hPcGVyYXRvciA9IFNlYXJjaE9wZXJhdG9yLkVRVUFMO1xuICBAT3V0cHV0KCkgYmVmb3JlTG9hZCA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQFZpZXdDaGlsZCgndGhlR3JpZCcpIHRoZUdyaWQ6IFRhbWluRGF0YUdyaWRDb21wb25lbnQ7XG4gIEBWaWV3Q2hpbGQoJ3BpY2tlcicpIHBpY2tlcjogUGlja2VyQ29udGFpbmVyQ29tcG9uZW50O1xuICBzZWFyY2hUZXJtID0gbmV3IFN1YmplY3Q8c3RyaW5nPigpO1xuICBmaWx0ZXIgPSBbXTtcbiAgcHJpdmF0ZSBzZWxlY3RlZFZhbHVlOiBzdHJpbmc7XG4gIHByaXZhdGUgY3VycmVudFZhbHVlID0gJyc7XG4gIHByaXZhdGUgcGFyZW50OiBBYnN0cmFjdENvbnRyb2w7XG4gIHByaXZhdGUgcGFyZW50VmFsdWU6IHN0cmluZztcblxuICBpbml0aWFsaXplQ29tcG9uZW50KCkge1xuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5waWNrZXIucGFyZW50ID0gdGhpcy5pbnB1dEVsZW1lbnQ7XG4gICAgICB0aGlzLnNlYXJjaCh0aGlzLnNlYXJjaFRlcm0pLnN1YnNjcmliZSgpO1xuICAgICAgdGhpcy50aGVHcmlkLmNvbmZpZ3VyYXRpb24gPSB0aGlzLmRhdGFHcmlkQ29uZmlndXJhdGlvbjtcbiAgICAgIHRoaXMuY29udHJvbCA9IHRoaXMuY29udHJvbENvbnRhaW5lci5jb250cm9sLmdldCh0aGlzLmZvcm1Db250cm9sTmFtZSk7XG4gICAgICBpZiAodGhpcy5jYXNlY2FkZUNvbnRyb2xOYW1lKSB7XG4gICAgICAgIHRoaXMucGFyZW50ID0gdGhpcy5jb250cm9sQ29udGFpbmVyLmNvbnRyb2wuZ2V0KHRoaXMuY2FzZWNhZGVDb250cm9sTmFtZSk7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZCh0aGlzLnBhcmVudC52YWx1ZUNoYW5nZXMuc3Vic2NyaWJlKHZhbHVlID0+IHtcbiAgICAgICAgICBpZiAodmFsdWUgJiYgdmFsdWUgIT09ICcnKSB7XG4gICAgICAgICAgICB0aGlzLnBhcmVudFZhbHVlID0gdmFsdWU7XG4gICAgICAgICAgfVxuICAgICAgICB9KSk7XG4gICAgICB9XG4gICAgfSwgMCk7XG4gIH1cblxuICBpbml0VmFsdWVBY2Nlc3NvcigpIHtcbiAgICBjb25zdCBrZXl1cHMgPSBmcm9tRXZlbnQodGhpcy5pbnB1dEVsZW1lbnQubmF0aXZlRWxlbWVudCwgJ2tleXVwJyk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKGtleXVwcy5zdWJzY3JpYmUoKGV2dDogYW55KSA9PiB7XG4gICAgICBpZiAoZXZ0LnRhcmdldC52YWx1ZS5sZW5ndGggPj0gdGhpcy5tYXhTZWFyY2hUZXJtTGVuZ3RoKSB7XG4gICAgICAgIHRoaXMuc2VhcmNoVGVybS5uZXh0KGV2dC50YXJnZXQudmFsdWUpO1xuICAgICAgfVxuICAgIH0pKTtcblxuICAgIGNvbnN0IGZvY3VzZXMgPSBmcm9tRXZlbnQodGhpcy5pbnB1dEVsZW1lbnQubmF0aXZlRWxlbWVudCwgJ2ZvY3VzJyk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKGZvY3VzZXMuc3Vic2NyaWJlKChldnQ6IGFueSkgPT4ge1xuICAgICAgICB0aGlzLm9uVG91Y2hlZCgpO1xuICAgICAgfVxuICAgICkpO1xuICB9XG5cbiAgaGlkZVBvcHVwKCkge1xuICAgIHRoaXMucGlja2VyLmhpZGUoKTtcbiAgfVxuXG4gIHNob3dQb3B1cCgpIHtcbiAgICB0aGlzLnBpY2tlci5zaG93KCk7XG4gICAgaWYgKHRoaXMucGFyZW50VmFsdWUgJiYgdGhpcy5wYXJlbnRWYWx1ZSAhPT0gJycpIHtcbiAgICAgIGNvbnN0IHRtcCA9IHRoaXMudGhlR3JpZC5zZWFyY2hQYXJhbXMuZmluZChjID0+IGMucHJvcGVydHkgPT09IHRoaXMucGFyZW50VmFsdWUpO1xuICAgICAgaWYgKHRtcCkge1xuICAgICAgICB0aGlzLnRoZUdyaWQuc2VhcmNoUGFyYW1zID0gdGhpcy50aGVHcmlkLnNlYXJjaFBhcmFtcy5maWx0ZXIob2JqID0+IG9iaiAhPT0gdG1wKTtcbiAgICAgIH1cbiAgICAgIHRoaXMudGhlR3JpZC5zZWFyY2hQYXJhbXMucHVzaCh7XG4gICAgICAgIHByb3BlcnR5OiB0aGlzLmNhc2VjYWRlQ29udHJvbEZpZWxkTmFtZSxcbiAgICAgICAgdmFsdWU6IHRoaXMucGFyZW50VmFsdWUsXG4gICAgICAgIG9wZXJhdG9yOiB0aGlzLnNlYXJjaE9wZXJhdG9yVHlwZVxuICAgICAgfSk7XG4gICAgfVxuICAgIHRoaXMudGhlR3JpZC5yZWZyZXNoRGF0YSgpO1xuICB9XG5cbiAgc2VhcmNoKHRlcm1zOiBPYnNlcnZhYmxlPHN0cmluZz4pIHtcbiAgICByZXR1cm4gdGVybXMucGlwZShcbiAgICAgIGRlYm91bmNlVGltZSg0MDApLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgIHN3aXRjaE1hcCh0ZXJtID0+IHRoaXMuc2VhcmNoRW50cmllcyh0ZXJtKSkpO1xuICB9XG5cbiAgc2VhcmNoRW50cmllcyh0ZXJtOiBzdHJpbmcpIHtcbiAgICB0aGlzLmN1cnJlbnRWYWx1ZSA9ICcnO1xuICAgIGlmICh0ZXJtID09PSAnJykge1xuICAgICAgdGhpcy5oaWRlUG9wdXAoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy50aGVHcmlkLnNlYXJjaFBhcmFtcyA9IFtdO1xuICAgICAgY29uc3Qgc2VhcmNoVGVybSA9IHRoaXMuc2VhcmNoUGF0dGVybi5yZXBsYWNlKCd7dGVybX0nLCB0ZXJtKTtcbiAgICAgIHRoaXMudGhlR3JpZC5zZWFyY2hQYXJhbXMgPSBbe3Byb3BlcnR5OiB0aGlzLmRpc3BsYXlGaWVsZCwgdmFsdWU6IHNlYXJjaFRlcm0sIG9wZXJhdG9yOiB0aGlzLnNlYXJjaE9wZXJhdG9yfV07XG4gICAgICB0aGlzLnRoZUdyaWQuc2VhcmNoUGFyYW1zID0gdGhpcy50aGVHcmlkLnNlYXJjaFBhcmFtcy5jb25jYXQodGhpcy5maWx0ZXIpO1xuICAgICAgaWYgKHRoaXMucGFyZW50VmFsdWUgJiYgdGhpcy5wYXJlbnRWYWx1ZSAhPT0gJycpIHtcbiAgICAgICAgdGhpcy50aGVHcmlkLnNlYXJjaFBhcmFtcy5wdXNoKHtcbiAgICAgICAgICBwcm9wZXJ0eTogdGhpcy5jYXNlY2FkZUNvbnRyb2xGaWVsZE5hbWUsXG4gICAgICAgICAgdmFsdWU6IHRoaXMucGFyZW50VmFsdWUsXG4gICAgICAgICAgb3BlcmF0b3I6IHRoaXMuc2VhcmNoT3BlcmF0b3JUeXBlXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgdGhpcy5iZWZvcmVMb2FkLmVtaXQoKTtcbiAgICAgIC8vIHRoaXMudGhlR3JpZC5yZWZyZXNoRGF0YSgpO1xuICAgICAgdGhpcy5zaG93UG9wdXAoKTtcbiAgICB9XG4gICAgdGhpcy5vbkNoYW5nZSgnJyk7XG4gICAgcmV0dXJuIHRlcm0gPT09ICcnID8gW10gOiB0ZXJtO1xuICB9XG5cbiAgb25JdGVtU2VsZWN0ZWQodmFsOiBhbnkpIHtcbiAgICBpZiAoIXZhbCkge1xuICAgICAgdGhpcy5vbkNoYW5nZSgnJyk7XG4gICAgICB0aGlzLmhpZGVQb3B1cCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBkaXNwbGF5RmllbGQgPSB0aGlzLmRlZXBGaW5kKHZhbCwgdGhpcy5kaXNwbGF5RmllbGQpO1xuICAgIGNvbnN0IHZhbHVlRmllbGQgPSB0aGlzLmRlZXBGaW5kKHZhbCwgdGhpcy52YWx1ZUZpZWxkKTtcbiAgICBpZiAoIWRpc3BsYXlGaWVsZCB8fCAhdmFsdWVGaWVsZCkge1xuICAgICAgdGhpcy5pbnB1dEVsZW1lbnQubmF0aXZlRWxlbWVudC52YWx1ZSA9ICcnO1xuICAgICAgdGhpcy5jdXJyZW50VmFsdWUgPSAnJztcbiAgICAgIHRoaXMub25DaGFuZ2UoJycpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmlucHV0RWxlbWVudC5uYXRpdmVFbGVtZW50LnZhbHVlID0gZGlzcGxheUZpZWxkO1xuICAgIHRoaXMuY3VycmVudFZhbHVlID0gdmFsdWVGaWVsZDtcbiAgICB0aGlzLm9uQ2hhbmdlKHZhbHVlRmllbGQpO1xuICAgIHRoaXMuaGlkZVBvcHVwKCk7XG4gIH1cblxuICBhZnRlclJlZnJlc2hEYXRhKCkge1xuICAgIHRoaXMucGlja2VyLnVwZGF0ZSgpO1xuICB9XG5cbiAgd3JpdGVWYWx1ZSh2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgY29uc3QgdGhlVmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gJycgOiB2YWx1ZTtcbiAgICBpZiAodGhlVmFsdWUgIT09ICcnKSB7XG4gICAgICB0aGlzLmxvYWREYXRhKHRoZVZhbHVlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jdXJyZW50VmFsdWUgPSAnJztcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLmlucHV0RWxlbWVudC5uYXRpdmVFbGVtZW50LnZhbHVlID0gJyc7XG4gICAgICB9LCAwKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGxvYWREYXRhKHRoZVZhbHVlKSB7XG4gICAgY29uc3QgdGhlVXJsID0gdGhpcy5kYXRhR3JpZENvbmZpZ3VyYXRpb24uc2VydmljZVVybDtcbiAgICBjb25zdCBpZCA9IHRoaXMuZGF0YUdyaWRDb25maWd1cmF0aW9uLmlkO1xuICAgIGNvbnN0IHNlYXJjaFBhcmFtID0gW1xuICAgICAge1xuICAgICAgICBwcm9wZXJ0eTogaWQsXG4gICAgICAgIHZhbHVlOiB0aGVWYWx1ZSxcbiAgICAgICAgb3BlcmF0b3I6IHRoaXMuc2VhcmNoT3BlcmF0b3JUeXBlXG4gICAgICB9XG4gICAgXTtcblxuICAgIGlmICh0aGlzLnBhcmVudFZhbHVlICYmIHRoaXMucGFyZW50VmFsdWUgIT09ICcnKSB7XG4gICAgICBzZWFyY2hQYXJhbS5wdXNoKHtcbiAgICAgICAgcHJvcGVydHk6IHRoaXMuY2FzZWNhZGVDb250cm9sRmllbGROYW1lLFxuICAgICAgICB2YWx1ZTogdGhpcy5wYXJlbnRWYWx1ZSxcbiAgICAgICAgb3BlcmF0b3I6IHRoaXMuc2VhcmNoT3BlcmF0b3JUeXBlXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLnN0YXJ0V2FpdGluZygpO1xuICAgIHRoaXMucmVzdFNlcnZpY2UuZ2V0UGFnZSh0aGVVcmwsIDAsIDEwMDAwLCBzZWFyY2hQYXJhbSlcbiAgICAgIC50aGVuKHZhbHVlID0+IHtcbiAgICAgICAgdGhpcy5zdG9wV2FpdGluZygpO1xuICAgICAgICBpZiAodmFsdWUuZGF0YS5saXN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHRoaXMub25DaGFuZ2UoJycpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMub25JdGVtU2VsZWN0ZWQodmFsdWUuZGF0YS5saXN0WzBdKTtcbiAgICAgICAgdGhpcy50aGVHcmlkLmRhdGFJdGVtcyA9IFtdO1xuICAgICAgICB0aGlzLnRoZUdyaWQuZGF0YUl0ZW1zLnB1c2godmFsdWUuZGF0YS5saXN0WzBdKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2gocmVhc29uID0+IHtcbiAgICAgICAgdGhpcy5zdG9wV2FpdGluZygpO1xuICAgICAgICB0aGlzLm9uQ2hhbmdlKCcnKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcGlja2VyQmVmb3JlSGlkZSgpIHtcbiAgICBpZiAodGhpcy5jdXJyZW50VmFsdWUgPT09ICcnKSB7XG4gICAgICB0aGlzLmlucHV0RWxlbWVudC5uYXRpdmVFbGVtZW50LnZhbHVlID0gJyc7XG4gICAgfVxuICB9XG5cbiAgcGlja2VyQmVmb3JlU2hvdygpIHtcbiAgfVxufVxuIl19